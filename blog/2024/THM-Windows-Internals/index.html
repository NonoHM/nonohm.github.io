<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> THM Windows Internals | NonoHM </title> <meta name="author" content="NonoHM "> <meta name="description" content="Welcome to my personnal website. I am currently a 2nd year student in the " but r et t program. i like doing sports and music besides learning new things in it.> <meta name="keywords" content="jekyll, jekyll-theme, portfolio-website, writeups, projects"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link defer href="/assets/css/bootstrap-toc.min.css?6f5af0bb9aab25d79b2448143cbeaa88" rel="stylesheet"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://nonohm.github.io/blog/2024/THM-Windows-Internals/"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js?0afe9f0ae161375728f7bcc5eb5b4ab4"></script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> NonoHM </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item "> <a class="nav-link" href="/blog/">blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">projects </a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">repositories </a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fa-solid fa-moon"></i> <i class="fa-solid fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="row"> <div class="col-sm-3"> <nav id="toc-sidebar" class="sticky-top"></nav> </div> <div class="col-sm-9"> <div class="post"> <header class="post-header"> <h1 class="post-title">THM Windows Internals</h1> <p class="post-meta"> April 21, 2024 • NonoHM </p> <p class="post-tags"> <a href="/blog/2024"> <i class="fa-solid fa-calendar fa-sm"></i> 2024 </a>   ·   <a href="/blog/tag/thm"> <i class="fa-solid fa-hashtag fa-sm"></i> THM</a>   <a href="/blog/tag/malware-analysis"> <i class="fa-solid fa-hashtag fa-sm"></i> Malware Analysis</a>   <a href="/blog/tag/operating-system"> <i class="fa-solid fa-hashtag fa-sm"></i> Operating System</a>   <a href="/blog/tag/windows"> <i class="fa-solid fa-hashtag fa-sm"></i> Windows</a>   </p> </header> <article class="post-content"> <div id="markdown-content"> <h2 id="task-1---introduction">Task 1 - Introduction</h2> <p>In this room, we will be observing the Windows operating system common internal components. Because Windows machines are making up a majority of corporate infrastructure, it is crucial to understand how it works to aid in evasion and exploitation.</p> <h3 id="learning-objectives">Learning Objectives</h3> <ul> <li>Understand and intreact with Windows processes and their underlying technologies.</li> <li>Learn about core file formats and how they are used.</li> <li>Interact with Windows internals and understand how the Windows kernel operates.</li> </ul> <h2 id="task-2---processes">Task 2 - Processes</h2> <p>A process is a representation of the execution of a program and an application can contain one or more processes. It has many components that get broken down in order to be stored and interacted with.</p> <p>A process contains:</p> <table> <thead> <tr> <th style="text-align: center">Process Component</th> <th style="text-align: center">Purpose</th> </tr> </thead> <tbody> <tr> <td style="text-align: center">Private Virtual Address Space</td> <td style="text-align: center">Virtual memory addresses that the process is allocated.</td> </tr> <tr> <td style="text-align: center">Executable Program</td> <td style="text-align: center">Defines code and data stored in the virtual address space.</td> </tr> <tr> <td style="text-align: center">Open Handles</td> <td style="text-align: center">Defines handles to system resources accessible to the process.</td> </tr> <tr> <td style="text-align: center">Security Context</td> <td style="text-align: center">The access token defines the user, security groups, privileges, and other security information.</td> </tr> <tr> <td style="text-align: center">Process ID</td> <td style="text-align: center">Unique numerical identifier of the process.</td> </tr> <tr> <td style="text-align: center">Threads</td> <td style="text-align: center">Section of a process scheduled for execution.</td> </tr> </tbody> </table> <p>Because they are created during the execution of an applicaction, processes are core of Windows functions like Windows Defender (MsMpEng).</p> <p>Attackers can target processes to evade detection and hide malware and legitimate processes with <a href="https://attack.mitre.org/techniques/T1055/" rel="external nofollow noopener" target="_blank">Process Injection</a>, <a href="https://attack.mitre.org/techniques/T1055/012/" rel="external nofollow noopener" target="_blank">Process Hollowing</a>, <a href="https://attack.mitre.org/techniques/T1055/013/" rel="external nofollow noopener" target="_blank">Process Masquerading</a> and so on…</p> <p>Here is what components resides in a Private Virtual Address Space:</p> <table> <thead> <tr> <th style="text-align: center">Component</th> <th style="text-align: center">Purpose</th> </tr> </thead> <tbody> <tr> <td style="text-align: center">Code</td> <td style="text-align: center">Code to be executed by the process.</td> </tr> <tr> <td style="text-align: center">Global Variables</td> <td style="text-align: center">Stored variables.</td> </tr> <tr> <td style="text-align: center">Process Heap</td> <td style="text-align: center">Defines the heap where data is stored.</td> </tr> <tr> <td style="text-align: center">Process Resources</td> <td style="text-align: center">Defines further resources of the process.</td> </tr> <tr> <td style="text-align: center">Environment Block</td> <td style="text-align: center">Data structure to define process information.</td> </tr> <tr> <td style="text-align: center">Threads Memory</td> <td style="text-align: center">Section of a process scheduled for execution.</td> </tr> </tbody> </table> <p>There are tools which allow us to visualize processes like Task Manager or Process Explorer/Procmon from <a href="https://learn.microsoft.com/en-us/sysinternals/downloads/" rel="external nofollow noopener" target="_blank">Sysinternals</a>.</p> <p>Most of time, end-users deal with Name, PID, Status and User parameters.</p> <h3 id="questions">Questions</h3> <p><strong>What is the process ID of “notepad.exe”?</strong></p> <p><em>Answer: <code class="language-plaintext highlighter-rouge">5984</code></em></p> <p><strong>What is the parent process ID of the previous process?</strong></p> <p><em>Answer: <code class="language-plaintext highlighter-rouge">3412</code></em></p> <p><strong>What is the integrity level of the process?</strong></p> <p><em>Answer: <code class="language-plaintext highlighter-rouge">High</code></em></p> <h2 id="task-3---threads">Task 3 - Threads</h2> <p>A thread is an executable unit utilized within a process and scheduled based on system-specific factors, including CPU and memory attributes, priority levels, and logical considerations.<br> Essentially, a thread can be defined as controlling the execution of a process.</p> <p>Threads are commonly abused to aid in code execution by controling thread execution.</p> <p>Threads share the same details and resources as their parent process, such as code, global variables, etc. Threads also have their unique values and data, outlined in the table below.</p> <table> <thead> <tr> <th style="text-align: center">Component</th> <th style="text-align: center">Purpose</th> </tr> </thead> <tbody> <tr> <td style="text-align: center">Stack</td> <td style="text-align: center">All data relevant and specific to the thread (exceptions, procedure calls, etc.)</td> </tr> <tr> <td style="text-align: center">Thread Local Storage</td> <td style="text-align: center">Pointers for allocating storage to a unique data environment</td> </tr> <tr> <td style="text-align: center">Stack Argument</td> <td style="text-align: center">Unique value assigned to each thread</td> </tr> <tr> <td style="text-align: center">Context Structure</td> <td style="text-align: center">Holds machine register values maintained by the kernel</td> </tr> </tbody> </table> <h3 id="questions-1">Questions</h3> <p><strong>What is the thread ID of the first thread created by notepad.exe?</strong></p> <p><em>Answer: <code class="language-plaintext highlighter-rouge">5908</code></em></p> <p><strong>What is the stack argument of the previous thread?</strong></p> <p><em>Answer: <code class="language-plaintext highlighter-rouge">6584</code></em></p> <h2 id="task-4---virtual-memory">Task 4 - Virtual Memory</h2> <p>Virtual Memory is crucial component of how processes work and interact with each other. It allows components to interact as if it was physical memory without the risk of collision between applications.</p> <p>Virtual Memory provides a priate virtual address space to each process. A memory manager is used to translate virtual addresses to physical addresses.</p> <p>Memory manager divides the virtual memory space into fixed-size block called pages. Because the RAM is not infinite, Memory manager transfers pages that are not used by the application to the disk and retrives them when needed.</p> <p>On 32-bit system, the maximum VA space is 4 GB and is 256 TB on 64-bit systems. The lower half is allocated to applications and the upper half of memory is allocated for OS memory utilization.</p> <h3 id="questions-2">Questions</h3> <p><strong>What is the total theoretical maximum virtual address space of a 32-bit x86 system?</strong></p> <p><em>Answer: <code class="language-plaintext highlighter-rouge">4 gb</code></em></p> <p><strong>What default setting flag can be used to reallocate user process address space?</strong></p> <p><em>Answer: <code class="language-plaintext highlighter-rouge">increaseUserVA</code></em></p> <p><strong>What is the base address of “notepad.exe”?</strong></p> <p><em>Answer: <code class="language-plaintext highlighter-rouge">0x7ff652ec0000</code></em></p> <h2 id="task-5---dynamic-link-libraries">Task 5 - Dynamic Link Libraries</h2> <p>DLLs are libraries that contain code and data that can be used by more than one program at a time. They help:</p> <ul> <li>Promote modularization of code</li> <li>Code reuse</li> <li>More efficient memory usage</li> <li>Reduce disk usage</li> </ul> <p>DLL are assigned as dependencies when loaded in a program. Since programs can be dependent on DLLs, they can be targeted rather than the program itself to control some aspects of the functionality using <a href="https://attack.mitre.org/techniques/T1574/001/" rel="external nofollow noopener" target="_blank">DLL Hijacking</a>, <a href="https://attack.mitre.org/techniques/T1574/002/" rel="external nofollow noopener" target="_blank">DLL Side-loading</a> and <a href="https://attack.mitre.org/techniques/T1055/001/" rel="external nofollow noopener" target="_blank">DLL injection</a>.</p> <p>DLLs are created slightly different than normal programs:</p> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">"stdafx.h"</span><span class="cp">
#define EXPORTING_DLL
#include</span> <span class="cpf">"sampleDLL.h"</span><span class="cp">
</span><span class="n">BOOL</span> <span class="n">APIENTRY</span> <span class="nf">DllMain</span><span class="p">(</span> <span class="n">HANDLE</span> <span class="n">hModule</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">ul_reason_for_call</span><span class="p">,</span> <span class="n">LPVOID</span> <span class="n">lpReserved</span>
<span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">HelloWorld</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">MessageBox</span><span class="p">(</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">TEXT</span><span class="p">(</span><span class="s">"Hello World"</span><span class="p">),</span> <span class="n">TEXT</span><span class="p">(</span><span class="s">"In a DLL"</span><span class="p">),</span> <span class="n">MB_OK</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div> <p>The header file <code class="language-plaintext highlighter-rouge">sampleDLL.h</code> defines what functions are imported and exported:</p> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#ifndef INDLL_H
</span>    <span class="cp">#define INDLL_H
</span>    <span class="cp">#ifdef EXPORTING_DLL
</span>        <span class="k">extern</span> <span class="nf">__declspec</span><span class="p">(</span><span class="n">dllexport</span><span class="p">)</span> <span class="kt">void</span> <span class="n">HelloWorld</span><span class="p">();</span>
    <span class="cp">#else
</span>        <span class="k">extern</span> <span class="nf">__declspec</span><span class="p">(</span><span class="n">dllimport</span><span class="p">)</span> <span class="kt">void</span> <span class="n">HelloWorld</span><span class="p">();</span>
    <span class="cp">#endif
#endif
</span></code></pre></div></div> <p>When loaded using <em>load-time dynamic linking</em>, explicit calls to the DLL functions are made from the application. This type of linking can be achieved only by providing a header (.h) and import library (.lib) file.</p> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">"stdafx.h"</span><span class="cp">
#include</span> <span class="cpf">"sampleDLL.h"</span><span class="cp">
</span><span class="kt">int</span> <span class="n">APIENTRY</span> <span class="nf">WinMain</span><span class="p">(</span><span class="n">HINSTANCE</span> <span class="n">hInstance</span><span class="p">,</span> <span class="n">HINSTANCE</span> <span class="n">hPrevInstance</span><span class="p">,</span> <span class="n">LPSTR</span> <span class="n">lpCmdLine</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nCmdShow</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">HelloWorld</span><span class="p">();</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div> <p>When loaded using <em>run-time dynamic linking</em>, a separate function (<code class="language-plaintext highlighter-rouge">LoadLibrary</code> or <code class="language-plaintext highlighter-rouge">LoadLibraryEx</code>) is used to load the DLL at run time. Once loaded, <code class="language-plaintext highlighter-rouge">GetProcAddress</code> is needed to identify the exported DLL function to call.</p> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">typedef</span> <span class="nf">VOID</span> <span class="p">(</span><span class="o">*</span><span class="n">DLLPROC</span><span class="p">)</span> <span class="p">(</span><span class="n">LPTSTR</span><span class="p">);</span>
<span class="p">...</span>
<span class="n">HINSTANCE</span> <span class="n">hinstDLL</span><span class="p">;</span>
<span class="n">DLLPROC</span> <span class="n">HelloWorld</span><span class="p">;</span>
<span class="n">BOOL</span> <span class="n">fFreeDLL</span><span class="p">;</span>

<span class="n">hinstDLL</span> <span class="o">=</span> <span class="n">LoadLibrary</span><span class="p">(</span><span class="s">"sampleDLL.dll"</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">hinstDLL</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">HelloWorld</span> <span class="o">=</span> <span class="p">(</span><span class="n">DLLPROC</span><span class="p">)</span> <span class="n">GetProcAddress</span><span class="p">(</span><span class="n">hinstDLL</span><span class="p">,</span> <span class="s">"HelloWorld"</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">HelloWorld</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
        <span class="p">(</span><span class="n">HelloWorld</span><span class="p">);</span>
    <span class="n">fFreeDLL</span> <span class="o">=</span> <span class="n">FreeLibrary</span><span class="p">(</span><span class="n">hinstDLL</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div> <h3 id="questions-3">Questions</h3> <p><strong>What is the base address of “ntdll.dll” loaded from “notepad.exe”?</strong></p> <p><em>Answer: <code class="language-plaintext highlighter-rouge">0x7ffd0be200000</code></em></p> <p><strong>What is the size of “ntdll.dll” loaded from “notepad.exe”?</strong></p> <p><em>Answer: <code class="language-plaintext highlighter-rouge">0x1ec000</code></em></p> <p><strong>How many DLLs were loaded by “notepad.exe”?</strong></p> <p><em>Answer: <code class="language-plaintext highlighter-rouge">51</code></em></p> <h2 id="task-6---portable-executable-format">Task 6 - Portable Executable Format</h2> <p>The PE format defines the structure of the information about the executable and stored data.</p> <p>The PE format is a comprehensive structure of executable and object files. The PE (Portable Executable) and COFF (Common Object File Format) files makes up the PE format.</p> <p>PE Data is most commonly seen in a hex dump of an executable file. The PE data is broken up into seven components:</p> <ul> <li> <strong>DOS header</strong>: The <code class="language-plaintext highlighter-rouge">MZ</code> DOS header defines the file format as <code class="language-plaintext highlighter-rouge">.exe</code> </li> <li> <strong>DOS Stub</strong>: A program run by default that prints a compatibility message like <code class="language-plaintext highlighter-rouge">This program cannot be run in DOS mode</code> </li> <li> <strong>PE File Header</strong>: Provides PE header information of the binary by defining file format, signature, image file header…</li> <li> <strong>Image Optional Header</strong>: Provides configuration settings and metadata for a Windows executable’s runtime environment, including memory allocation, entry point, subsystem type, section alignment, import/export data directories, version information, security checks, and loader configuration.</li> <li> <strong>Data Dictionnaries</strong>: Points to the image data directory structure and are a part of <em>Image optional Header</em> </li> <li> <strong>Section Table</strong>: Define the available sections and information in the image such as code, imports and data</li> </ul> <p>Here is a table containing the purpose of the different sections:</p> <table> <thead> <tr> <th style="text-align: center">Section</th> <th style="text-align: center">Purpose</th> </tr> </thead> <tbody> <tr> <td style="text-align: center">.text</td> <td style="text-align: center">Contains executable code and entry point</td> </tr> <tr> <td style="text-align: center">.data</td> <td style="text-align: center">Contains initialized data (strings, variables, etc.)</td> </tr> <tr> <td style="text-align: center">.rdata or .idata</td> <td style="text-align: center">Contains imports (Windows API) and DLLs.</td> </tr> <tr> <td style="text-align: center">.reloc</td> <td style="text-align: center">Contains relocation information</td> </tr> <tr> <td style="text-align: center">.rsrc</td> <td style="text-align: center">Contains application resources (images, etc.)</td> </tr> <tr> <td style="text-align: center">.debug</td> <td style="text-align: center">Contains debug information</td> </tr> </tbody> </table> <h3 id="questions-4">Questions</h3> <p><strong>What PE component prints the message “This program cannot be run in DOS mode”?</strong></p> <p><em>Answer: <code class="language-plaintext highlighter-rouge">DOS Stub</code></em></p> <p><strong>What is the entry point reported by DiE?</strong></p> <p><em>Answer: <code class="language-plaintext highlighter-rouge">000000014001acd0</code></em></p> <p><strong>What is the value of “NumberOfSections”?</strong></p> <p><em>Answer: <code class="language-plaintext highlighter-rouge">0006</code></em></p> <p><strong>What is the virtual address of “.data”?</strong></p> <p><em>Answer: <code class="language-plaintext highlighter-rouge">00024000</code></em></p> <p><strong>What string is located at the offset “0001f99c”?</strong></p> <p><em>Answer: <code class="language-plaintext highlighter-rouge">Microsoft.Notepad</code></em></p> <h2 id="task-7---interacting-with-windows-internals">Task 7 - Interacting with Windows Internals</h2> <p>Interacting with Windows internals is simpler using the Windows API because it provides native functionality to interact with the OS. The API contains the Win32 API and the Win 64 API.</p> <p>Most Windows internals components interacting with physical hardware and memory.</p> <p>The windows kernel controls all programs and processes and bridges software and hardware interactions. Because an application cannot normally interact with the kernel or modify physical hardware, the use of processor modes and access levels are required.</p> <p>A Windows processor has a <em>user</em> and <em>kernel</em> mode and it switched between these depending the requested mode.</p> <p>The switch between these is facilitated by system and API calls and is referred to as the <em>Switching Point</em>.</p> <table> <thead> <tr> <th style="text-align: center">User mode</th> <th style="text-align: center">Kernel Mode</th> </tr> </thead> <tbody> <tr> <td style="text-align: center">No direct hardware access</td> <td style="text-align: center">Direct hardware access</td> </tr> <tr> <td style="text-align: center">Creates a process in a private virtual address space</td> <td style="text-align: center">Ran in a single shared virtual address space</td> </tr> <tr> <td style="text-align: center">Access to “owned memory locations”</td> <td style="text-align: center">Access to entire physical memory</td> </tr> </tbody> </table> <p>This is a flow chart on how a program interact most of the time with hardware.</p> <figure> <picture> <img src="/assets/img/images/thm_windows_internals/S12Sp3zZC.png" class="img-fluid rounded z-depth-1 bg-white" width="100%" height="auto" title="Program syscall Flow Chart" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>Here is a Proof-Of-Concept on how to interact with memory by creating a message box into a local process.</p> <p>The steps are:</p> <ol> <li>Allocate local process memory for the message box</li> <li>Write/copy the message box to allocated memory</li> <li>Execute the message box from local process memory</li> </ol> <p>At step one, we can use <code class="language-plaintext highlighter-rouge">OpenProcess</code> to obtain the handle of the specified process.</p> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">HANDLE</span> <span class="n">hProcess</span> <span class="o">=</span> <span class="n">OpenProcess</span><span class="p">(</span>
	<span class="n">PROCESS_ALL_ACCESS</span><span class="p">,</span> <span class="c1">// Defines access rights</span>
	<span class="n">FALSE</span><span class="p">,</span> <span class="c1">// Target handle will not be inhereted</span>
	<span class="n">DWORD</span><span class="p">(</span><span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="c1">// Local process supplied by command-line arguments </span>
<span class="p">);</span>
</code></pre></div></div> <p>At step two, we can use <code class="language-plaintext highlighter-rouge">VirtualAllocEx</code> to allocate a region of memory with the payload buffer.</p> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">remoteBuffer</span> <span class="o">=</span> <span class="n">VirtualAllocEx</span><span class="p">(</span>
	<span class="n">hProcess</span><span class="p">,</span> <span class="c1">// Opened target process</span>
	<span class="nb">NULL</span><span class="p">,</span> 
	<span class="k">sizeof</span> <span class="n">payload</span><span class="p">,</span> <span class="c1">// Region size of memory allocation</span>
	<span class="p">(</span><span class="n">MEM_RESERVE</span> <span class="o">|</span> <span class="n">MEM_COMMIT</span><span class="p">),</span> <span class="c1">// Reserves and commits pages</span>
	<span class="n">PAGE_EXECUTE_READWRITE</span> <span class="c1">// Enables execution and read/write access to the commited pages</span>
<span class="p">);</span>
</code></pre></div></div> <p>At step three, we can use <code class="language-plaintext highlighter-rouge">WriteProcessMemory</code> to write the payload to the allocated region of memory.</p> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">WriteProcessMemory</span><span class="p">(</span>
	<span class="n">hProcess</span><span class="p">,</span> <span class="c1">// Opened target process</span>
	<span class="n">remoteBuffer</span><span class="p">,</span> <span class="c1">// Allocated memory region</span>
	<span class="n">payload</span><span class="p">,</span> <span class="c1">// Data to write</span>
	<span class="k">sizeof</span> <span class="n">payload</span><span class="p">,</span> <span class="c1">// byte size of data</span>
	<span class="nb">NULL</span>
<span class="p">);</span>
</code></pre></div></div> <p>At step four, we can use <code class="language-plaintext highlighter-rouge">CreateRemoteThread</code> to execute our payload from memory.</p> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">remoteThread</span> <span class="o">=</span> <span class="n">CreateRemoteThread</span><span class="p">(</span>
	<span class="n">hProcess</span><span class="p">,</span> <span class="c1">// Opened target process</span>
	<span class="nb">NULL</span><span class="p">,</span> 
	<span class="mi">0</span><span class="p">,</span> <span class="c1">// Default size of the stack</span>
	<span class="p">(</span><span class="n">LPTHREAD_START_ROUTINE</span><span class="p">)</span><span class="n">remoteBuffer</span><span class="p">,</span> <span class="c1">// Pointer to the starting address of the thread</span>
	<span class="nb">NULL</span><span class="p">,</span> 
	<span class="mi">0</span><span class="p">,</span> <span class="c1">// Ran immediately after creation</span>
	<span class="nb">NULL</span>
<span class="p">);</span> 
</code></pre></div></div> <h3 id="question">Question</h3> <p><strong>Enter the flag obtained from the executable <em>inject-poc.exe</em>.</strong></p> <p><em>Answer: <code class="language-plaintext highlighter-rouge">THM{1Nj3c7_4lL_7H3_7h1NG2}</code></em></p> <h2 id="task-8---conclusion">Task 8 - Conclusion</h2> <p>Throughout this exploration of Windows internals, we’ve delved into the foundational components that underpin the Windows operating system. From processes and threads to virtual memory management, dynamic link libraries (DLLs), and the Portable Executable (PE) format, each element contributes to the intricate workings of Windows. These internals, deeply ingrained and integral to system functionality, present both opportunities and risks. Attackers leverage these internals for malicious purposes, exploiting vulnerabilities that can compromise system integrity.<br> The universality of these concepts extends beyond Windows to Unix environments, highlighting the enduring relevance of system internals in cybersecurity. Whether defending against or exploiting these fundamentals, understanding Windows internals is essential for both offensive and defensive security efforts, ensuring a comprehensive grasp of capabilities and vulnerabilities within complex operating system architectures.</p> </div> </article> <br> <hr> <br> <ul class="list-disc pl-8"></ul> <h2 class="text-3xl font-semibold mb-4 mt-12">Enjoy Reading This Article?</h2> <p class="mb-2">Here are some more articles you might like to read next:</p> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/THM-Advanced-Static-Analysis/">THM Advanced Static Analysis</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/THM-Anti-Reverse-Engineering/">THM Anti-Reverse Engineering</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/THM-MalDoc-Static-Analysis/">THM MalDoc: Static Analysis</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/THM-Dynamic-Analysis-Debugging/">THM Dynamic Analysis: Debugging</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/THM-Windows-Forensics-1/">THM Windows Forensics 1</a> </li> </div> </div> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2025 NonoHM . Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script defer src="/assets/js/bootstrap-toc.min.js?c82ff4de8b0955d6ff14f5b05eed7eb6"></script> <script src="/assets/js/no_defer.js?2930004b8d7fcd0a8e00fdcfc8fc9f24"></script> <script defer src="/assets/js/common.js?da39b660470d1ba6e6b8bf5f37070b6e"></script> <script defer src="/assets/js/copy_code.js?12775fdf7f95e901d7119054556e495f" type="text/javascript"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>