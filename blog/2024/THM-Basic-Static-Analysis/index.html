<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> THM Basic Static Analysis | NonoHM </title> <meta name="author" content="NonoHM "> <meta name="description" content="Welcome to my personnal website. I am currently a 2nd year student in the " but r et t program. i like doing sports and music besides learning new things in it.> <meta name="keywords" content="jekyll, jekyll-theme, portfolio-website, writeups, projects"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link defer href="/assets/css/bootstrap-toc.min.css?6f5af0bb9aab25d79b2448143cbeaa88" rel="stylesheet"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://nonohm.github.io/blog/2024/THM-Basic-Static-Analysis/"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js?0afe9f0ae161375728f7bcc5eb5b4ab4"></script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> NonoHM </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item "> <a class="nav-link" href="/blog/">blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">projects </a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">repositories </a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fa-solid fa-moon"></i> <i class="fa-solid fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="row"> <div class="col-sm-3"> <nav id="toc-sidebar" class="sticky-top"></nav> </div> <div class="col-sm-9"> <div class="post"> <header class="post-header"> <h1 class="post-title">THM Basic Static Analysis</h1> <p class="post-meta"> May 01, 2024 • NonoHM </p> <p class="post-tags"> <a href="/blog/2024"> <i class="fa-solid fa-calendar fa-sm"></i> 2024 </a>   ·   <a href="/blog/tag/thm"> <i class="fa-solid fa-hashtag fa-sm"></i> THM</a>   <a href="/blog/tag/malware-analysis"> <i class="fa-solid fa-hashtag fa-sm"></i> Malware Analysis</a>   <a href="/blog/tag/re"> <i class="fa-solid fa-hashtag fa-sm"></i> RE</a>   <a href="/blog/tag/static-analysis"> <i class="fa-solid fa-hashtag fa-sm"></i> Static Analysis</a>   </p> </header> <article class="post-content"> <div id="markdown-content"> <h2 id="task-1---introduction">Task 1 - Introduction</h2> <h3 id="learning-objectives">Learning Objectives</h3> <p>The first step in analyzing malware is generally to look at its properties without running it by doing static analysis. Here, we will cover the following topics:</p> <ul> <li>Lab setup for malware analysis</li> <li>Searching for strings in a malware</li> <li>Fingerprinting malware through hashes</li> <li>Signature-based detection mechanisms</li> <li>Extracting useful information from the PE header</li> </ul> <h2 id="task-2---lab-setup">Task 2 - Lab Setup</h2> <p>Because by analyzing malware is risky and often destructive, we must set a proper environment before it damages our envrionment. Therefore, we need to create a lab setup to analyze them.</p> <p>To make it alive, we are using here Virtual Machines because of its ability to save the state of the machine and revert as well as its flexibility. VMs are created using <a href="https://www.virtualbox.org/" rel="external nofollow noopener" target="_blank">Oracle VirtualBox</a> or <a href="https://www.vmware.com/products/workstation-pro.html" rel="external nofollow noopener" target="_blank">VMWare Workstation</a>.</p> <p>Two distributions are mainly used to make Reverse Engineering, <a href="https://github.com/mandiant/flare-vm?tab=readme-ov-file" rel="external nofollow noopener" target="_blank">FLARE VM</a> and <a href="https://docs.remnux.org/install-distro/get-virtual-appliance" rel="external nofollow noopener" target="_blank">REMnux</a>. FLARE VM is a Windows Based VM, but it is given as a toolkit script and REMnux is a Linux based malware analysis distro.</p> <h2 id="task-3---string-search">Task 3 - String search</h2> <p>A string search can provide useful information of a malware by identifying important pieces of strings.</p> <p>String search, regardless of the file type, identifies sequences of ASCII/unicode character followed by a null character. Werever it finds such a sequence, it reports that as a string but many sequences of bytes can fulfill the criteria mentionned above. Many values are not useful and a string search can provide many False Positives like memory addresses, asm instructions… and they should be ignored.</p> <p>Because an analyst has to differentiate strings of interest from garbage ones, the following artefacts can be used as Indicators of Compromise (IOCs):</p> <ul> <li>Windows Functions and APIs for providing possible functionality of the malware</li> <li>IP Addresses, URL or domain like for a C2 server</li> <li>Miscellaneous strings</li> </ul> <h3 id="basic-string-search">Basic String Search</h3> <p>String searches can be made using the <code class="language-plaintext highlighter-rouge">strings</code> utility that comes pre-installed in linux or <code class="language-plaintext highlighter-rouge">strings.exe</code> in the SysInternals Suite for Windows. Several tools like Cyberchef or PEStudio allows us the ability to make string searches and more.</p> <h3 id="obfuscated-strings">Obfuscated strings</h3> <p>Beceause string searches can disrupt malware propagation and infection, malware authors deploy obfuscation techniques to obfuscate key parts of their code. These often make a string search ineffective.</p> <p><a href="https://www.mandiant.com/resources/blog/automatically-extracting-obfuscated-strings" rel="external nofollow noopener" target="_blank">FLOSS</a> for FireEye Labs Obfuscated String Solver can be sometimes useful to deobfuscate and extract strings that would not normally</p> <h3 id="question">Question</h3> <p><strong>On the Desktop in the attached VM, there is a directory named ‘mal’ with malware samples 1 to 6. Use floss to identify obfuscated strings found in the samples named 2, 5, and 6. Which of these samples contains the string ‘DbgView.exe’?</strong></p> <p>By using FLOSS on these samples with the command:</p> <pre><code class="language-cmd">floss --no-static-strings &lt;file&gt;
</code></pre> <p><em>Answer: <code class="language-plaintext highlighter-rouge">6</code></em></p> <h2 id="task-4---fingerprinting-malware">Task 4 - Fingerprinting malware</h2> <p>When analyzing malware, it is often required to identify unique malware and differentiate them from each other. Because file names can be easily canged, hashes are a good option because they create a unique fixed-length indentifier.</p> <p>These functions are the most common used methods to create a file hash. However, the first two are now considered insecure because they can produce the same hash for multiple inputs.</p> <ul> <li>Md5sum</li> <li>Sha1sum</li> <li>Sha256sum</li> </ul> <h3 id="finding-similar-files-using-hashes">Finding Similar files using hashes</h3> <p>We have seen that hashes are unique and even a slight change can modify a hash’s content. Though, some types of hashes can help identify similarities among different files.</p> <p><strong>Imphash</strong></p> <p><a href="https://www.mandiant.com/resources/blog/tracking-malware-import-hashing" rel="external nofollow noopener" target="_blank">Imphash</a> stands for <em>import hash</em> and it is a hash of the function calls/libraries that a malware sample imports and the order in which these libraries are present in the sample. This helps identify samples from the same threat groups of performing similar activities.</p> <p>Imphash of a program can be viewed in PEstudio and similar samples can be identified in <a href="https://bazaar.abuse.ch/browse.php" rel="external nofollow noopener" target="_blank">Malware Bazaar</a>.</p> <p><strong>Fuzzy Hashes/SSDEEP</strong></p> <p>A fuzzy hash is a Context Triggered Piecewise Hash (CTPH). This hash is calculates by dividing a file into pieces and calculating the hashes of the different pieces. This method creates multiple inputs with similar sequences of bytes.</p> <p><code class="language-plaintext highlighter-rouge">ssdeep</code> or CyberChef are utilities that can calculate a file’s fuzzy hash.</p> <pre><code class="language-cmd">ssdeep &lt;file&gt; # Calculate a file's fuzzy hash
ssdeep -l -r -d &lt;directory&gt; # Match files recursively with similar fuzzy hashes 
</code></pre> <h3 id="questions">Questions</h3> <p><strong>In the samples located at <code class="language-plaintext highlighter-rouge">Desktop\mal\</code> directory in the attached VM, which of the samples has the same imphash as file 3?</strong></p> <p>By running <code class="language-plaintext highlighter-rouge">ssdeep -d ../mal/*</code>:</p> <p><em>Answer: <code class="language-plaintext highlighter-rouge">1</code></em></p> <p><strong>Using the ssdeep utility, what is the percentage match of the above-mentioned files?</strong></p> <p><em>Answer: <code class="language-plaintext highlighter-rouge">93</code></em></p> <h2 id="task-5---signature-based-detection">Task 5 - Signature-based detection</h2> <p>We have learnt how hashes could identify identical files and identify file similarities using imphash and ssdeep. Sometimes, we just need to identify if a file contains the information of interesst though.</p> <h3 id="signatures">Signatures</h3> <p>Signatures are a way to idetify a particular type of content because signatures can be considered as a pattern that might be found inside a file. The pattern is often a sequence of bytes in a file, with or without any context.</p> <p><strong>Yara rules</strong></p> <p>Yara rules are a type of signature-based rule. It can identify information based on binary and textual patterns such as hex or strings. However, even if <a href="https://github.com/Yara-Rules/rules" rel="external nofollow noopener" target="_blank">community rules</a> or homebrew rules hits doesn’t mean the file is malicious. It is important to know the properties of the rule.</p> <p><strong>Proprietary Signatures - Antivirus Scans</strong></p> <p>Proprietary signatures have the advantage of having less chances of False Positives (a signature hits a non-malicious file) but this might lead to few False Negatives (a malicious file does not hit any signature).</p> <p>That is why it is important to get a verdict from multiple products like with <a href="https://www.virustotal.com/gui/home/upload" rel="external nofollow noopener" target="_blank">Virustotal</a>. When analyzing a sensitive file, it is important to search hash on Virustotal or importing it on non-reporting scanning service (which Virustotal does not do).</p> <p><strong>Capa</strong></p> <p><a href="https://github.com/mandiant/capa" rel="external nofollow noopener" target="_blank">Capa</a> is an FOSS tool to help identify the capabilities found in a PE file. It reads the file and tries to identifies the behavior based on signatures such as imports, strings, mutexes…</p> <p>Capa identifies and maps capabilities according to the <a href="https://attack.mitre.org/" rel="external nofollow noopener" target="_blank">MITRE ATT&amp;CK</a> framework and <a href="https://github.com/MBCProject/mbc-markdown" rel="external nofollow noopener" target="_blank">Malware Behavior Catalog</a>.</p> <p>The syntax is the following:</p> <pre><code class="language-cmd">capa &lt;file&gt;
capa -h
</code></pre> <h3 id="questions-1">Questions</h3> <p>Using the file in <code class="language-plaintext highlighter-rouge">Desktop\mal\4</code>:</p> <p><strong>How many matches for anti-VM execution techniques were identified in the sample?</strong></p> <p><em>Answer: <code class="language-plaintext highlighter-rouge">86</code></em></p> <p><strong>Does the sample have to capability to suspend or resume a thread? Answer with Y for yes and N for no.</strong></p> <p><em>Answer: <code class="language-plaintext highlighter-rouge">Y</code></em></p> <p><strong>What MBC behavior is observed against the MBC Objective ‘Anti-Static Analysis’?</strong></p> <p><em>Answer: <code class="language-plaintext highlighter-rouge">Disassembler Evasion::Argument Obfuscation [B0012.001]</code></em></p> <p><strong>At what address is the function that has the capability ‘Check HTTP Status Code’?</strong></p> <p><em>Answer: <code class="language-plaintext highlighter-rouge">0x486921</code></em></p> <h2 id="task-6---leveraging-the-pe-header">Task 6 - Leveraging the PE header</h2> <p>Because the covered techniques, even though they provide information regardless of the file type of the malware, don’t always provide us deterministic information; PE Heasers provide a more deterministic characteristics of the sample, which tells us more about it.</p> <h3 id="pe-header">PE Header</h3> <p>PE files consist of a sequence of bits stored on the disk in a specific format. The initial bits of the PE file define the characteristics of it and explains us how to read the contained data. This initial part is called the PE Header.</p> <p>PEStudio can help us dissect PE Header.</p> <p><strong>Linked Libraries, imports and functions</strong></p> <p>A PE File does not contain all of its code to perform tasks and reuses code from different liraries. The information about what library (.dll) is imported, is contained in the PE Header and can give us a rough idea of the functionnality of the malware sample.</p> <p><strong>Identifying Packed Executables</strong></p> <p>Static analysis can provide a lot of informatio about the executable, so in order to face this problem, obfuscation is often used to block analysis. One way of doing this is by packing the original sample inside a shell-type code that obfuscates the proerties of the actual malware sample.<br> Packed executables are identifiable by analyzing ressource sections and entropies.</p> <h3 id="questions-2">Questions</h3> <p><strong>Open the sample Desktop\mal\4 in PEstudio. Which library is blacklisted?</strong></p> <figure> <picture> <img src="/assets/img/images/thm_basic_static_analysis/r1lS4FbzR.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="PEStudio Libraries Import" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p><em>Answer: <code class="language-plaintext highlighter-rouge">rpcrt4.dll</code></em></p> <p><strong>What does this DLL do?</strong></p> <p><em>Answer: <code class="language-plaintext highlighter-rouge">Remote Procedure Call Runtime</code></em></p> <h2 id="task-7---conclusion">Task 7 - Conclusion</h2> <p>In this room, we have learned about:</p> <ul> <li>Lab setup for malware analysis</li> <li>Searching for strings and obfuscated strings</li> <li>Fingerprinting malware using hashes and identifying similar samples using imphash and ssdeep</li> <li>Using signature-based detection like Yara and Capa</li> <li>Identifying artifacts from the PE header</li> </ul> </div> </article> <br> <hr> <br> <ul class="list-disc pl-8"></ul> <h2 class="text-3xl font-semibold mb-4 mt-12">Enjoy Reading This Article?</h2> <p class="mb-2">Here are some more articles you might like to read next:</p> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/THM-Advanced-Static-Analysis/">THM Advanced Static Analysis</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/THM-MalDoc-Static-Analysis/">THM MalDoc: Static Analysis</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/THM-Dynamic-Analysis-Debugging/">THM Dynamic Analysis: Debugging</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/THM-Anti-Reverse-Engineering/">THM Anti-Reverse Engineering</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/THM-Basic-Dynamic-Analysis/">THM Basic Dynamic Analysis</a> </li> </div> </div> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2025 NonoHM . Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script defer src="/assets/js/bootstrap-toc.min.js?c82ff4de8b0955d6ff14f5b05eed7eb6"></script> <script src="/assets/js/no_defer.js?2930004b8d7fcd0a8e00fdcfc8fc9f24"></script> <script defer src="/assets/js/common.js?da39b660470d1ba6e6b8bf5f37070b6e"></script> <script defer src="/assets/js/copy_code.js?12775fdf7f95e901d7119054556e495f" type="text/javascript"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>