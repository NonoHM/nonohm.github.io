<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> THM Dynamic Analysis: Debugging | NonoHM </title> <meta name="author" content="NonoHM "> <meta name="description" content="Welcome to my personnal website. I am currently a 2nd year student in the " but r et t program. i like doing sports and music besides learning new things in it.> <meta name="keywords" content="jekyll, jekyll-theme, portfolio-website, writeups, projects"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link defer href="/assets/css/bootstrap-toc.min.css?6f5af0bb9aab25d79b2448143cbeaa88" rel="stylesheet"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://nonohm.github.io/blog/2024/THM-Dynamic-Analysis-Debugging/"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js?0afe9f0ae161375728f7bcc5eb5b4ab4"></script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> NonoHM </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item "> <a class="nav-link" href="/blog/">blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">projects </a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">repositories </a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fa-solid fa-moon"></i> <i class="fa-solid fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="row"> <div class="col-sm-3"> <nav id="toc-sidebar" class="sticky-top"></nav> </div> <div class="col-sm-9"> <div class="post"> <header class="post-header"> <h1 class="post-title">THM Dynamic Analysis: Debugging</h1> <p class="post-meta"> August 19, 2024 • NonoHM </p> <p class="post-tags"> <a href="/blog/2024"> <i class="fa-solid fa-calendar fa-sm"></i> 2024 </a>   ·   <a href="/blog/tag/thm"> <i class="fa-solid fa-hashtag fa-sm"></i> THM</a>   <a href="/blog/tag/malware-analysis"> <i class="fa-solid fa-hashtag fa-sm"></i> Malware Analysis</a>   <a href="/blog/tag/re"> <i class="fa-solid fa-hashtag fa-sm"></i> RE</a>   <a href="/blog/tag/dynamic-analysis"> <i class="fa-solid fa-hashtag fa-sm"></i> Dynamic Analysis</a>   </p> </header> <article class="post-content"> <div id="markdown-content"> <h2 id="task-1---introduction">Task 1 - Introduction</h2> <p>In Basic Dynamic Analysis room, we have learnt how to identify malware traces in an infected system during execution. However, malware authors understand that malwares are analyzed and want to thwart this by doing some more advanced evasion techniques.<br> In order to defeat some of them, we will learn how a malware analyst can control malware execution to achieve the desired results.</p> <h3 id="learning-ojectives">Learning Ojectives</h3> <ul> <li>Evasion techniques used to evade basic dynamic analysis</li> <li>Introduction to debuggers and how they can help us control the execution flow of malware</li> <li>Manipulating execution flow at runtime by changing registers or other parameters</li> <li>Patching malware to force it to move past the evasion techniques onto the actual malicious content</li> </ul> <h3 id="pre-requisites">Pre-requisites</h3> <p>It is recommended to have followed these rooms to get a better understanding from this one:</p> <ul> <li><a href="https://tryhackme.com/room/staticanalysis1" rel="external nofollow noopener" target="_blank">Basic Static Analysis</a></li> <li><a href="https://tryhackme.com/room/advancedstaticanalysis" rel="external nofollow noopener" target="_blank">Advanced Static Analysis</a></li> <li><a href="http://tryhackme.com/room/basicdynamicanalysis" rel="external nofollow noopener" target="_blank">Basic Dynamic Analysis</a></li> </ul> <h2 id="task-2---the-need-for-advanced-dynamic-analysis">Task 2 - The Need for Advanced Dynamic Analysis</h2> <p>Analyzing malware is like a cat-and-mouse game. While malware analysts keep devising new techniques to analyze malware, malware authors conceives new techniques to evade detection.</p> <h3 id="evasion-of-static-analysis">Evasion of Static Analysis</h3> <p>In static analysis, because we are not executing the malware, its main focus for evading is to obfuscate the true functionality of the program until it is executed. The following techniques are the common ones used to achieve this:</p> <ul> <li> <strong>Changing the hash</strong>: Since every file has a unique hash, sligthly changing the malware bypasses a hash-based detection mechanism (unless we are talking about fuzzy hashes). This is usually done by adding a <code class="language-plaintext highlighter-rouge">NOP</code> instruction.</li> <li> <strong>Defeating AV signatures</strong>: Signature-based detection often depend on static patterns found inside the malware. Signature detection is evaded by changing those and adding some obfuscation.</li> <li> <strong>Obfuscation of strings</strong>: Strings can be obfuscated in the code and decoded at runtime. This makes string search unsuccessful. Malware authors might obfuscate important strings such as URLs, C2 domains, etc…</li> <li> <strong>Runtime loading of DLLs</strong>: When analyzing a malware statically, we might not see all the functions it is linked to because they are loaded at runtime using <code class="language-plaintext highlighter-rouge">LoadLibrary</code>. However, we can try to identify what imports are being made.</li> <li> <strong>Packing and Obfuscation</strong>: Packing is a very popular way to obfuscate a binary owing the fact that a packer packs the malware in a wrapper by encoding the actual code and writing code that decodes it at execution.</li> </ul> <h3 id="evasion-of-basic-dynamic-analysis">Evasion of Basic Dynamic Analysis</h3> <p>Since malware won’t let themselves being detected, a host of techniques are employed, of which the most common ones are identifying if the malware runs in a controlled analysis environment. The following techniques are used for this purpose:</p> <ul> <li> <strong>Identification of VMs</strong>: Though some of these techniques might backfire nowadays since a lot of company infrastructures are hosted on VM, one of the favourites is to identify if the malware is running inside a VM. For this, registry keys or drivers associated with popular virtualization software like VirtualBox/VMWare are checked. Similarly, minimal ressources such as a single CPU and limited RAM might indicate that the malware is running inside a VM. In this case, malware will take a legitimate execution path to fool the analyst.</li> <li> <strong>Timing attacks</strong>: To time out automated analysis systems, the <em>Windows Sleep Library</em> is mainly used. These type of systems usually shut down after a few minutes, finding no traces of malicious activity. Newer analysis systems can identify these attacks and try to mitigate them by shortening the time the malware sleeps. However, those mitigations can be identified by the malware by noting the time of execution and comparing with the current time after the execution of the sleep call.</li> <li> <strong>Traces of user activity</strong>: Malware tries to identify traces of user activity (mouse, keyboard, browser history, recently opened files, little system uptime…), then if no or few traces are found, it will change its execution scheme.</li> <li> <strong>Identification of analysis tools</strong>: Running processes can be listed on Windows systems using <code class="language-plaintext highlighter-rouge">Process32First</code>, <code class="language-plaintext highlighter-rouge">Process32Next</code>, etc… If popular monitoring tools are identified among the list like <em>ProcMon</em> or <em>ProcExp</em>, the malware can switch its activites. Another ways of identifying are by looking at the names of different windows, searching for some services or checking applications behaviour.</li> </ul> <h3 id="questions">Questions</h3> <p><strong>Malware sometimes checks the time before and afte r the execution of certain instructions to find out if it is being analysed. What type of analysis technique is bypassed by this attack?</strong></p> <p><em>Answer: <code class="language-plaintext highlighter-rouge">Basic Dynamic Analysis</code></em></p> <p><strong>What is a popular technique used by malware authors to obfuscate malware code from static analysis and unwrap it at runtime?</strong></p> <p><em>Answer: <code class="language-plaintext highlighter-rouge">Packing</code></em></p> <h2 id="task-3---introduction-to-debugging">Task 3 - Introduction to Debugging</h2> <p>The term <em>Debugging</em> is widely used by software programmer to identify and fix bugs in a program. Similarly, a malware trying to evade detection or reverse engineering can also be considered as a program having a bug.<br> Because a malware analyst often has to debug a program to remove any roadblocks that prevent it from performing its malicious activity, interactive debugging becomes an essential part of Advanced Malware Analysis. Debugger provides the control to running a program more closely by looking at the changes in different registers, variables and memory regions step by step as each instruction is executed one at a time. It also provides the ability to change the variables’ values and other parameters to control the program’s flow at runtime.</p> <h3 id="source-level-debuggers">Source-Level Debuggers</h3> <p>Source Level Debuggers work on the source code of a program and are often used by software developpers to check bugs in their code. It is a high-level option compared to the two other ones.</p> <h3 id="assembly-level-debuggers">Assembly-Level Debuggers</h3> <p>When a program has been compiled, its source code is lost and can’t be recovered. Usually, we don’t have the malware’s source code we are investigating and have a compiled binary instead. An assembly-level debugger can help us debug compiled programs by seeing the CPU regsiters’ values and the debugger’s memory. This is the most common type of debugger used for malware RE.</p> <h3 id="kernel-level-debuggers">Kernel-Level Debuggers</h3> <p>This type of debugger is a step even lower than assembly-level ones. As the name suggests, it permits the debug of a program at the Kernel Level which involves two systems, one used for debugging and another one where the code is running. This is because if the kernel is stopped using a breakpoint, the whole system will stop.</p> <h3 id="questions-1">Questions</h3> <p><strong>Can we recover the pre-compilation code of a compiled binary for debugging purposes? Write Y for Yes or N for No</strong></p> <p><em>Answer: <code class="language-plaintext highlighter-rouge">N</code></em></p> <p><strong>Which type of debugger is used for debugging compiled binaries?</strong></p> <p><em>Answer: <code class="language-plaintext highlighter-rouge">Assembly-level debugger</code></em></p> <p><strong>Which debugger works at the lowest level among the discussed debuggers?</strong></p> <p><em>Answer: <code class="language-plaintext highlighter-rouge">Kernel-level debugger</code></em></p> <h2 id="task-4---familiarization-with-a-debugger">Task 4 - Familiarization with a Debugger</h2> <p>For malware analysis, there are many options to choose a debugger from, such as <em>Windbg</em>, <em>Ollydbg</em>, <em>IDA</em>, <em>Ghidra</em> and <em>x32/x64dbg</em>. Here, we will be using the last one.</p> <p>When we open <em>x32dbg</em> (x32dbg for 32-bit applications, x64dbg for 64-bit applications) in FLARE VM <code class="language-plaintext highlighter-rouge">Desktop &gt; Tools &gt; debuggers &gt; x32dbg.exe</code>, we are greeted with this interface:</p> <figure> <picture> <img src="/assets/img/images/thm_dynamic_analysis_debugging/SJCr_ZXjC.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="x32dbg interface" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>To open a file in the debugger, we can navigate to <code class="language-plaintext highlighter-rouge">File &gt; Open</code>. The below creenshot show the interface with a sample opened in the debugger.</p> <figure> <picture> <img src="/assets/img/images/thm_dynamic_analysis_debugging/rySJFfmoR.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="x32dbg Main interface with sample" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>As we can see in the bottom-left corner, the execution of the program is paused because a <em>System breakpoint</em> has been reached. We can control whether to execute one instruction at a time or the whole program.<br> In the screenshot above, we can see different parts in the main window, where each one have a specific role:</p> <ol> <li> <strong>CPU disassembly</strong>: This is where the assembly instructions are located. <ul> <li>In the first colum contains the EIP (Extended Instruction Pointer) pointing to the next instruction which will be run.</li> <li>The second column contains addresses within the binary where instructions reside, here EIP is pointing to <code class="language-plaintext highlighter-rouge">77A6F147</code>.</li> <li>The third colum is the hexadecimal representation of the instruction in column 4.</li> <li>The fourth column is where the assembly instructions are located, here the next instruction to be executed is <code class="language-plaintext highlighter-rouge">jmp ntdll.Memoryaddress</code>.</li> <li>The fifth column is contains data populated by x64dbg or notes that have been added by the analyst. Most of the time, binary’s strings will be shown here.</li> </ul> </li> <li> <strong>CPU Registers</strong>: This window contains information related to registers and flags. More information available in <a href="https://tryhackme.com/r/room/x8664arch" rel="external nofollow noopener" target="_blank">x86 Architecture Overview</a> <ul> <li>EAX: Used for addition, multiplication and return values</li> <li>EBX: Generic register, used for various operations</li> <li>ECX: Used as a counter</li> <li>EDX: Generic register, used for various operations</li> <li>EBP: Used to reference arguments and local variables</li> <li>ESP: Points to the last argument on the stack</li> <li>ESI/EDI: Used in memory transfer instructions</li> <li>EIP: Points to the current instruction in x32dbg that will be executed</li> <li>FLAGS</li> </ul> </li> <li> <strong>Stack Memory</strong>: This window contains the parameters that have been pushed onto the stack.</li> <li> <strong>Stack and data</strong>: This window contains the stack, the data that has been pushed onto the stack and the addresses in memory they are mapped to.</li> <li> <strong>Dump Data</strong>: This window allows the user to see what is being stored in a register or what data resides at a certain address.</li> </ol> <p>Let’s look at some of the other tabs. The <em>breakpoints</em> tab shows the current status of breakpoints. Breakpoints are where the execution of the program is paused for the analyst to analyze the registers and memory. It can be enabled by clicking the dot located in front of each instruction in <em>CPU</em> tab.</p> <figure> <picture> <img src="/assets/img/images/thm_dynamic_analysis_debugging/rkeRqz7jA.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="x32dbg Breakpoints tab" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>The <em>Memory Map</em> tab show the memory of the program:</p> <figure> <picture> <img src="/assets/img/images/thm_dynamic_analysis_debugging/HJJ-oGQiA.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="Memory Map tab" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>We can also see the <em>Call Stack</em> of the program:</p> <figure> <picture> <img src="/assets/img/images/thm_dynamic_analysis_debugging/HyDVoGmjC.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="Call Stack tab" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>Running threads of the current program are show in the <em>Threads</em> tab:</p> <figure> <picture> <img src="/assets/img/images/thm_dynamic_analysis_debugging/HJB6ozXo0.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="Threads tab" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>Any handles to files, process or other ressources the process accesses are shown in the <em>Handles</em> tab:</p> <figure> <picture> <img src="/assets/img/images/thm_dynamic_analysis_debugging/Hk9x3M7s0.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="Handles tab" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <h3 id="questions-2">Questions</h3> <p><strong>In which tab is the disassembly view shown in x32dbg?</strong></p> <p><em>Answer: <code class="language-plaintext highlighter-rouge">CPU Tab</code></em></p> <p><strong>If a process opens a file or a process, where can we see information regarding that opened file or process?</strong></p> <p>*Answer: <code class="language-plaintext highlighter-rouge">Handles Tab</code></p> <h2 id="task-5---debugging-in-practice">Task 5 - Debugging in Practice</h2> <p>Now we are bit more familiar with the UI of x32dbg, let’s learn about debugging a program in practice by executing it step-by-step.</p> <p>Firstly, we select the file we need to open using <code class="language-plaintext highlighter-rouge">File &gt; Open</code> or with <code class="language-plaintext highlighter-rouge">F3</code>. The debugger attaches itself to the process and pauses it before it starts, that is why we see a blank command window in the background. Furthermore, the window might not open with all processes depending on the UI (User Interface) of the process.</p> <figure> <picture> <img src="/assets/img/images/thm_dynamic_analysis_debugging/r1Oe6IEiR.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="x32dbg crackme-arebel" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>In the debugger window, we have some features that help us control the execution, presented in the screenshot below:</p> <figure> <picture> <img src="/assets/img/images/thm_dynamic_analysis_debugging/rkSxCI4j0.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="x32dbg debugging function" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>Among these buttons, from left to right we have the feature for:</p> <ul> <li>Opening a new file</li> <li>Restarting the execution of the app from the start</li> <li>Stopping the execution</li> <li>Execute the program until it is stopped or paused by some control/breakpoint</li> <li>Pause the execution</li> <li>Step into a function call</li> <li>Step over a function call</li> </ul> <p>To start with debugging, we use the <em>arrow</em> button to go the first breakpoint, which is normally the entry point of the program. Along with the status, we see the reason <em>INT3 breakpoint “TLS Callback 1”</em>, which means we have hit a <a href="https://hex-rays.com/blog/tls-callbacks/" rel="external nofollow noopener" target="_blank">TLS Callback</a> and the debugger is configured to automatically break on them.<br> To resume, a <em>Thread Local Storage</em> or <em>TLS</em> for short, is a mechanism which allows a thread to have its own storage for data with its own instance of variables in order to not make interference in multithread application. TLS Callbacks are special functions in Windows used to initialize or clean process or thread data.</p> <figure> <picture> <img src="/assets/img/images/thm_dynamic_analysis_debugging/SJbrVliiA.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="x32dbg TLS Callback" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>In the debugger, we can set where to put automatic breakpoints in <code class="language-plaintext highlighter-rouge">Options &gt; Preferences</code> menu. Here, we can see that TLS Callbacks breakpoints are checked.</p> <figure> <picture> <img src="/assets/img/images/thm_dynamic_analysis_debugging/B10e8gss0.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="x32dbg options" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>Since TLS Callbacks are often used as an anti-reverse engineering technique because they are running before the entry point of the program. Therefore, we should be careful when navigating with TLS Callbacks and single-step each instruction while we are in the callback. After stepping into every instruction, we see the EIP increasing, values in registers and stack change accordingly. Then, we reach a conditional jump instruction <code class="language-plaintext highlighter-rouge">jne</code> for <em>jump not equal</em> which jumps if the <em>zero flag</em> ZF is set to 0. In the pane below, the debugger tells us that the jump is not taken.</p> <figure> <picture> <img src="/assets/img/images/thm_dynamic_analysis_debugging/SJl4ybsoR.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="x32dbg conditionnal jump" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>If we analyze both paths, it goes to address <em>D116E</em> if the jump is taken which pops <code class="language-plaintext highlighter-rouge">ebp</code> and returns. On the other hand, the current execution path takes us to the address <em>D1000</em>. To know what instruction and execution flow is comming at this address, we can hover it get a glimpse or double clicking to access it.<br> The below screenshot show the code following at this address and we see a few API calls like <a href="https://learn.microsoft.com/en-us/windows/win32/api/tlhelp32/nf-tlhelp32-createtoolhelp32snapshot" rel="external nofollow noopener" target="_blank">CreateToolhelp32Snapshot</a>, <a href="https://learn.microsoft.com/en-us/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya" rel="external nofollow noopener" target="_blank">LoadLibrary</a> and <a href="https://learn.microsoft.com/en-us/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya" rel="external nofollow noopener" target="_blank">GetProcAddress</a> further down. If we were sure what this function call was intended for, we could just step over it to bring us back after the execution has been executed.</p> <figure> <picture> <img src="/assets/img/images/thm_dynamic_analysis_debugging/r1CMir3i0.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="x32dbg D1000 execution path" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>However, the function seem very important and we don’t know if it is used for legitimate purposes or to evade detection. Hence, we must move along this path and restart if we see a red flag. Moving forward, another library loaded is <code class="language-plaintext highlighter-rouge">SuspendThread</code>.</p> <figure> <picture> <img src="/assets/img/images/thm_dynamic_analysis_debugging/S1tzorhoR.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="x32dbg API calls" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>This TLS callback will suspend the thread based on detecting a running process such as a debugger (<code class="language-plaintext highlighter-rouge">CreateToolhelp32Snapshot</code> API helps identiéfying processes). This is why the program freeze if we proceed with the execution, thus this will be the goal in the next task to jump over the call.</p> <h3 id="questions-3">Questions</h3> <p><strong>The attached VM has a crackme in the directory <code class="language-plaintext highlighter-rouge">Desktop &gt; crackme-arebel</code>. In that crackme, there is a TLS callback with a conditional jump. Is this conditional jump taken? Write Y for Yes or N for No</strong></p> <p>Because ZF = 1, the <code class="language-plaintext highlighter-rouge">jne</code> conditional jump is not taken.</p> <figure> <picture> <img src="/assets/img/images/thm_dynamic_analysis_debugging/SJeR29TjA.jpg" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="jne" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p><em>Answer: <code class="language-plaintext highlighter-rouge">N</code></em></p> <p><strong>What is the value of the Zero Flag in the above-mentioned conditional jump?</strong></p> <p><em>Answer: <code class="language-plaintext highlighter-rouge">1</code></em></p> <p><strong>Which API call in the mentioned sample is used for enumerating running processes?</strong></p> <p>The API call used for enumerating process is at address <code class="language-plaintext highlighter-rouge">000D1014</code> .</p> <p><em>Answer: <code class="language-plaintext highlighter-rouge">CreateToolhelp32Snapshot</code></em></p> <p><strong>From which Windows DLL is the API SuspendThread being called?</strong></p> <p>The API <code class="language-plaintext highlighter-rouge">SuspendThread</code> documentation is available <a href="https://learn.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-suspendthread" rel="external nofollow noopener" target="_blank">here</a>. Also, we see that <code class="language-plaintext highlighter-rouge">kernel32.dll</code> is being loaded from <code class="language-plaintext highlighter-rouge">000D1033</code> to <code class="language-plaintext highlighter-rouge">000D106B</code> using <code class="language-plaintext highlighter-rouge">LoadLibrary</code>.</p> <figure> <picture> <img src="/assets/img/images/thm_dynamic_analysis_debugging/r12_gsaiA.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="kernel32.dll loading" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p><em>Answer: <code class="language-plaintext highlighter-rouge">kernel32.dll</code></em></p> <h2 id="task-6---bypassing-unwanted-execution-path">Task 6 - Bypassing unwanted execution path</h2> <p>When we reload the crackme and run it one time, we come across the TLS callback again.</p> <figure> <picture> <img src="/assets/img/images/thm_dynamic_analysis_debugging/ByXpL8xaR.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="TLS Callback" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>In order to make a <code class="language-plaintext highlighter-rouge">jne/jnz</code> jump, we need to set the zero flag ZF to 0. Because the two previous values compared were the same, the ZF was set to 1.</p> <figure> <picture> <img src="/assets/img/images/thm_dynamic_analysis_debugging/rku9tLlpA.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="Changing ZF" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>This manipulation with the debugger will make us pass the TLS Callback and make us jump over the evasion detection. This is very practical to use, especially for first time analysis.<br> Due to the nature of changing a value, restarting our program would make the ZF flag return to value 1. This is time to use patching, which will change the instructions of the program directly into the file.</p> <p>In our situation, we have multiple choices to bypass this:</p> <ul> <li>Change <code class="language-plaintext highlighter-rouge">jne</code> instruction for a <code class="language-plaintext highlighter-rouge">je</code> one</li> <li>Use a unconditionnal jump</li> <li>Fill instructions with NOPs (No operation instruction)</li> <li>and more …</li> </ul> <p>Here we will change <code class="language-plaintext highlighter-rouge">jne</code> to <code class="language-plaintext highlighter-rouge">je</code>. To edit that instruction, we right-click on it, then use <em>Assemble</em> or just use <em>Space</em> on that instruction:</p> <figure> <picture> <img src="/assets/img/images/thm_dynamic_analysis_debugging/BkT43Ig6A.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="Assemble button" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <figure> <picture> <img src="/assets/img/images/thm_dynamic_analysis_debugging/H13v0IeaA.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="Changing assembly instructions" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>By changing this parameter, we have successfully bypassed this TLS callback:</p> <figure> <picture> <img src="/assets/img/images/thm_dynamic_analysis_debugging/ryRWRLep0.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="TLS Callback bypassed" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>For the <em>Fill with NOPs</em> option, we use the suggested option by x86dbg by going to <em>Binary &gt; Fill with NOPs</em> it:</p> <figure> <picture> <img src="/assets/img/images/thm_dynamic_analysis_debugging/B1XTALxT0.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="Fill with NOPs option" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>Below is what we get by filling with NOPs. There is 5 <code class="language-plaintext highlighter-rouge">nop</code> instructions because we need to have the same instruction size as before the patch in order to preserve the statically contained memory addresses.</p> <figure> <picture> <img src="/assets/img/images/thm_dynamic_analysis_debugging/r1QUWPeTR.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="Filling with NOPs result" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>The issue with patching a binary is that we need to save it on disk. To patch and export definitely the binary, we go to <em>File &gt; Patch</em> or <em>Ctrl + P</em>:</p> <figure> <picture> <img src="/assets/img/images/thm_dynamic_analysis_debugging/SkjQlwgpA.png" class="img-fluid rounded z-depth-1" width="70%" height="auto" title="Patch a binary" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>Now, when we go to our patched binary at the same address, we always get the <code class="language-plaintext highlighter-rouge">je</code> instruction even if we reload the program:</p> <figure> <picture> <img src="/assets/img/images/thm_dynamic_analysis_debugging/S1f3ZPgp0.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="Patched program" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <h3 id="question">Question</h3> <p><strong>What is it called when a binary’s assembly code is permanently altered to get the desired execution path?</strong></p> <p><em>Answer: <code class="language-plaintext highlighter-rouge">Patching</code></em></p> <h2 id="task-7---conclusion">Task 7 - Conclusion</h2> <p>That was it for this room. In this room, we learned the following:</p> <ul> <li>Common techniques to evade static and basic dynamic malware analysis.</li> <li>The use of debuggers for deeper analysis of malware.</li> <li>Using debuggers for changing the environment at runtime.</li> <li>Using debuggers to patch malware samples.</li> </ul> <p>However, this is not covering all the techniques available. Malware authors also use many techniques to evade dynamic analysis and debugging.</p> <h2 id="references">References</h2> <p><a href="https://www.varonis.com/blog/how-to-use-x64dbg" rel="external nofollow noopener" target="_blank">https://www.varonis.com/blog/how-to-use-x64dbg</a> <a href="https://tryhackme.com/r/room/advanceddynamicanalysis" rel="external nofollow noopener" target="_blank">https://tryhackme.com/r/room/advanceddynamicanalysis</a></p> </div> </article> <br> <hr> <br> <ul class="list-disc pl-8"></ul> <h2 class="text-3xl font-semibold mb-4 mt-12">Enjoy Reading This Article?</h2> <p class="mb-2">Here are some more articles you might like to read next:</p> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/THM-Advanced-Static-Analysis/">THM Advanced Static Analysis</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/THM-Anti-Reverse-Engineering/">THM Anti-Reverse Engineering</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/THM-Basic-Dynamic-Analysis/">THM Basic Dynamic Analysis</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/THM-MalDoc-Static-Analysis/">THM MalDoc: Static Analysis</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/THM-Windows-Forensics-1/">THM Windows Forensics 1</a> </li> </div> </div> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2025 NonoHM . Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script defer src="/assets/js/bootstrap-toc.min.js?c82ff4de8b0955d6ff14f5b05eed7eb6"></script> <script src="/assets/js/no_defer.js?2930004b8d7fcd0a8e00fdcfc8fc9f24"></script> <script defer src="/assets/js/common.js?da39b660470d1ba6e6b8bf5f37070b6e"></script> <script defer src="/assets/js/copy_code.js?12775fdf7f95e901d7119054556e495f" type="text/javascript"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>