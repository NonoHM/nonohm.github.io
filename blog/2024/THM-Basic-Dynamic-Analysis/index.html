<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> THM Basic Dynamic Analysis | NonoHM </title> <meta name="author" content="NonoHM "> <meta name="description" content="Welcome to my personnal website. I am currently a 2nd year student in the " but r et t program. i like doing sports and music besides learning new things in it.> <meta name="keywords" content="jekyll, jekyll-theme, portfolio-website, writeups, projects"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link defer href="/assets/css/bootstrap-toc.min.css?6f5af0bb9aab25d79b2448143cbeaa88" rel="stylesheet"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://nonohm.github.io/blog/2024/THM-Basic-Dynamic-Analysis/"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js?0afe9f0ae161375728f7bcc5eb5b4ab4"></script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> NonoHM </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item "> <a class="nav-link" href="/blog/">blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">projects </a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">repositories </a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fa-solid fa-moon"></i> <i class="fa-solid fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="row"> <div class="col-sm-3"> <nav id="toc-sidebar" class="sticky-top"></nav> </div> <div class="col-sm-9"> <div class="post"> <header class="post-header"> <h1 class="post-title">THM Basic Dynamic Analysis</h1> <p class="post-meta"> July 24, 2024 • NonoHM </p> <p class="post-tags"> <a href="/blog/2024"> <i class="fa-solid fa-calendar fa-sm"></i> 2024 </a>   ·   <a href="/blog/tag/thm"> <i class="fa-solid fa-hashtag fa-sm"></i> THM</a>   <a href="/blog/tag/malware-analysis"> <i class="fa-solid fa-hashtag fa-sm"></i> Malware Analysis</a>   <a href="/blog/tag/re"> <i class="fa-solid fa-hashtag fa-sm"></i> RE</a>   <a href="/blog/tag/dynamic-analysis"> <i class="fa-solid fa-hashtag fa-sm"></i> Dynamic Analysis</a>   </p> </header> <article class="post-content"> <div id="markdown-content"> <h2 id="task-1---introduction">Task 1 - Introduction</h2> <p>Previously, we learned techniques to analyze malware without executing it in the Basic Static Analysis room. As we have seen, malwares can use techniques to hide its features from a malware analyst. However, their purpose is to execute, thus traces are left behind when a malware is executed, which can give us some indications about the functions it is using. We will use basic dynamic analysis techniques here to analyze them.</p> <h3 id="learning-objectives">Learning Objectives</h3> <p>In this room, we will learn about:</p> <ul> <li>Sandboxing and using a sandbox for malware analysis</li> <li>The components of a sandbox how to create one ourselves</li> <li>Using ProcMon to monitor a process’ activity</li> <li>Using API LOgger and API Monitor to identify API calls made by malware</li> <li>Using ProcExp to identify if a process is modified maliciously</li> <li>Using Regshot to track registry changes made by malware</li> </ul> <h3 id="pre-requisties">Pre-requisties</h3> <p>Before starting this room, it is recommended to complete the following room for a better understanding:</p> <ul> <li><a href="https://tryhackme.com/room/windowsapi" rel="external nofollow noopener" target="_blank">Introduction to Windows API</a></li> <li><a href="https://tryhackme.com/room/windowsinternals" rel="external nofollow noopener" target="_blank">Windows Internals</a></li> <li><a href="https://tryhackme.com/room/intromalwareanalysis" rel="external nofollow noopener" target="_blank">Intro to Malware Analysis</a></li> <li><a href="https://tryhackme.com/room/staticanalysis1" rel="external nofollow noopener" target="_blank">Basic Static Analysis</a></li> </ul> <h2 id="task-2---sandboxing">Task 2 - Sandboxing</h2> <p>In all the malware anlysis rooms, it has been emphasized that malware sould only be analyzed in a controlled environment, ideally a VM. However, this becomes increasingly important for the dynamic analysis of malware.</p> <p>So, what is required to create a sandbox ?</p> <ol> <li>An isolated machine, ideally a Virtual Machine that is not connected to live/production systems and is dedicated to malware analysis</li> <li>The ability for the machine to save its initial state and revert to it once the malware analysis is complete like snapshots.</li> <li>Monitoring tools that help us analyze the malware whil it is executing. These can be automated as we see in automated sandboxes or manual, requiring the anayst to interact while performing analysis.</li> <li>A file-sharing mechanism that is used to introduce the malware into the environment and sends the analysis data/report to us. Often, shared directories or network drives are used but must be unmounted when executing the malware, especially for ransomwares.</li> </ol> <h3 id="virtualization">Virtualization</h3> <p>A lot of tools are available for virtualization. The main ones are:</p> <ul> <li>Oracle’s VirtualBox (free)</li> <li>VMWare’s Workstation (paid)</li> </ul> <p>VMWare Player is not suited for sandboxing because it can not create snapshots, which is a critical requirement for dynamic analysis.</p> <p>Apart from these, server-based virtualization software like WenServer, QEmu, ESXi… help with virtualization on a dedicated server. This type of setup is often used by enterprises for their virtualization needs and security reaserch organizations often use similar technologies to create a VM farm for large-scale virtualization.</p> <p>The VM’s OS needs to be the same as the malware’ target OS for dynamic analysis. In most scenarios, this will be Windows, and we will be covering tools related to Windows in this room.</p> <h3 id="analysis-tools">Analysis Tools</h3> <p>Once we have a VM, we need some analysis tools. It is possible to use packages made for RE like <a href="https://github.com/mandiant/flare-vm" rel="external nofollow noopener" target="_blank">Flare VM</a> or <a href="https://remnux.org/" rel="external nofollow noopener" target="_blank">REMnux</a>. Automated malware analysis systems have some built-in tools that analyze malware behaviour, like in <a href="https://cuckoosandbox.org/" rel="external nofollow noopener" target="_blank">Cuckoo sandbox</a> with <em>cuckoomon</em>. When all tools are installed, it is a must to take snapshot. It will ensure we have a clean state that we can revert and ensure our analysis is not contaminated by different malware samples running simultaneously.</p> <h3 id="file-sharing">File-sharing</h3> <p>Different platforms provide different options for sharing file between host and guest OS. In the most popular tools like <em>VirtualBox</em> or <em>VMWare Workstation</em>, the following options are common:</p> <ul> <li>Shared folder</li> <li>Create an iso and mounting it to the VM</li> <li>Clipboard copy and paste</li> </ul> <p>Apart from these, running a web server on the guest where malware samples can be uploaded or mounting a removable drive to the VM is possible. Note that the more isolated the option to share files is, the safer it will be for the host OS. apart for sharing malware, this option is also used to extract analysis reports from the VM.</p> <h3 id="question">Question</h3> <p><strong>If an analyst wants to analyze Linux malware, what OS should their sandbox’s Virtual Machine have?</strong></p> <p><em>Answer: <code class="language-plaintext highlighter-rouge">linux</code></em></p> <h2 id="task-3---procmon">Task 3 - ProcMon</h2> <p>In this task, we will learn how to use <strong>Process Monitor</strong>, or ProcMon to analyze malwares’ activities. ProcMon is a part of the Sysinternals suite, a set of utilities that provides advanced funcitonalities for Windows. They are widely used in security research and we will cover some of them in this room.</p> <p>Once <em>procmon.exe</em> is launched, the following window will apear:</p> <figure> <picture> <img src="/assets/img/images/thm_basic_dynamic_analysis/HkXprZUtR.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="ProcMon Window" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <ol> <li>Shows the <em>Open</em> and <em>Save</em> options. These options are for opening a file that contains ProcMon events or saving the events to a supported file.</li> <li>Shows the <em>Clear</em> option to clear all the events currently being shown by ProcMon. It is good to clear the events once we execute a malware sample of interest to reduce noise.</li> <li>Shows the <em>Filter</em> option to have further control over the events shown in the window.</li> <li>These are the toggle buttons to turn on/off <em>Registry, FileSystem, Network, Process/Thread and Profiling</em> events.</li> </ol> <p>Below these conrtols, we can ee from the left to the right the <em>Time, Process, Process ID (PID), Event Name, Path, Result and Details</em> of the activity. Events are shown in chronological order and ProcMon will show an overwhelming number of events occuring on the system by monitoring every system activity. That is why filtering is important for ease of analysis.</p> <h3 id="filtering-events">Filtering Events</h3> <p>An easy way of filtering events is to filter from the events window itself.</p> <figure> <picture> <img src="/assets/img/images/thm_basic_dynamic_analysis/HJHXYZIYA.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="ProcMon Filtering Events" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>By right clicking on the <em>Process Name</em> column of the process of our choice, a pop-up menu appears and some options are related to filtering. If we choose <code class="language-plaintext highlighter-rouge">Include 'Explorer.EXE'</code>, ProcMon will only show events with <em>Process Name</em> Explorer.exe. The opposite is available for <code class="language-plaintext highlighter-rouge">Exclude Explorer.EXE</code>; it will exclude Explorer.exe from the results.</p> <p>Similarly, we can filter other options by right-clicking on the corresponding columns (PID, Operation, Path…).</p> <h3 id="advanced-filtering">Advanced Filtering</h3> <p>Advanced filters are available on the menu marked as 3 on the above screenshot. When clicking on this, we will se the following pop-up:</p> <figure> <picture> <img src="/assets/img/images/thm_basic_dynamic_analysis/HkdZtWIKA.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="ProcMon Advanced Filtering" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>We can see some preset filters are already applied for filtering out some of the tools from the Sysinternals Suite. Furthermore, filtering is quite simple to implement; we select filtering values like <em>Process Name</em>, its relation, value and action. If the checkbox is ticked, the filter is applied, otherwise it is not.</p> <h3 id="process-tree">Process Tree</h3> <figure> <picture> <img src="/assets/img/images/thm_basic_dynamic_analysis/BkxyE4UKR.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="pt icon" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <figure> <picture> <img src="/assets/img/images/thm_basic_dynamic_analysis/SkqxVELKA.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="Process Tree" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <h3 id="questions">Questions</h3> <p><strong>Monitor the sample <code class="language-plaintext highlighter-rouge">~Desktop\Samples\1.exe</code> using ProcMon. This sample makes a few network connections. What is the first URL on which a network connection is made?</strong></p> <figure> <picture> <img src="/assets/img/images/thm_basic_dynamic_analysis/rJJrKVUFC.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="1.exe Filters" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>Here, we are using filters for the Process Name and the Event Class to only filter the sample <em>1.exe</em> and the network connection the malware wants to make.</p> <figure> <picture> <img src="/assets/img/images/thm_basic_dynamic_analysis/ByHGtV8tR.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="1.exe Network Events" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p><em>Answer: <code class="language-plaintext highlighter-rouge">94-73-155-12.cizgi.net.tr:2448</code></em></p> <p><strong>What network operation is performed on the above-mentioned URL?</strong></p> <p><em>Answer: <code class="language-plaintext highlighter-rouge">TCP Reconnect</code></em></p> <p><strong>What is the name with the complete full path of the first process created by this sample?</strong></p> <p><em>Answer: <code class="language-plaintext highlighter-rouge">C:\Users\Administrator\Desktop\samples\1.exe</code></em></p> <h2 id="task-4---api-logger-and-api-monitor">Task 4 - API Logger and API Monitor</h2> <p>The Windows OS abstracts the hardware interaction to the user by providing an Application Programmable Interface (API) for performing all tasks. For example, there is an API to create files, another to create process, and so on. Therefore, one way to identify malware behaviour is to monitor which API calls a malware do. While API’s names are generally self-exlpanatory, <a href="https://learn.microsoft.com/en-us/windows/win32/api/" rel="external nofollow noopener" target="_blank">MSDN Documentation</a> can be referred for finding more information.</p> <p>In this task, we will learn more about API logger and API monitor which can help us identify what API calls malware is making.</p> <h3 id="api-logger">API Logger</h3> <p><strong>API Logger</strong> is a simple tool that provides basic information about APIs called by a process. The main window is depicted below:</p> <figure> <picture> <img src="/assets/img/images/thm_basic_dynamic_analysis/ry1-Qw8FA.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="API Logger Window" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>To open a new process, we can provide the path of the executable or search for it using the three-dot menu.<br> Moreover, an existing process can be monitored by providing its PID. The following window will appear:</p> <figure> <picture> <img src="/assets/img/images/thm_basic_dynamic_analysis/ry9HEDUt0.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="API Logger PID" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>Once this is done, we can click <em>Inject &amp; Log</em> to start the API logging process. API calls are logged on the lower pane and running processes on the upper one.</p> <h3 id="api-monitor">API Monitor</h3> <p><strong>API Monitor</strong> provides more advanced information about a process’s API calls. It has a 32-bit and 64-bit version for each architecture of a process respectively. When API Monitor is open, we see the following window:</p> <figure> <picture> <img src="/assets/img/images/thm_basic_dynamic_analysis/B1Jzrv8F0.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="API Monitor Window" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>As we can see, API Monitor has multiple tabs, as numbered in the image above:</p> <ol> <li>This tab is a filter for the API group we want to monitor. For example, there is <em>Graphics and Gaming</em> related APIs, another one for <em>Internet</em>…</li> <li>This tab shows the processes being monitored for API calls. <em>Monitor New Process</em> option start monitoring a new process.</li> <li>This tab shows the <em>API call</em>, the <em>Module</em>, the <em>Thread</em>, <em>Time</em>, <em>Return Value</em> and any errors. We can monitor this tab for APIs called by a process.</li> <li>This tab show processes that can be monitored.</li> <li>This tab shows the <em>Parameters</em> of the API call, including those before and after the API processing.</li> <li>This tab show the Hex buffer of the selected value.</li> <li>This tab shows the Call Stack of the process.</li> <li>This tab shows the ouput.</li> </ol> <p>To understand it better, let’s open a new process. This is what we get when we use the <em>Monitor New Process</em> option in tab 2:</p> <figure> <picture> <img src="/assets/img/images/thm_basic_dynamic_analysis/B1QbFvUFA.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="API Monitor New Process" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>In this menu, we can select the process from a path, any arguments the process takes, the directory from where we want to start the process and the method for attaching API Monitor. Most of the time we can ignore the <em>Arguments</em> and <em>Start</em> option.</p> <p>Once we open a process, we see the tabs populate as seen below:</p> <figure> <picture> <img src="/assets/img/images/thm_basic_dynamic_analysis/Byf_3DLtR.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="API Monitor Running" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <ul> <li>In tab 1, we see the API filtering selecting all values to monitor all API calls.</li> <li>In tab 2, we see the path of the process we are monitoring.</li> <li>In tab 3, we see a summary of the API calls. The highlighted API call is <code class="language-plaintext highlighter-rouge">RegOpenKeyExW</code>. Hence we know that the process tried to open a registry key and the result is an error which can be interpreted as <em>registry key not found</em>.</li> <li>Tab 5 show tje parameters of the API call from before and after the API call was made.</li> <li>Tab 6 show the selected value in hex.</li> <li>Tab 7 show the Call Stack of the process.</li> </ul> <p>We see that <strong>API Monitor</strong> provides us with much more information about API calls by a process than <strong>API Logger</strong>. However, we must slow down the analysis process to digest all this information. When analyzing malware, we can decide whether to use API Logger or API Monitor based on our needs.</p> <h3 id="questions-1">Questions</h3> <p><strong>The sample <code class="language-plaintext highlighter-rouge">~Desktop\samples\1.exe</code> creates a file in the <code class="language-plaintext highlighter-rouge">C:\</code> directory. What is the name with the full path of this file?</strong></p> <p>To start with, we are going to monitor this sample with APILogger beceause of it is more readable.</p> <figure> <picture> <img src="/assets/img/images/thm_basic_dynamic_analysis/Hyj67O8tC.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="API Logger 1.exe" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p><em>Answer: <code class="language-plaintext highlighter-rouge">C:\myapp.exe</code></em></p> <p><strong>What API is used to create this file?</strong></p> <p><em>Answer: <code class="language-plaintext highlighter-rouge">CreateFileA</code></em></p> <p><strong>In Question 1 of the previous task, we identified a URL to which a network connection was made. What API call was used to make this connection?</strong></p> <p>By looking a bit further on the logs, we can see the API calls made to create a connection with a unknown computer:</p> <figure> <picture> <img src="/assets/img/images/thm_basic_dynamic_analysis/Byt1ruUKC.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="Internet API Call" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p><em>Answer: <code class="language-plaintext highlighter-rouge">InternetConnectW</code></em></p> <p><strong>We noticed in the previous task that after some time, the sample’s activity slowed down such that there was not much being reported against the sample. Can you look at the API calls and see what API call might be responsible for it?</strong></p> <p>Futrthermore, we can also deduct a loop at the connection stage that is slowed down with <code class="language-plaintext highlighter-rouge">sleep()</code>.</p> <figure> <picture> <img src="/assets/img/images/thm_basic_dynamic_analysis/HJ19SuIFR.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="Connection loop" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p><em>Answer: <code class="language-plaintext highlighter-rouge">sleep</code></em></p> <h2 id="task-5---process-explorer">Task 5 - Process Explorer</h2> <p><strong>Process Explorer</strong> is another tools from the Sysinternals Suite. It can be considered as an advanced Windows Task Manager that can help us identify process hollowing and masquereading techniques.<br> This is what Process Explorer looks like:</p> <figure> <picture> <img src="/assets/img/images/thm_basic_dynamic_analysis/HJPxXTvKR.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="Process Explorer Window" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>The above screenshot shows all the different processes running in the system in a tree format. We can see their <em>CPU utilization, Memory usage, Process ID (PID), Description and Company Name</em>.<br> We can enable the lower pane view from the <em>View</em> menu to find more information about the selected process. When enabled, we get the following screenshot:</p> <figure> <picture> <img src="/assets/img/images/thm_basic_dynamic_analysis/rkjTXaPtR.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="Process Explorer View" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>On the lower pane, we can see details about the process, such as:</p> <ul> <li> <strong>Handles</strong>: References to various system ressources the process is using like threads, files, <a href="https://www.techtarget.com/searchnetworking/definition/mutex" rel="external nofollow noopener" target="_blank">mutexes</a> (mutual exclusions used to manage concurent access to ressources), <a href="https://learn.microsoft.com/en-us/windows/win32/sync/semaphore-objects" rel="external nofollow noopener" target="_blank">semaphores</a> (signaling between threads) or sections (memory sections or shared memory)…</li> <li> <strong>DLLs</strong>: Imported DLLs used by the process</li> <li> <strong>Threads</strong>: Part of a program that runs tasks at the same time as other parts.</li> </ul> <p>By informing us about the ressources being used in the process, if a new process or thread in another process is opened by a process, it can indicate code injection into that process.</p> <p>For more details about a selected process, we can look at the properties of the process. We can do that by right-clicking the process name in the process tree and selecting <em>Properties</em>. We should see something like this:</p> <figure> <picture> <img src="/assets/img/images/thm_basic_dynamic_analysis/Bk3BDpvt0.png" class="img-fluid rounded z-depth-1" width="70%" height="auto" title="Process Explorer 3.exe Properties" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <h3 id="process-masquereading">Process Masquereading</h3> <p>As seen in the above screenshot, the properties function show us a lot of information about a process in different tabs. Malware authors sometimes use process names similar to Windows legit ones or commonly used software to hide from an analyst’s prying eyes. The <em>Image</em> tab helps an analyst defeat this technique by clicking on the <em>Verify</em> button on this tab to identify if the executable for the running process is signed by the relevant organization, which shall be Microsoft in the case of Windows binaries.<br> In this particular screenshot, we see the text <em>(No signature was present in the subject) Microsoft Corporation</em>, which means although the executable claims to be from Microsoft, it is not digitally signed by them and is spoofing a Microsoft process. This can be an indication of a malicious process.</p> <p>We must note that this verification only applies to the process’ image stored on the disk, hence a signed hollowed process migth still get a verified signature for that process. To identify hollowed process we have to look somewhere else.</p> <h3 id="process-hollowing">Process Hollowing</h3> <p>Another technique used by malware is Process Hollowing, that means the malware binary hollow an already running legitimate process by removing all its code from its virtual memory and inject malicious code instead. This way, an analyst should see a legitimate process that run the code of a malware author.</p> <p>To try to find this technique, we could use the <em>String</em> tab in a process’ properties like shown below:</p> <figure> <picture> <img src="/assets/img/images/thm_basic_dynamic_analysis/rJGli6wFA.png" class="rounded z-depth-1" width="70%" height="auto" title="5.exe Process Strings" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>At the bottom of the screenshot, we can choose <em>Image</em> and <em>Memory</em> options.</p> <ul> <li> <strong>Image</strong>: Shows strings present in the disk image of the process.</li> <li> <strong>Memory</strong>: Show strings extracted from the process’ memory.</li> </ul> <p>Normally, strings contained in the image should be the same as the process located in memory. However, we should see a significant difference between these two in an hollowed process.</p> <h3 id="questions-2">Questions</h3> <p><strong>What is the name of the first Mutex created by the sample <code class="language-plaintext highlighter-rouge">~Desktop\samples\1.exe?</code> If there are numbers in the name of the Mutex, replace them with X.</strong></p> <p>Firstly, we need to open the lower pane and <em>Handles</em> tab after executing the binary. By scrolling down a bit, it shows the different mutexes:</p> <figure> <picture> <img src="/assets/img/images/thm_basic_dynamic_analysis/Ske5haDt0.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="1.exe handles mutexes" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p><em>Answer: <code class="language-plaintext highlighter-rouge">\Sessions\X\BaseNamedObjects\SMX:XXXX:XXX:WilStaging_XX</code></em></p> <p><strong>Is the file signed by a known organization? Answer with Y for Yes and N for No.</strong></p> <p>In order to check the signature, we will go into the <em>1.exe</em> properties:</p> <figure> <picture> <img src="/assets/img/images/thm_basic_dynamic_analysis/Hk78apvY0.png" class="img-fluid rounded z-depth-1" width="70%" height="auto" title="1.exe properties" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p><em>Answer: <code class="language-plaintext highlighter-rouge">N</code></em></p> <p><strong>Is the process in the memory the same as the process on disk? Answer with Y for Yes and N for No.</strong></p> <p>To check if the process is being hollowed out, we have to see the process’ strings:</p> <figure> <picture> <img src="/assets/img/images/thm_basic_dynamic_analysis/SkGe0pwFR.png" class="img-fluid rounded z-depth-1" width="70%" height="auto" title="1.exe strings image" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <figure> <picture> <img src="/assets/img/images/thm_basic_dynamic_analysis/S1D7CTPtC.png" class="img-fluid rounded z-depth-1" width="70%" height="auto" title="1.exe strings memory" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>As we see, the process might not being hollowed out but the binary file might be packed.</p> <p><em>Answer: <code class="language-plaintext highlighter-rouge">N</code></em></p> <h2 id="task-6---regshot">Task 6 - Regshot</h2> <p><strong>Regshot</strong> is a tool that identfies any changes to the registry (or filesystem we select). It is mainly used to identify what registry keys were created, deleted or modified during our dynamic analysis.<br> Regshot works by taking snapshots of the registry before and after the execution of malware to compare them and identify the differences between the two.</p> <p>When we execute Regshot, we see the following interface:</p> <figure> <picture> <img src="/assets/img/images/thm_basic_dynamic_analysis/S1MPulqFC.png" class="img-fluid rounded z-depth-1" width="50%" height="auto" title="Regshot Interface" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>In this simple interface, we can also scan for change in the filsystem if we select the scan <em>dir1</em> option. However, only registry changes will be covered here.<br> To start, we can click on <em>1st shot</em> option. It will ask us whether to <em>take a shot</em> or <em>take a shot and save</em>. Once the first shot is taken, we should see something like below:</p> <figure> <picture> <img src="/assets/img/images/thm_basic_dynamic_analysis/rkSPFl5KC.png" class="img-fluid rounded z-depth-1" width="55%" height="auto" title="Regshot 1st shot" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>Now we have saved a shot of the registry, we can execute the malware. Once the malware has been executed sucessfully, we take a <em>2nd shot</em>.</p> <figure> <picture> <img src="/assets/img/images/thm_basic_dynamic_analysis/BkuiqgcKR.png" class="img-fluid rounded z-depth-1" width="55%" height="auto" title="Regshot 2nd shot" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>Now, we should be able to compare and see significant changes done to the registry by the malware. Using the <em>Compare</em> button, a summary box should appear:</p> <figure> <picture> <img src="/assets/img/images/thm_basic_dynamic_analysis/SkmWox5KC.png" class="img-fluid rounded z-depth-1" width="60%" height="auto" title="Regshot Compare" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>While the summary show <em>Keys</em> and <em>Values</em> that were added, deleted and modified to the registry, it also show changes done to the Files and Folders. However, since we have not checked the <em>Scan dir1</em> option, zero changes appear. Changes would appear if this box was activated.<br> To save the results, we have to go to <em>Compare &gt; Output</em>. It provides <em>the date and time of the shots, the computer name, the username and regshot’s version</em>.</p> <figure> <picture> <img src="/assets/img/images/thm_basic_dynamic_analysis/S1SXhx5Y0.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="Regshot Output Comparison" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>Once advantage that Regshot enjoys over all tools discussed in this room is that it doesn’t need to be running when we execute the malware, by being able to save the shot before. Some malware can check all the running processes and shut down if any analysis tool is running like <em>ProcExp, Procmon or API Monitor</em>. They check for them before running the rogue payload and quitting if these are found.<br> Its core mechanism makes it immune to detection evasion. However, we must ensure that no other processes is running in the background while perofrming analysis with regshot, as there is no filtering mechanism, like in the other tools. Hence, any noise created by background process will also be recorded by Regshot, resulting in False Positives.</p> <h3 id="question-1">Question</h3> <p><strong>Analyze the sample <code class="language-plaintext highlighter-rouge">~Desktop\Samples\3.exe</code> using Regshot. There is a registry value added that contains the path of the sample in the format *HKU\S-X-X-XX-XXXXXXXXXX-XXXXXXXXXX-XXXXXXXX-XXX*. What is the path of that value after the format mentioned here?</strong></p> <p>Firstly, we need to run regshot and take a 1st shot of our system state.</p> <figure> <picture> <img src="/assets/img/images/thm_basic_dynamic_analysis/S1XK0mqF0.png" class="img-fluid rounded z-depth-1" width="60%" height="auto" title="Regshot 1st shot" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>Then, we run the malware <code class="language-plaintext highlighter-rouge">3.exe</code>. We should be able to see it in <em>procexp</em> or <em>procmon</em> beceause it does not do some Evasion Detection.</p> <figure> <picture> <img src="/assets/img/images/thm_basic_dynamic_analysis/rkmjkEqKR.png" class="img-fluid rounded z-depth-1" width="70%" height="auto" title="Process Explorer 3.exe" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>After doing a second shot, we get a new summary window about it:</p> <figure> <picture> <img src="/assets/img/images/thm_basic_dynamic_analysis/ry2mgEcK0.png" class="img-fluid rounded z-depth-1" width="60%" height="auto" title="Regshot 2nd shot" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>Finally, we compare using the corresponding button and we check for the requested regkey starting with <em>HKU</em>:</p> <figure> <picture> <img src="/assets/img/images/thm_basic_dynamic_analysis/r1L92VqK0.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="3.exe reg path" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p><em>Answer: <code class="language-plaintext highlighter-rouge">Software\Microsoft\Windows NT\CurrentVersion\AppCompatFlags\Compatibility Assistant\Store\C:\Users\Administrator\Desktop\samples\3.exe</code></em></p> <h2 id="task-7---conclusion">Task 7 - Conclusion</h2> <p>To conclude, in this room we have learned how to monitor a proccess’ activites using ProcMon and filter out other process to focus on the process of our interest and how to identify what API calls a process is making ot identify the behaviour of the process. Moreover, we tried to figure out if a malware asmple is trying to evade detection by performing Process Masquerading or Process Hollowing using Process Explorer, and we identified changes in the registry made by malware using Regshot.<br> Furthermore, we must understand that malware analysis requires perseverance, persistance, and attention to details since malware authors will always try to twart an analyst’s efforts. What we have covered so far is not enough to analyze the most advanced malware, hence we will cover more advanced trick in <a href="https://tryhackme.com/r/room/advanceddynamicanalysis" rel="external nofollow noopener" target="_blank">Dynamic Analysis: Debugging</a>.</p> </div> </article> <br> <hr> <br> <ul class="list-disc pl-8"></ul> <h2 class="text-3xl font-semibold mb-4 mt-12">Enjoy Reading This Article?</h2> <p class="mb-2">Here are some more articles you might like to read next:</p> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/THM-Advanced-Static-Analysis/">THM Advanced Static Analysis</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/THM-Anti-Reverse-Engineering/">THM Anti-Reverse Engineering</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/THM-Dynamic-Analysis-Debugging/">THM Dynamic Analysis: Debugging</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/THM-MalDoc-Static-Analysis/">THM MalDoc: Static Analysis</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/THM-Windows-Forensics-1/">THM Windows Forensics 1</a> </li> </div> </div> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2025 NonoHM . Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script defer src="/assets/js/bootstrap-toc.min.js?c82ff4de8b0955d6ff14f5b05eed7eb6"></script> <script src="/assets/js/no_defer.js?2930004b8d7fcd0a8e00fdcfc8fc9f24"></script> <script defer src="/assets/js/common.js?da39b660470d1ba6e6b8bf5f37070b6e"></script> <script defer src="/assets/js/copy_code.js?12775fdf7f95e901d7119054556e495f" type="text/javascript"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>