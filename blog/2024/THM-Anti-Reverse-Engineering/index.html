<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> THM Anti-Reverse Engineering | NonoHM </title> <meta name="author" content="NonoHM "> <meta name="description" content="Welcome to my personnal website. I am currently a 2nd year student in the " but r et t program. i like doing sports and music besides learning new things in it.> <meta name="keywords" content="jekyll, jekyll-theme, portfolio-website, writeups, projects"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link defer href="/assets/css/bootstrap-toc.min.css?6f5af0bb9aab25d79b2448143cbeaa88" rel="stylesheet"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://nonohm.github.io/blog/2024/THM-Anti-Reverse-Engineering/"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js?0afe9f0ae161375728f7bcc5eb5b4ab4"></script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> NonoHM </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item "> <a class="nav-link" href="/blog/">blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">projects </a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">repositories </a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fa-solid fa-moon"></i> <i class="fa-solid fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="row"> <div class="col-sm-3"> <nav id="toc-sidebar" class="sticky-top"></nav> </div> <div class="col-sm-9"> <div class="post"> <header class="post-header"> <h1 class="post-title">THM Anti-Reverse Engineering</h1> <p class="post-meta"> September 18, 2024 • NonoHM </p> <p class="post-tags"> <a href="/blog/2024"> <i class="fa-solid fa-calendar fa-sm"></i> 2024 </a>   ·   <a href="/blog/tag/thm"> <i class="fa-solid fa-hashtag fa-sm"></i> THM</a>   <a href="/blog/tag/malware-analysis"> <i class="fa-solid fa-hashtag fa-sm"></i> Malware Analysis</a>   <a href="/blog/tag/re"> <i class="fa-solid fa-hashtag fa-sm"></i> RE</a>   <a href="/blog/tag/dynamic-analysis"> <i class="fa-solid fa-hashtag fa-sm"></i> Dynamic Analysis</a>   </p> </header> <article class="post-content"> <div id="markdown-content"> <h2 id="task-1---introduction">Task 1 - Introduction</h2> <p>To start with, malware authors are constantly looking to improve their malware by implementing new ways of evading detection. On the other hand, analysts are working on new methods to uncover these. This mouse and cat game lead to the development of increasingly sofisticated technique implementations and discover protocols.</p> <p>Reverse engineering is the process of studying a product, software or hardware, to understand how it works and extracting its functionalities and design. Here, in cybersecurity, RE (Reverse Engineering) is used on binaries to extract <a href="https://www.crowdstrike.com/cybersecurity-101/indicators-of-compromise/" rel="external nofollow noopener" target="_blank">Indicators of Compromise (IOC)</a> and develop adequate countermeasures.</p> <p>In this room, we will explore about some anti-reverse engineering techniques malware uses like:</p> <ul> <li>VM Detection</li> <li>Obfuscation using packers</li> <li>Anti-debugging</li> </ul> <h3 id="learning-objectives">Learning Objectives</h3> <ul> <li>Why malware authors use anti-reverse engineering techniques</li> <li>Learn about different anti-RE techniques</li> <li>How to circumvent these using various tools</li> <li>How they are implented by reading source code</li> </ul> <h3 id="prerequisties">Prerequisties</h3> <ul> <li>Familiarity with <a href="https://tryhackme.com/room/basicdynamicanalysis" rel="external nofollow noopener" target="_blank">Basic</a> / <a href="https://(https://tryhackme.com/room/advanceddynamicanalysis)" rel="external nofollow noopener" target="_blank">Advanced</a> Dynamic Analysis.</li> <li>Knowledge of <a href="https://tryhackme.com/room/x86assemblycrashcourse" rel="external nofollow noopener" target="_blank">assembly</a> (Registers, Stack, Operands…)</li> <li>Basic understating of C programming concepts</li> </ul> <h2 id="task-2---anti-debugging-overview">Task 2 - Anti-Debugging (Overview)</h2> <p>Debugging is the process of examining software in order to <strong>understand its inner workings</strong> and <strong>identify potential flaws and vulnerabilities</strong>. Consequently, this involves programs called debuggers, with most used ones nowadays are:</p> <ul> <li>X32/X64dbg</li> <li>Ollydbg</li> <li>IDA pro</li> <li>Ghidra</li> </ul> <p>Anti-debugging techniques used by malware authors are plentiful and below is a summary of many of them:</p> <table> <thead> <tr> <th><strong>Anti-Debugging Technique</strong></th> <th><strong>Explanation</strong></th> </tr> </thead> <tbody> <tr> <td><strong>API-Based Detection</strong></td> <td>Uses system APIs like <code class="language-plaintext highlighter-rouge">IsDebuggerPresent()</code> or <code class="language-plaintext highlighter-rouge">NtQueryInformationProcess()</code> to detect debuggers.</td> </tr> <tr> <td><strong>Timing Attacks</strong></td> <td>Measures execution time of instructions; delays indicate the presence of a debugger.</td> </tr> <tr> <td><strong>Breakpoint Detection</strong></td> <td>Scans for hardware and software breakpoints (e.g., <code class="language-plaintext highlighter-rouge">0xCC</code> opcode) set by debuggers.</td> </tr> <tr> <td><strong>Exception-Based Techniques</strong></td> <td>Exploits how debuggers handle exceptions (e.g., division by zero or single-step exceptions).</td> </tr> <tr> <td><strong>Self-Debugging</strong></td> <td>Malware debugs itself, preventing another debugger from attaching to the process.</td> </tr> <tr> <td><strong>PEB Manipulation</strong></td> <td>Checks <code class="language-plaintext highlighter-rouge">BeingDebugged</code> and <code class="language-plaintext highlighter-rouge">NtGlobalFlag</code> flags in the Process Environment Block for signs of debugging.</td> </tr> <tr> <td><strong>Anti-Attachment Techniques</strong></td> <td>Makes it difficult for debuggers to attach, often through process spawning or modifying debugger behavior.</td> </tr> <tr> <td><strong>Code Obfuscation</strong></td> <td>Obscures the code to prevent easy analysis, using opaque predicates, inline functions, or anti-disassembly.</td> </tr> <tr> <td><strong>Anti-VM Techniques</strong></td> <td>Detects virtual machines (common in malware analysis) using <code class="language-plaintext highlighter-rouge">CPUID</code>, hardware, or BIOS checks.</td> </tr> <tr> <td><strong>Thread Hiding Techniques</strong></td> <td>Uses <code class="language-plaintext highlighter-rouge">NtSetInformationThread()</code> to hide threads from the debugger.</td> </tr> <tr> <td><strong>Dynamic Code Loading</strong></td> <td>Loads or decrypts code only at runtime, preventing static analysis and debugging.</td> </tr> <tr> <td><strong>Process Forking</strong></td> <td>Spawns child processes and transfers execution, leaving the debugger attached to the inactive parent process.</td> </tr> <tr> <td><strong>Kernel Debugger Detection</strong></td> <td>Checks for kernel-level debugging using flags like <code class="language-plaintext highlighter-rouge">KdDebuggerEnabled</code> or special I/O control queries.</td> </tr> <tr> <td><strong>Deliberate Crashes</strong></td> <td>Intentionally crashes or corrupts memory to disrupt debugger operation and analysis.</td> </tr> <tr> <td><strong>Stack Frame Manipulation</strong></td> <td>Alters or destroys stack frames to confuse the debugger and make execution tracing difficult.</td> </tr> <tr> <td><strong>Anti-Step Techniques</strong></td> <td>Confuses debugger step commands by injecting or redirecting code execution to non-linear addresses. It modifies the program flow of itself while runnning.</td> </tr> </tbody> </table> <h3 id="questions">Questions</h3> <p><strong>What is the name of the Windows API function used in a common anti-debugging technique that detects if a debugger is running?</strong></p> <p><em>Answer: <code class="language-plaintext highlighter-rouge">IsDebuggerPresent</code></em></p> <h2 id="task-3---anti-debugging-using-suspend-thread">Task 3 - Anti-Debugging using Suspend Thread</h2> <p><a href="https://learn.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-suspendthread" rel="external nofollow noopener" target="_blank">SuspendThread</a> is a Windows API function used to pause the execution of a thread in a running process. Besides its main purpose, a malware process uses this function to suspend itself if it recognizes being debugged.</p> <p>The provided code snippet in this room to conceptualize the idea of suspending the thread if a debugger is found is the following:</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;windows.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;wchar.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;tlhelp32.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span>
<span class="n">DWORD</span> <span class="n">g_dwDebuggerProcessId</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

<span class="n">BOOL</span> <span class="n">CALLBACK</span> <span class="nf">EnumWindowsProc</span><span class="p">(</span><span class="n">HWND</span> <span class="n">hwnd</span><span class="p">,</span> <span class="n">LPARAM</span> <span class="n">dwProcessId</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">DWORD</span> <span class="n">dwWindowProcessId</span><span class="p">;</span>
    <span class="n">GetWindowThreadProcessId</span><span class="p">(</span><span class="n">hwnd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dwWindowProcessId</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">dwProcessId</span> <span class="o">==</span> <span class="n">dwWindowProcessId</span><span class="p">)</span>
    <span class="p">{</span>
  <span class="kt">int</span> <span class="n">windowTitleSize</span> <span class="o">=</span> <span class="n">GetWindowTextLengthW</span><span class="p">(</span><span class="n">hwnd</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">windowTitleSize</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="p">)</span>
  <span class="p">{</span>
   <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kt">wchar_t</span><span class="o">*</span> <span class="n">windowTitle</span> <span class="o">=</span> <span class="p">(</span><span class="kt">wchar_t</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">((</span><span class="n">windowTitleSize</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">wchar_t</span><span class="p">));</span>
  
        <span class="n">GetWindowTextW</span><span class="p">(</span><span class="n">hwnd</span><span class="p">,</span> <span class="n">windowTitle</span><span class="p">,</span> <span class="n">windowTitleSize</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">wcsstr</span><span class="p">(</span><span class="n">windowTitle</span><span class="p">,</span> <span class="s">L"dbg"</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span>
   <span class="n">wcsstr</span><span class="p">(</span><span class="n">windowTitle</span><span class="p">,</span> <span class="s">L"debugger"</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span>
  <span class="p">{</span>
            <span class="n">g_dwDebuggerProcessId</span> <span class="o">=</span> <span class="n">dwProcessId</span><span class="p">;</span>
   <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
  <span class="p">}</span>
 
       <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">DWORD</span> <span class="nf">IsDebuggerProcess</span><span class="p">(</span><span class="n">DWORD</span> <span class="n">dwProcessId</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">EnumWindows</span><span class="p">(</span><span class="n">EnumWindowsProc</span><span class="p">,</span> <span class="p">(</span><span class="n">LPARAM</span><span class="p">)</span><span class="n">dwProcessId</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">g_dwDebuggerProcessId</span> <span class="o">==</span> <span class="n">dwProcessId</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">DWORD</span> <span class="nf">SuspendDebuggerThread</span><span class="p">()</span>
<span class="p">{</span>
 <span class="n">HANDLE</span> <span class="n">hSnapshot</span> <span class="o">=</span> <span class="n">CreateToolhelp32Snapshot</span><span class="p">(</span><span class="n">TH32CS_SNAPTHREAD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">hSnapshot</span> <span class="o">==</span> <span class="n">INVALID_HANDLE_VALUE</span><span class="p">)</span>
 <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Failed to create snapshot</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">THREADENTRY32</span> <span class="n">te32</span><span class="p">;</span>
    <span class="n">te32</span><span class="p">.</span><span class="n">dwSize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">THREADENTRY32</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">Thread32First</span><span class="p">(</span><span class="n">hSnapshot</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">te32</span><span class="p">))</span>
 <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Failed to get first thread</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="n">CloseHandle</span><span class="p">(</span><span class="n">hSnapshot</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">do</span>
 <span class="p">{</span>
        <span class="n">HANDLE</span> <span class="n">hThread</span> <span class="o">=</span> <span class="n">OpenThread</span><span class="p">(</span><span class="n">THREAD_QUERY_INFORMATION</span> <span class="o">|</span> <span class="n">THREAD_SUSPEND_RESUME</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">te32</span><span class="p">.</span><span class="n">th32ThreadID</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">hThread</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
  <span class="p">{</span>
            <span class="n">DWORD</span> <span class="n">dwProcessId</span> <span class="o">=</span> <span class="n">GetProcessIdOfThread</span><span class="p">(</span><span class="n">hThread</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span> <span class="n">IsDebuggerProcess</span><span class="p">(</span><span class="n">dwProcessId</span><span class="p">)</span> <span class="p">)</span>
   <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Debugger found with pid %i! Suspending!</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">dwProcessId</span><span class="p">);</span>
    <span class="n">DWORD</span> <span class="n">result</span> <span class="o">=</span> <span class="n">SuspendThread</span><span class="p">(</span><span class="n">hThread</span><span class="p">);</span>
     <span class="k">if</span> <span class="p">(</span> <span class="n">result</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="p">)</span>
    <span class="p">{</span>
     <span class="n">printf</span><span class="p">(</span><span class="s">"Last error: %i</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
    <span class="p">}</span>
   <span class="p">}</span>
            <span class="n">CloseHandle</span><span class="p">(</span><span class="n">hThread</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">Thread32Next</span><span class="p">(</span><span class="n">hSnapshot</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">te32</span><span class="p">));</span>

    <span class="n">CloseHandle</span><span class="p">(</span><span class="n">hSnapshot</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
 <span class="n">SuspendDebuggerThread</span><span class="p">();</span>

 <span class="n">printf</span><span class="p">(</span><span class="s">"Continuing malicious operation..."</span><span class="p">);</span>
 <span class="n">getchar</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div> <p>In short, this source code would be doing this when running:</p> <ul> <li>It enumerates every thread in the Windows system</li> <li>For each thread, it uses <a href="https://learn.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-enumwindows" rel="external nofollow noopener" target="_blank">EnumWindow</a> to get their window title.</li> <li>If one of these has <code class="language-plaintext highlighter-rouge">debugger</code> or <code class="language-plaintext highlighter-rouge">dbg</code> in their title, the malware knows a debugger is running.</li> <li>When the debugger has been discovered, the malware calls <code class="language-plaintext highlighter-rouge">SuspendThread</code> to stop the debugger from running, which makes it crash.</li> <li>Therefore, the malware continues its activity.</li> </ul> <h3 id="patching">Patching</h3> <p>Pathcing is one of most critical skill required by an analyst. It lets us change the behavior of the binary by changing its instructions.</p> <p>On the program called <code class="language-plaintext highlighter-rouge">suspend-thread.exe</code>, based on the code snippet available above, we will patch the debugger-checking technique to bypass it using x32dbg.</p> <p>To begin with, we will use the <em>run</em> button or <code class="language-plaintext highlighter-rouge">F9</code> to get to the entry point.</p> <figure> <picture> <img src="/assets/img/images/thm_anti-reverse_engineering/rkQj97xRA.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="suspend-thread entry point" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>Then, we can <em>Right click -&gt; Search for -&gt; This module -&gt; Intermodular Calls</em>. This will redirect us to the call made by the program.</p> <figure> <picture> <img src="/assets/img/images/thm_anti-reverse_engineering/rkPnsmgRA.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="Search for SuspendThread() 1" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>If we would go to <em>Symbols -&gt; Click on “suspend-thread.exe” -&gt; Search “SuspendThread”</em>, we would be redirected to where the function really is.</p> <figure> <picture> <img src="/assets/img/images/thm_anti-reverse_engineering/rJe_ome0A.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="Search for SuspendThread() 2" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>After doing the first trick, we remove the function call by filling the function with NOPs (<em>No Operation</em> opcode) by doing <em>Right click on the operation -&gt; Binary -&gt; Fill with NOPs</em>. The hex value for opcode <code class="language-plaintext highlighter-rouge">nop</code> is <code class="language-plaintext highlighter-rouge">90</code>.</p> <figure> <picture> <img src="/assets/img/images/thm_anti-reverse_engineering/SyR707xAC.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="Filling SuspendThread() call with NOPs" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>Subsequently, in order to apply our patch forever on the binary, we may click on <em>File -&gt; Patch file</em> or <code class="language-plaintext highlighter-rouge">Ctrl+P</code>. Then we click on <em>Patch file</em> and save the program.</p> <figure> <picture> <img src="/assets/img/images/thm_anti-reverse_engineering/BJ4HyVl0R.png" class="img-fluid rounded z-depth-1" width="70%" height="auto" title="Patching file" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>Now, if we run the program, we will get the <em>“Debugger found with PID XXXX! Suspending!”</em> message. However, it won’t suspend the thread as we erased the <code class="language-plaintext highlighter-rouge">SuspendThread()</code> call.</p> <figure> <picture> <img src="/assets/img/images/thm_anti-reverse_engineering/H1Gx-NlR0.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="Suspending bypassed" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <h3 id="questions-1">Questions</h3> <p><strong>What is the Windows API function that enumerates windows on the screen so the malware can check the window name?</strong></p> <p><em>Answer: <code class="language-plaintext highlighter-rouge">EnumWindows</code></em></p> <p><strong>What is the hex value of a nop instruction?</strong></p> <p><em>Answer: <code class="language-plaintext highlighter-rouge">90</code></em></p> <p><strong>What is the instruction found at memory location <code class="language-plaintext highlighter-rouge">004011CB</code>?</strong></p> <p>On x32dbg, do <em>Right click -&gt; Go to -&gt; Expression</em> or hit <em>Ctrl+G</em>, then write the memory address.</p> <p><em>Answer: <code class="language-plaintext highlighter-rouge">add esp,8</code></em></p> <h2 id="task-4---vm-detection-overview">Task 4 - VM Detection (Overview)</h2> <p>Virtual Machines are software platforms that emulates a computer environment inside another computer. These are useful in reverse engineering because they provide a cost-effective, controlled and isolated environment for monitoring and analyzing suspicious software or malware. They also allow the creation of snapshots/checkpoints that can be used to restore the system to a previous state, which helps test different scenarios and maintain an history of the analysis process.</p> <p>When malware identifies that it is running on a VM, it may decide to respond differently, for example:</p> <ul> <li>Executing a minimal subset of its functionnality</li> <li>Self-destructing or code parts overwriting</li> <li>Cause damage to the system</li> <li>Not run at all</li> </ul> <h3 id="detection-techniques">Detection Techniques</h3> <p>Malware can employ various techniques to detect a Vm environment such as:</p> <table> <thead> <tr> <th>Detection Technique</th> <th>Explanation</th> </tr> </thead> <tbody> <tr> <td>Checking running processes</td> <td>VMs have easily identifiable processes; for example, VMWare runs a process called <code class="language-plaintext highlighter-rouge">vmtools</code>, while VirtualBox has <code class="language-plaintext highlighter-rouge">vboxservice</code>. Malware can use the EnumProcess Windows API to list all the processes running on the machine and look for the presence of these tools.</td> </tr> <tr> <td>Checking installed software</td> <td>Malware can look in the Windows Registry for a list of installed software under the <code class="language-plaintext highlighter-rouge">SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Uninstall</code> Registry key. From here, it can check for installed programs like debuggers, decompilers, forensics tools, etc.</td> </tr> <tr> <td>Network fingerprinting</td> <td>Malware can look for specific MAC and network addresses unique to VMs. For example, VMs autogenerate MAC addresses that start with any of the following numbers: <em>00-05-69</em>, <em>00-0c-29</em>, <em>00-1c-14</em> or <em>00-50-56</em>. These numbers are unique and are specifically assigned to a VM vendor called the OUI (Organizationally Unique Identifier).</td> </tr> <tr> <td>Checking machine resources</td> <td>Malware can look at a machine’s resources like RAM and CPU Utilization percentages. For example, a machine with RAM amounting to less than 8GB can indicate a virtual machine, as they are typically not assigned a significant amount.</td> </tr> <tr> <td>Detecting peripherals</td> <td>Some malware checks for connected printers because this is rarely configured properly on VMs, sometimes not even configured at all.</td> </tr> <tr> <td>Checking for domain membership</td> <td>Corporate networks are a usual target for malware. An easy way to determine this is by checking if the current machine is part of an Active Directory domain. This can quickly be done without the use of API calls by checking the LoggonServer and ComputerName environment variables.</td> </tr> <tr> <td>Timing-based attacks</td> <td>Malware can measure the time it takes to execute specific instructions or access particular machine resources. For example, some instructions can be faster on a physical machine compared to a virtual machine.</td> </tr> </tbody> </table> <h3 id="anti-vm-detection">Anti-VM Detection</h3> <p>To prevent malware using some of the techniques above, we can apply several cahnges that will remove VM-related artefacts. For example, registry entries or MAC Address modifications can bypass some of them, however, it can become tedious to protect us from everything.</p> <p>Some scripts or videos are available to help automate this process, which some are listed below:</p> <ul> <li><a href="https://www.youtube.com/watch?v=koWipFDgD6chttps://" rel="external nofollow noopener" target="_blank">Eric Parker’s video “Setting up an UNDETECTABLE VM for Malware analysis”</a></li> <li><a href="https://ludovic-coulon.com/blog/create-malware-analysis-environment/" rel="external nofollow noopener" target="_blank">Ludovic Coulon’s blog post based on Eric Parker’s Video</a></li> <li><a href="https://github.com/d4rksystem/VMwareCloak" rel="external nofollow noopener" target="_blank">VMWareCloak</a></li> <li><a href="https://github.com/d4rksystem/VBoxCloak" rel="external nofollow noopener" target="_blank">VBoxCloak</a></li> <li><a href="https://github.com/hzqst/VmwareHardenedLoader" rel="external nofollow noopener" target="_blank">VMWare-Hardened-Loader</a></li> </ul> <p>A known tool to test the efficiency of the anti-vm changes made is <a href="https://github.com/a0rtega/pafish" rel="external nofollow noopener" target="_blank">pafish</a>. It is a testing tool that uses different techniques to detect virtual machines and malware analysis environments in the same way that malware families do.</p> <h3 id="questions-2">Questions</h3> <p><strong>What is the name of the identifiable process used by malware to check if the machine is running inside VirtualBox?</strong></p> <p><em>Answer: <code class="language-plaintext highlighter-rouge">vboxservice</code></em></p> <p><strong>What is the OUI automatically assigned specifically to VMware?</strong></p> <p><em>Answer: <code class="language-plaintext highlighter-rouge">00:50:56</code></em></p> <p><strong>Using Task Manager, what process indicates that the machine for this room is an Amazon EC2 Virtual Machine?</strong></p> <p><em>Answer: <code class="language-plaintext highlighter-rouge">amazon-ssm-agent.exe</code></em></p> <h2 id="task-5---vm-detection-by-checking-the-temperature">Task 5 - VM Detection by Checking the Temperature</h2> <p><code class="language-plaintext highlighter-rouge">Win32_TempereatureProbe</code> is a Windows Management Instrumentation (WMI) class that conatins real-time temperature readings from the hardware through the SMBIOS (System Management BIOS) data structure. In a virutalized environment, the returned value is <code class="language-plaintext highlighter-rouge">Not Supported</code>, which is what malware looks for.</p> <p>WMI is a feature to gather detailed system information such as hardware configuration, OS status, installed software, network settings, running processes and more, which allows management and monitoring on both local and remote systems.</p> <blockquote> <p>Note: <code class="language-plaintext highlighter-rouge">Win32_TemperatureProbe</code> may also return <code class="language-plaintext highlighter-rouge">Not Supported</code> even on physical machines which doesn’t support the SMBIOS feature. This makes it unreliable but valuable when used with other techniques mentioned previously.</p> </blockquote> <p>The binary named <code class="language-plaintext highlighter-rouge">vm-detection.exe</code> behaves as proceeding with non-malicious activities when executed in a VM.</p> <figure> <picture> <img src="/assets/img/images/thm_anti-reverse_engineering/HybJTHxAC.png" class="img-fluid rounded z-depth-1" width="50%" height="auto" title="VM Detection detected" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>Thus, it proceeds with malicious ones when executed on a physical machine.</p> <figure> <picture> <img src="/assets/img/images/thm_anti-reverse_engineering/BkK-aHeAA.png" class="img-fluid rounded z-depth-1" width="50%" height="auto" title="VM Detection undetected" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>The code snippet is available below:</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;windows.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;wbemidl.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;combaseapi.h&gt;</span><span class="cp">
</span>
<span class="cp">#pragma comment(lib, "wbemuuid.lib")
#pragma comment(lib, "user32.lib")
#pragma comment(lib, "ole32.lib")
#pragma comment(lib, "oleaut32.lib")
</span>
<span class="n">BOOL</span> <span class="nf">hasThermalZoneTemp</span><span class="p">();</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
 <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">hasThermalZoneTemp</span><span class="p">()</span> <span class="p">)</span>
 <span class="p">{</span>
  <span class="n">MessageBox</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">"Proceeding with non-malicious activities..."</span><span class="p">,</span> <span class="s">"VM Detected"</span> <span class="p">,</span> <span class="n">MB_OK</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
 <span class="p">}</span>

 <span class="n">MessageBox</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">"Proceeding with malicious activities..."</span><span class="p">,</span> <span class="s">"Starting malware"</span><span class="p">,</span> <span class="n">MB_OK</span><span class="p">);</span>
 <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">BOOL</span> <span class="nf">hasThermalZoneTemp</span><span class="p">()</span>
<span class="p">{</span>
 <span class="n">IWbemLocator</span><span class="o">*</span> <span class="n">pLoc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
 <span class="n">IWbemServices</span><span class="o">*</span> <span class="n">pSvc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
 <span class="n">IEnumWbemClassObject</span><span class="o">*</span> <span class="n">pEnumerator</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
 <span class="n">IWbemClassObject</span><span class="o">*</span> <span class="n">pclsObj</span> <span class="o">=</span> <span class="p">(</span><span class="n">IWbemClassObject</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">IWbemClassObject</span><span class="p">));</span>
 
 <span class="n">ULONG</span> <span class="n">uReturn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

 <span class="n">HRESULT</span> <span class="n">hr</span> <span class="o">=</span> <span class="n">CoInitializeEx</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">COINIT_MULTITHREADED</span><span class="p">);</span>
 <span class="n">hr</span> <span class="o">=</span> <span class="n">CoInitializeSecurity</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">RPC_C_AUTHN_LEVEL_DEFAULT</span><span class="p">,</span> <span class="n">RPC_C_IMP_LEVEL_IMPERSONATE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">EOAC_NONE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
 <span class="n">hr</span> <span class="o">=</span> <span class="n">CoCreateInstance</span><span class="p">(</span><span class="n">CLSID_WbemLocator</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">CLSCTX_INPROC_SERVER</span><span class="p">,</span> <span class="n">IID_IWbemLocator</span><span class="p">,</span> <span class="p">(</span><span class="n">LPVOID</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pLoc</span><span class="p">);</span>
 <span class="n">hr</span> <span class="o">=</span> <span class="n">pLoc</span><span class="o">-&gt;</span><span class="n">ConnectServer</span><span class="p">(</span><span class="s">L"root</span><span class="se">\\</span><span class="s">wmi"</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pSvc</span><span class="p">);</span>
 <span class="n">hr</span> <span class="o">=</span> <span class="n">CoSetProxyBlanket</span><span class="p">(</span><span class="n">pSvc</span><span class="p">,</span> <span class="n">RPC_C_AUTHN_WINNT</span><span class="p">,</span> <span class="n">RPC_C_AUTHZ_NONE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">RPC_C_AUTHN_LEVEL_CALL</span><span class="p">,</span> <span class="n">RPC_C_IMP_LEVEL_IMPERSONATE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">EOAC_NONE</span><span class="p">);</span>
 <span class="n">hr</span> <span class="o">=</span> <span class="n">pSvc</span><span class="o">-&gt;</span><span class="n">ExecQuery</span><span class="p">(</span><span class="s">L"WQL"</span><span class="p">,</span> <span class="s">L"SELECT * FROM MSAcpi_ThermalZoneTemperature"</span><span class="p">,</span> <span class="n">WBEM_FLAG_FORWARD_ONLY</span> <span class="o">|</span> <span class="n">WBEM_FLAG_RETURN_IMMEDIATELY</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pEnumerator</span><span class="p">);</span>

 <span class="k">while</span> <span class="p">(</span><span class="n">pEnumerator</span><span class="p">)</span>
 <span class="p">{</span>
  <span class="n">hr</span> <span class="o">=</span> <span class="n">pEnumerator</span><span class="o">-&gt;</span><span class="n">Next</span><span class="p">(</span><span class="n">WBEM_INFINITE</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pclsObj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uReturn</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">uReturn</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
  <span class="p">{</span>
   <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">VARIANT</span> <span class="n">vtProp</span><span class="p">;</span>

  <span class="n">hr</span> <span class="o">=</span> <span class="n">pclsObj</span><span class="o">-&gt;</span><span class="n">Get</span><span class="p">(</span><span class="s">L"CurrentTemperature"</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vtProp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">SUCCEEDED</span><span class="p">(</span><span class="n">hr</span><span class="p">))</span>
  <span class="p">{</span>
   <span class="n">printf</span><span class="p">(</span><span class="s">"Thermal Zone Temperature: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">vtProp</span><span class="p">.</span><span class="n">intVal</span><span class="p">);</span>
   <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">VariantClear</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vtProp</span><span class="p">);</span>
  <span class="n">pclsObj</span><span class="o">-&gt;</span><span class="n">Release</span><span class="p">();</span>
 <span class="p">}</span>

 <span class="n">pEnumerator</span><span class="o">-&gt;</span><span class="n">Release</span><span class="p">();</span>
 <span class="n">pSvc</span><span class="o">-&gt;</span><span class="n">Release</span><span class="p">();</span>
 <span class="n">pLoc</span><span class="o">-&gt;</span><span class="n">Release</span><span class="p">();</span>
 
 <span class="n">CoUninitialize</span><span class="p">();</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</code></pre></div></div> <h3 id="preventing-temperature-checking">Preventing Temperature Checking</h3> <p>While we could patch a function with <code class="language-plaintext highlighter-rouge">nop</code> to prevent it from being called, instead we will manipulate memory directly and change the execution flow with <em>EIP</em> (RIP in x64).</p> <p>Firstly, we will jump straight to the <em>EntryPoint</em> of the program.</p> <figure> <picture> <img src="/assets/img/images/thm_anti-reverse_engineering/Hk5-W8l0A.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="vm-detection EntryPoint" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>Secondly, we need to go to <code class="language-plaintext highlighter-rouge">uReturn</code>, which is the variable that indicates if the query has returned a class or not (the <code class="language-plaintext highlighter-rouge">Not Supported</code>). For that, we can try to go near it by searching for strings and go to the address location with the <em>SELECT * FROM MSAcpi_ThermalZoneTemperature</em> string.</p> <figure> <picture> <img src="/assets/img/images/thm_anti-reverse_engineering/HJSm4UxCC.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="vm-detection string search" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>When we got there, we can observe a part which corresponds to <code class="language-plaintext highlighter-rouge">pEnumerator-&gt;Next(WBEM_INFINITE, 1, &amp;pclsObj, &amp;uReturn);</code>.</p> <figure> <picture> <img src="/assets/img/images/thm_anti-reverse_engineering/HJCGILeAR.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="vm-detection pEnumerator function" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>As we press <code class="language-plaintext highlighter-rouge">F8</code> (Step Over), we eventually get at the address <code class="language-plaintext highlighter-rouge">004010FD</code>, which is where the comparison <code class="language-plaintext highlighter-rouge">uReturn == 0</code> is made:</p> <figure> <picture> <img src="/assets/img/images/thm_anti-reverse_engineering/rJSYvLxCR.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="vm-detection compare" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>Since <code class="language-plaintext highlighter-rouge">uReturn</code> has the address <code class="language-plaintext highlighter-rouge">ebp-18</code> and because we want to modify that value to bypass that jump, we will follow it on dump by <em>Right clicking on the opcode cmp -&gt; Follow in Dump -&gt; Address: EBP-18</em>.</p> <figure> <picture> <img src="/assets/img/images/thm_anti-reverse_engineering/SJ0mKUgA0.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="uReturn dump follow" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>On the bottom of the screen at <em>Dump 1</em>, we can see our current value <code class="language-plaintext highlighter-rouge">uReturn</code> (it is a 32-bit integer):</p> <figure> <picture> <img src="/assets/img/images/thm_anti-reverse_engineering/rJAdYLxAA.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="uReturn Dump window" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>Right-clicking on the least-significant <code class="language-plaintext highlighter-rouge">00</code> value (the one at the rightmost, because of the endianness) will open a <em>Modify Value</em> window. We enter the value <code class="language-plaintext highlighter-rouge">01</code>.</p> <figure> <picture> <img src="/assets/img/images/thm_anti-reverse_engineering/SyHY5Ue0C.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="uReturn dump value modified" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>After pressing <code class="language-plaintext highlighter-rouge">F8</code> a few times, we should notice that the code will not exit anymore as it skips the execution from <code class="language-plaintext highlighter-rouge">00401101</code> to <code class="language-plaintext highlighter-rouge">0040110A</code>. This is because we have manipulated the memory.</p> <figure> <picture> <img src="/assets/img/images/thm_anti-reverse_engineering/B1SwsLxAA.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="return skipped" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>However, the program will crash if we continue the execution as the <code class="language-plaintext highlighter-rouge">pclsObj</code> pointer is not pointing to any valid object. This is throwing the <em>EXCEPTION_ACCESS_VIOLATION</em> exception as the program wants to execute <code class="language-plaintext highlighter-rouge">pclsObj-&gt;Get(L"CurrentTemperature", 0, &amp;vtProp, 0, 0);</code> and want to access to an unauthorized memory allocation, a memory location which hasn’t been allocated for the program.</p> <figure> <picture> <img src="/assets/img/images/thm_anti-reverse_engineering/Byi_3Ul0R.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="vm-detection exception" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>Afterward, we need to continue to investigate with other methods that would allow us to jump around and continue.</p> <p>Here, we have two other ways to make this happen:</p> <ul> <li>Changing the <code class="language-plaintext highlighter-rouge">EIP</code> register’s value</li> <li>Modifying the <code class="language-plaintext highlighter-rouge">jmp</code> to go to where the malicious activities are “being done” or where 1 is returned</li> </ul> <p>For the first one, the great thing with debuggers is that we can change every value related to the program, the ones in the memory, in the stack, in the registers… Because <code class="language-plaintext highlighter-rouge">EIP</code> is the register that holds the memory address that tells what instruction next to execute, we can modify it to hold the memory address where the return is being made.</p> <p>To skip everything and jump to the part where it returns, we need to modify the <code class="language-plaintext highlighter-rouge">EIP</code> value to <code class="language-plaintext highlighter-rouge">0x00401134</code> after running the program to the address <code class="language-plaintext highlighter-rouge">0x00401101</code> (where the <em>uReturn</em> check is).</p> <figure> <picture> <img src="/assets/img/images/thm_anti-reverse_engineering/Hya_wPgAC.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="vm-detection thermal print" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>To modify it, it is simple as <em>Right clicking on EIP on the right panel -&gt; Modify value</em>:</p> <figure> <picture> <img src="/assets/img/images/thm_anti-reverse_engineering/S13UYPlAC.png" class="img-fluid rounded z-depth-1" width="70" height="auto" title="Modify EIP Value" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>This let us to have our EIP location changed to the new address:</p> <figure> <picture> <img src="/assets/img/images/thm_anti-reverse_engineering/SJZiKPeAR.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="EIP address changed" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>To finish, this is what we get after running with <code class="language-plaintext highlighter-rouge">F9</code> (Run):</p> <figure> <picture> <img src="/assets/img/images/thm_anti-reverse_engineering/rJkddvxA0.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="vm-detection EIP bypass" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>For the second one, we can to go after the checks where the <em>MessageBox</em> of the second type is done. To proceed with that, we might do a string search and go where the string <em>“Proceeding with malicious activities…”</em> is.</p> <figure> <picture> <img src="/assets/img/images/thm_anti-reverse_engineering/rJqBSvlCA.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="vm-detection MessageBox part" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>Then, we just need to modify the jump type and address to always jump to where the rogue part of the application is. To do that, we might use <code class="language-plaintext highlighter-rouge">Space</code> or <em>Right click -&gt; Assemble</em> to change the operation from <code class="language-plaintext highlighter-rouge">jne</code> to <code class="language-plaintext highlighter-rouge">jmp 0x004011C4</code>.</p> <figure> <picture> <img src="/assets/img/images/thm_anti-reverse_engineering/H1NJHwl0R.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="vm-detection assembly instruction change" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <figure> <picture> <img src="/assets/img/images/thm_anti-reverse_engineering/ryfEIwlR0.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="vm-detection detection bypassed with jmp" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>Finally, if we wanted to make this change permanent, we would have to patch as always using <code class="language-plaintext highlighter-rouge">Ctrl+G</code>.</p> <h3 id="questions-3">Questions</h3> <p><strong>In the C code snippet, what is the full WQL query used to get the temperature from the <code class="language-plaintext highlighter-rouge">Win32_TemperatureProbe</code> class?</strong></p> <p><em>Answer: <code class="language-plaintext highlighter-rouge">SELECT * FROM MSAcpi_ThermalZoneTemperature</code></em></p> <p><strong>What register holds the memory address that tells the debugger what instruction to execute next?</strong></p> <p><em>Answer: <code class="language-plaintext highlighter-rouge">EIP</code></em></p> <p><strong>Before uReturn is compared to zero, what is the memory location pointed to by [ebp-4]</strong></p> <p>Before <em>uReturn</em> is compared to 0, we toggle a breakpoint <em>(004010FA)</em> to see what is the value of <code class="language-plaintext highlighter-rouge">EBP</code> <em>(0019FF20)</em>. Hence, we can substract this value by 4 (remember, it is in hex) or <em>Ricght click on the operation -&gt; Follow in Dump -&gt; Address: EBP-4</em>, then copy the highlighted memory address.</p> <figure> <picture> <img src="/assets/img/images/thm_anti-reverse_engineering/ByU-nczAR.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="EBP location" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p><em>Answer: <code class="language-plaintext highlighter-rouge">0019FF1C</code></em></p> <h2 id="task-6---packers-overwiew">Task 6 - Packers (Overwiew)</h2> <p>Obfuscation is a technique that aims to intentionnaly obscure data and code to make it harder to understand or analyze.</p> <p>The most common obfuscation techniques used by malware authors are:</p> <ul> <li> <strong>Encoding techniques</strong>: This involves encoding data like command line strings, domain names, IP addresses, etc… using encoding techniques such as <code class="language-plaintext highlighter-rouge">XOR</code> or <code class="language-plaintext highlighter-rouge">Base64</code>.</li> <li> <strong>Encryption techniques</strong>: This involves encrypting data such as communications to a C2 server, files and network traffic using symmetric or asymmetric encryption.</li> <li> <strong>Code obfuscation</strong>: This involves various techniques such as manipulating the code to alter its syntax and structure, renaming functions or splitting code across multiple files or code segments.</li> </ul> <h3 id="packers">Packers</h3> <p>Packers are tools that compress and encrypt executable files to embed them within a new executable file that serves as a wrapper or container. By dramatically reducing the file size, packers make it ideal for easy distribution and installation. Some of them include additionnal features such as code obfuscation, runtime packing and anti-debugging techniques. It is because of these features that packers are a tool of choice for malware authors.</p> <p>There are a lot of packers available in the wild and each has a unique approach of packing. Here is a list of some popular:</p> <ul> <li><a href="https://www.alternate-tools.com/pages/c_exepacker.php?lang=ENG" rel="external nofollow noopener" target="_blank">Alternate EXE Packer</a></li> <li><a href="http://www.aspack.com/" rel="external nofollow noopener" target="_blank">ASPack</a></li> <li><a href="https://unprotect.it/technique/exestealth/" rel="external nofollow noopener" target="_blank">ExeStealth</a></li> <li><a href="https://github.com/akuafif/hXOR-Packer" rel="external nofollow noopener" target="_blank">hXOR-Packer</a></li> <li><a href="https://github.com/nelfo/Milfuscator" rel="external nofollow noopener" target="_blank">Milfuscator</a></li> <li><a href="https://www.autohotkey.com/mpress/mpress_web.htm" rel="external nofollow noopener" target="_blank">MPress</a></li> <li><a href="https://www.pelock.com/products/pelock" rel="external nofollow noopener" target="_blank">PELock</a></li> <li><a href="https://www.oreans.com/Themida.php" rel="external nofollow noopener" target="_blank">Themida</a></li> <li><a href="https://upx.github.io/" rel="external nofollow noopener" target="_blank">UPX</a></li> <li><a href="https://vmpsoft.com/" rel="external nofollow noopener" target="_blank">VMProtect</a></li> </ul> <p>It is essential to state that all packed programs are not malicious. packers can also be used for legitimate purposes such as protecting intellectual properties from theft. For example, Themida is known to be used in some video games.</p> <p>Because packers encrypts and obfuscates a program, it would be impossible to know the malware’s capabilities without running it. This makes static analysis and signature-based detection unreliable. One of the information we could obtain form a packed sample is the packer tool used. Even though this announces to be tough, it can be a good starting point for an investigation.</p> <h3 id="questions-4">Questions</h3> <p><strong>What is the decoded string of the base64 encoded string <em>“VGhpcyBpcyBhIEJBU0U2NCBlbmNvZGVkIHN0cmluZy4=”</em>?</strong></p> <p><em>Answer: <code class="language-plaintext highlighter-rouge">This is a BASE64 encoded string.</code></em></p> <h2 id="task-7---identifying-and-unpacking">Task 7 - Identifying and Unpacking</h2> <p>The first stepdealing with packed malware is identifying the packer used. Using tools like <em>Detect It Easy</em> (DIE) and <em>PEStudio</em>, we can have a great starting point.</p> <p>With DIE, we will try to identify the packer used for <code class="language-plaintext highlighter-rouge">packed.exe</code>, in order to try to unpack it.</p> <p>Firstly, we start by opening it in DIE:</p> <figure> <picture> <img src="/assets/img/images/thm_anti-reverse_engineering/HJ4FcsfRA.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="packed.exe opened in DIE" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>Detect It Easy displays its best guess if it can identify the packer. Here, it identifies the program as packed with UPX.</p> <p>Also, we can check for the entropy with the <em>Entropy</em> button on the right panel. Because entropy is the measure of the randomness and a packer misplaces code blocks in a controlled way, we can identify if a binary is packed or not. The <em>Entropy</em> window determines how much entropy each section (normally .text, .data, .rsrc…) has. In this PE, the sections names are changed because of packing and they are renamed <em>UPX1</em> and <em>UPX2</em>. The second is not packed because it contains the code to unpack the first one, which is packed.</p> <figure> <picture> <img src="/assets/img/images/thm_anti-reverse_engineering/SkazToG00.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="packed.exe entropy in DIE" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>Another tool is PEStudio, which lists information on PE files. With it, we can also check for sections in <em>sections (self-modifying)</em> and get more information than with DIE.</p> <figure> <picture> <img src="/assets/img/images/thm_anti-reverse_engineering/rJoTAjfRC.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="packed.exe sections in pestudio" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>Like we have seen before, we also see that the section names was modified. Although this is the most identifiable piece of information tht packers can leave, not every one change these values.</p> <h3 id="automated-unpacking">Automated Unpacking</h3> <p>Once the packer is identified, it is possible to use an unpacker to get back to the original file. Some are readily available, like in the case of UPX. However, for other commercial tools like Themida, we may have to rely on 3rd party tools.</p> <p>Here are some scripts to try unpacking packed binaries with specific tools:</p> <ul> <li><a href="https://github.com/Hendi48/Magicmida" rel="external nofollow noopener" target="_blank">Themida</a></li> <li><a href="https://github.com/ThomasThelen/OllyDbg-Scripts/blob/master/Enigma/Enigma%20Protector%201.90%20-%203.xx%20Alternativ%20Unpacker%20v1.0.txt" rel="external nofollow noopener" target="_blank">Enigma Protector</a></li> <li><a href="https://github.com/avast/retdec/blob/master/src/unpackertool/plugins/mpress/mpress.cpp" rel="external nofollow noopener" target="_blank">Mpress unpacker</a></li> </ul> <p>With a malware packed with a more obscure packer, it might be tougher. Even though, trying to upload it to <a href="https://www.unpac.me/" rel="external nofollow noopener" target="_blank">unpac.me</a> might result with an unpakced executable.</p> <h3 id="manual-unpacking-and-dumping">Manual Unpacking and Dumping</h3> <p>Ultimately, the best way to unravel malware is by executing it.</p> <p>When executed, the container code performs decryption and deobfuscation. Once fully unpacked, the malware can proceed with its own code and we can thoroughly analyze it while it is in memory with a debugger.</p> <p>On the provided VM, we will analyze <code class="language-plaintext highlighter-rouge">packed.exe</code>.</p> <p>Firstly, we will open the program with <em>F3</em> and we will run it once with <em>F9</em>. We should arrive at a default breakpoint, the <em>EntryPoint</em> one. Obviously, this is the entry point for the unpack code and not the real one.</p> <figure> <picture> <img src="/assets/img/images/thm_anti-reverse_engineering/r1vWNoYCA.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="packed.exe first EntryPoint" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>Following the process, we could continue to press <em>F8</em> (Step Over) to see what is going one. However, if we watch a bit further on the code disassembly, we can see a interesting part which could correspond at the end of the unpacking program. This is because after this, we jump at an address where a normal program content is located and there are a few instructions repeating. We press <em>F2</em> to put a breakpoint on the <code class="language-plaintext highlighter-rouge">jmp</code> opcode at the address <code class="language-plaintext highlighter-rouge">004172D4</code> and press <em>F9</em> to go there.</p> <figure> <picture> <img src="/assets/img/images/thm_anti-reverse_engineering/B1evPoKRA.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="packed.exe before the program" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>For relevance, when UPX-malware is being unpacked, <code class="language-plaintext highlighter-rouge">004172D4</code> address location tells to UPX that malware have been successfully unpacked and the legitimate part of the program resides at <code class="language-plaintext highlighter-rouge">00401262</code>.</p> <blockquote> <p><strong>Note:</strong> This unpacking approach and memory locations differs from a packer to another.</p> </blockquote> <p>With the <em>Scylla</em> plugin, we can dump the unpacked legitimate part of the program to memory and fix it so it will have the updated memory locations from its DLL imports. Scylla is a tool that can dump process memory to disk and fix and rebuild the <a href="https://securitymaven.medium.com/anatomy-of-iat-and-eat-hooking-9612eb15baf1" rel="external nofollow noopener" target="_blank">Import Address Table</a> (IAT).</p> <p>To open it, we go to <em>Plugins -&gt; Scylla</em> on the top menu bar. Please note that he <em>OEP</em> (Original Entry Point) is the address of where the legitimate part of the program starts. Once the window is opened, we click on <em>Dump</em> and save the file somewhere.</p> <figure> <picture> <img src="/assets/img/images/thm_anti-reverse_engineering/B1u8N13R0.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="Scylla plugin" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>Once this is done, we click on <em>IAT Autosearch</em> to search the original IAT loaded in the program’s memory. A pop-up asks to use Advanced IAT Search or no. Hence we click on <em>no</em> and <em>OK</em> to use the standard method.</p> <figure> <picture> <img src="/assets/img/images/thm_anti-reverse_engineering/rJDT8ynCR.png" class="img-fluid rounded z-depth-1" width="60%" height="auto" title="Advanced IAT Search pop-up" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>At this point, we can now click on <em>Get Imports</em> button to update the <em>Import</em> list section. This list shows us all DLLs used by the program. Sometimes, invalid entries marked with an “X” are found by Scylla. These are safe to delete because the list already covers all the DLLs. To delete these, we <em>Right click -&gt; Cut thunk</em> on each invalid row.</p> <p>When we are left only with valid values, we click on <em>Fix Dump</em> and select the previously generated file. With the string <em>“_SCY”</em> appended to the name, the program now work correctly.</p> <figure> <picture> <img src="/assets/img/images/thm_anti-reverse_engineering/rk2f9Wh0A.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="Scylla completed" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <figure> <picture> <img src="/assets/img/images/thm_anti-reverse_engineering/BJ1qcZ3CA.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="Opened unpacked program" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>We can confirm the successful unpacking with DIE or PEStudio, which does not detect our binary as <em>Packed</em> anymore:</p> <figure> <picture> <img src="/assets/img/images/thm_anti-reverse_engineering/H1sxoW2A0.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="Unpacked program's entropy" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <h3 id="questions-5">Questions</h3> <p>For these questions, we just need to open <code class="language-plaintext highlighter-rouge">packed.exe</code> in DIE or PEStudio.</p> <p><strong>According to DetectItEasy, what is the version of the Microsoft Linker used for linking packed.exe?</strong></p> <p><em>Answer: <code class="language-plaintext highlighter-rouge">14.16</code></em></p> <p><strong>According to pestudio, what is the entropy of the UPX2 section of packed.exe?</strong></p> <p><em>Answer: <code class="language-plaintext highlighter-rouge">2.006</code></em></p> <h2 id="task-8---conclusion">Task 8 - Conclusion</h2> <p>In this room, we explored the various anti-reverse engineering techniques that malware authors employ to complicate the analysis of their malicious software. We discussed the motivations behind these techniques, such as preventing debugging through methods like checking for debuggers, VM detection, tampering with debug registers, and using self-modifying code. We also examined practical applications, such as the use of the Windows API function <code class="language-plaintext highlighter-rouge">SuspendThread</code> to pause execution and hinder debugging efforts. Additionally, we learned how to circumvent these protections through patching and manipulation techniques, which included directly altering memory values and using the EIP register to control execution flow.<br> While this session provided valuable insights into the realm of anti-reverse engineering, it’s important to recognize that the field is vast and continually evolving and this room helped us to delve into the surface of it.</p> </div> </article> <br> <hr> <br> <ul class="list-disc pl-8"></ul> <h2 class="text-3xl font-semibold mb-4 mt-12">Enjoy Reading This Article?</h2> <p class="mb-2">Here are some more articles you might like to read next:</p> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/THM-Advanced-Static-Analysis/">THM Advanced Static Analysis</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/THM-Dynamic-Analysis-Debugging/">THM Dynamic Analysis: Debugging</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/THM-Basic-Dynamic-Analysis/">THM Basic Dynamic Analysis</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/THM-MalDoc-Static-Analysis/">THM MalDoc: Static Analysis</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/THM-Windows-Forensics-1/">THM Windows Forensics 1</a> </li> </div> </div> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2025 NonoHM . Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script defer src="/assets/js/bootstrap-toc.min.js?c82ff4de8b0955d6ff14f5b05eed7eb6"></script> <script src="/assets/js/no_defer.js?2930004b8d7fcd0a8e00fdcfc8fc9f24"></script> <script defer src="/assets/js/common.js?da39b660470d1ba6e6b8bf5f37070b6e"></script> <script defer src="/assets/js/copy_code.js?12775fdf7f95e901d7119054556e495f" type="text/javascript"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>